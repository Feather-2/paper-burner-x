<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å†å²è¯¦æƒ…</title>
  <link rel="icon" type="image/svg+xml" href="../../public/pure.svg">
<!-- CDN æ€§èƒ½ä¼˜åŒ–ï¼šDNS é¢„è¿æ¥ - æå‰å»ºç«‹è¿æ¥ï¼ŒèŠ‚çœ 100-300ms -->  <link rel="dns-prefetch" href="https://gcore.jsdelivr.net">  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <!-- KaTeX å…¬å¼æ¸²æŸ“æ ·å¼ -->
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<!-- KaTeX å­—ä½“é¢„åŠ è½½ - ä¼˜åŒ–æ…¢ç½‘ç»œç¯å¢ƒä¸‹çš„åŠ è½½æ€§èƒ½ -->  <link rel="preload" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin>  <link rel="preload" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin>  <link rel="preload" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin>  <link rel="preload" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin>  <link rel="preload" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/fonts/KaTeX_AMS-Regular.woff2" as="font" type="font/woff2" crossorigin>  <link rel="preload" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin>  <link rel="preload" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin>
  <link type="text/css" rel="stylesheet" href="https://gcore.jsdelivr.net/npm/jsmind/style/jsmind.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Main CSS Entry Point (100% Modular Architecture) -->
  <link rel="stylesheet" href="../../css/history_detail.css">

  <!-- All CSS now imported via history_detail.css (Phase 9 å®Œæˆ) -->

</head>
<body>
  <!-- Immersive Mode Toggle Button -->
  <button id="toggle-immersive-btn" class="tiny-round-btn">
    <i class="fas fa-expand-alt"></i> <!-- Default icon for entering immersive mode -->
  </button>

  <!-- Immersive Layout Container -->
  <div id="immersive-layout-container" style="display: none; /* Initially hidden */
                                              width: 100vw;
                                              height: 100vh;
                                              position: fixed;
                                              top: 0;
                                              left: 0;
                                              z-index: 1999; /* Below toggle button, above most other things */
                                              background-color: var(--body-bg-color, #fff); /* Match body background */
                                              flex-direction: column;">
    <!-- Removed immersive-layout-header -->

    <div id="immersive-content-area" style="display: flex; flex: 1; overflow: hidden;">
      <!-- TOC Area -->
      <div id="immersive-toc-area" class="immersive-panel" style="width: 15%;">
        <!-- TOC will be rendered or moved here -->
      </div>

      <!-- Resizable Handle 1 -->
      <div class="immersive-resize-handle" data-target-prev="immersive-toc-area" data-target-next="immersive-main-content-area"></div>

      <!-- Main Content Area (where original .container's content will go) -->
      <div id="immersive-main-content-area" class="immersive-panel" style="flex: 1;">
        <!-- Original .container content (tabs, tab content etc.) will be programmatically moved here -->
      </div>

      <!-- Resizable Handle 2 -->
      <div class="immersive-resize-handle" data-target-prev="immersive-main-content-area" data-target-next="immersive-chatbot-area"></div>

      <!-- Chatbot Area -->
      <div id="immersive-chatbot-area" class="immersive-panel" style="width: 20%;">
        <!-- Chatbot will be rendered or moved here -->
      </div>
    </div>
    <!-- Removed Placeholder for Dock in immersive mode -->
  </div>

  <!-- ========== App Shell åŒ…è£…å™¨ï¼ˆéæ²‰æµ¸æ¨¡å¼ï¼‰ ========== -->
  <div class="app-shell" id="app-shell">
    <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- ========== ç»Ÿä¸€ä¾§è¾¹æ  ========== -->
    <aside class="app-sidebar" id="appSidebar">
      <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
      <div class="sidebar-header">
        <img src="../../public/h_with_name.svg" alt="Paper Burner X" class="sidebar-logo" id="sidebarLogo">
        <!-- æ¡Œé¢ç«¯æ”¶èµ·æŒ‰é’® -->
        <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="åˆ‡æ¢ä¾§è¾¹æ ">
          <i class="fas fa-bars"></i>
        </button>
        <!-- ç§»åŠ¨ç«¯å…³é—­æŒ‰é’® -->
        <button class="sidebar-close-btn" id="sidebarCloseBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- ä¾§è¾¹æ å¯¼èˆª -->
      <nav class="sidebar-nav">
        <!-- ä¸»è¦åŠŸèƒ½åŒº -->
        <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>

        <!-- å›åˆ°å·¥ä½œå° -->
        <a href="../../index.html" class="nav-item">
          <i class="fas fa-home nav-icon"></i>
          <span class="nav-text">å›åˆ°å·¥ä½œå°</span>
        </a>

        <!-- åˆ†éš”çº¿ -->
        <div class="sidebar-divider"></div>

        <!-- æ–‡æ¡£ç»“æ„åŒº -->
        <div class="nav-section-title">æ–‡æ¡£ç»“æ„</div>

        <!-- TOC ç›®å½•ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div class="sidebar-section expanded" id="sidebarTocSection">
          <button class="sidebar-section-header" id="sidebarTocToggle">
            <span class="sidebar-section-title">
              <i class="fas fa-list"></i>
              <span>ç›®å½•</span>
            </span>
            <i class="fas fa-chevron-right sidebar-section-chevron"></i>
          </button>
          <div class="sidebar-section-content">
            <ul class="sidebar-toc-list" id="sidebarTocList">
              <!-- TOC é¡¹ç›®å°†ç”± JavaScript å¡«å…… -->
              <li class="sidebar-empty-state">
                <div class="sidebar-empty-icon">ğŸ“„</div>
                <div>åŠ è½½ä¸­...</div>
              </li>
            </ul>
          </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯åŒº -->
        <div class="nav-section-title">ç»Ÿè®¡ä¿¡æ¯</div>

        <!-- Dock ç»Ÿè®¡ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div class="sidebar-section expanded" id="sidebarDockSection">
          <button class="sidebar-section-header" id="sidebarDockToggle">
            <span class="sidebar-section-title">
              <i class="fas fa-chart-bar"></i>
              <span>é˜…è¯»ç»Ÿè®¡</span>
            </span>
            <i class="fas fa-chevron-right sidebar-section-chevron"></i>
          </button>
          <div class="sidebar-section-content">
            <div class="sidebar-stat-list">
              <div class="sidebar-stat-item">
                <span class="sidebar-stat-label">é˜…è¯»è¿›åº¦</span>
                <span class="sidebar-stat-value" id="sidebarReadingProgress">0%</span>
              </div>
              <div class="sidebar-stat-item">
                <span class="sidebar-stat-label">é«˜äº®</span>
                <span class="sidebar-stat-value stat-item-clickable" data-stat-type="highlight" id="sidebarHighlightCount">0</span>
              </div>
              <div class="sidebar-stat-item">
                <span class="sidebar-stat-label">æ‰¹æ³¨</span>
                <span class="sidebar-stat-value stat-item-clickable" data-stat-type="annotation" id="sidebarAnnotationCount">0</span>
              </div>
              <div class="sidebar-stat-item">
                <span class="sidebar-stat-label">å›¾ç‰‡</span>
                <span class="sidebar-stat-value" id="sidebarImageCount">0</span>
              </div>
              <div class="sidebar-stat-item">
                <span class="sidebar-stat-label">å…¬å¼</span>
                <span class="sidebar-stat-value" id="sidebarFormulaCount">0</span>
              </div>
              <div class="sidebar-stat-item">
                <span class="sidebar-stat-label">è¡¨æ ¼</span>
                <span class="sidebar-stat-value" id="sidebarTableCount">0</span>
              </div>
              <div class="sidebar-stat-item">
                <span class="sidebar-stat-label">æ€»å­—æ•°</span>
                <span class="sidebar-stat-value" id="sidebarWordCount">0</span>
              </div>
              <div class="sidebar-stat-item">
                <span class="sidebar-stat-label">æ–‡çŒ®</span>
                <span class="sidebar-stat-value stat-item-clickable" data-stat-type="reference" id="sidebarReferenceCount">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- åˆ†éš”çº¿ -->
        <div class="sidebar-divider"></div>

        <!-- ç³»ç»ŸåŒº -->
        <div class="nav-section-title">ç³»ç»Ÿ</div>

        <!-- è®¾ç½® -->
        <a href="#" class="nav-item" id="sidebarSettingsLink">
          <i class="fas fa-cog nav-icon"></i>
          <span class="nav-text">è®¾ç½®</span>
        </a>
      </nav>

      <!-- ä¾§è¾¹æ åº•éƒ¨ -->
      <div class="sidebar-footer">
        <a href="https://github.com/Feather-2/paper-burner" target="_blank" class="sidebar-footer-link">
          <i class="fab fa-github sidebar-footer-icon"></i>
          <span>GitHub</span>
        </a>
      </div>
    </aside>

    <!-- ========== ä¸»å†…å®¹åŒº ========== -->
    <main class="app-main">
      <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨æ  -->
      <div class="mobile-header">
        <div class="mobile-header-title">
          <img src="../../public/pure.svg" alt="PBX" class="mobile-header-logo">
          <span>æ–‡æ¡£è¯¦æƒ…</span>
        </div>
        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <!-- æ—§çš„ TOC å’Œ Dockï¼ˆéšè—ä½†ä¿ç•™ä»¥ä¾¿å‘åå…¼å®¹ï¼‰ -->
      <div style="display: none;" id="legacy-toc-dock-wrapper">
  <!-- ===================== -->
  <!-- æµ®åŠ¨TOCç›®å½•æŒ‰é’®åŠæ‚¬æµ®çª— -->
  <!-- ===================== -->
  <div id="toc-float-btn" class="tiny-round-btn"><i class="fa fa-list"></i></div>
  <div id="toc-popup" class="toc-popup-hidden">
    <div id="toc-popup-header">
      <span><i class="fa fa-list"></i>ç›®å½• / TOC</span>
      <button id="toc-popup-close-btn">å…³é—­</button>
    </div>
    <ul id="toc-list"></ul>
  </div>

  <!-- NEW DOCK STRUCTURE -->
  <div id="bottom-left-dock">
    <div id="dock-info-stack">
      <div class="dock-column dock-labels-column">
        <div class="dock-stat-item-wrapper-progress">é˜…è¯»è¿›åº¦:</div>
        <div class="dock-stat-item-wrapper-highlight"><span class="stat-item-clickable" data-stat-type="highlight">é«˜äº®: <span id="highlight-count">0</span></span></div>
        <div class="dock-stat-item-wrapper-img">å›¾ç‰‡: <span id="image-count">0</span></div>
        <div class="dock-stat-item-wrapper-formula">å…¬å¼: <span id="formula-count">0</span></div>
      </div>
      <div class="dock-column dock-values-column">
        <div class="dock-stat-item-wrapper-progress"><span id="reading-progress-percentage-verbose">0</span>%</div>
        <div class="dock-stat-item-wrapper-annotation"><span class="stat-item-clickable" data-stat-type="annotation">æ‰¹æ³¨: <span id="annotation-count">0</span></span></div>
        <div class="dock-stat-item-wrapper-tbl">è¡¨æ ¼: <span id="table-count">0</span></div>
        <div class="dock-stat-item-wrapper-words">æ€»å­—æ•°: <span id="total-word-count">0</span></div>
      </div>
    </div>
    <!-- åº•éƒ¨æ§åˆ¶æ ï¼šæ–‡çŒ® + è®¾ç½® + æŠ˜å  -->
    <div class="dock-control-bar">
      <span id="dock-collapsed-progress-display"><span id="reading-progress-percentage">0</span>%</span>
      <span class="stat-item-clickable" data-stat-type="reference">
        <i class="fa fa-book"></i> <span id="reference-count">0</span>
      </span>
      <a href="#" id="settings-link" title="è®¾ç½®"><i class="fa fa-cog"></i></a>
      <a href="#" id="dock-toggle-btn" title="æŠ˜å "><i class="fa fa-chevron-down"></i></a>
    </div>
  </div>
      </div> <!-- End legacy-toc-dock-wrapper -->

  <!-- ===================== -->
  <!-- ä¸»å†…å®¹å®¹å™¨ -->
  <!-- ===================== -->
  <div class="container">
    <h2 id="fileName">å†å²è¯¦æƒ…</h2>
    <div class="meta" id="fileMeta">
      <div class="meta-info">
        <span id="fileMetaTime"></span>
        <span class="meta-separator">|</span>
        <span id="fileMetaImages"></span>
      </div>
      <button class="meta-export-trigger" id="exportTrigger" type="button" aria-haspopup="true" aria-expanded="false">
        <i class="fa fa-download"></i>
        <span>å¯¼å‡º</span>
      </button>
    </div>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="tabs-container">
      <button class="tab-btn" id="tab-ocr">ä»…OCR</button>
      <button class="tab-btn" id="tab-translation">ä»…ç¿»è¯‘</button>
      <!-- <button class="tab-btn" id="tab-compare">å¯¹æ¯”</button> -->
      <button class="tab-btn" id="tab-chunk-compare">åˆ†å—å¯¹æ¯”</button>
      <button class="tab-btn" id="tab-pdf-compare" style="display: none;">PDFå¯¹ç…§</button>
    </div>
    <div class="history-export-controls" id="history-export-controls">
      <div class="export-panel-backdrop" id="exportPanelBackdrop"></div>
      <div class="export-panel" id="exportPanel">
        <div class="export-panel-header">
          <div class="export-panel-title"><i class="fa fa-share-square-o"></i>å¯¼å‡ºå½“å‰è§†å›¾</div>
          <button type="button" class="export-panel-close" id="exportPanelClose" aria-label="å…³é—­å¯¼å‡ºé¢æ¿"><i class="fa fa-times"></i></button>
        </div>
        <div class="export-panel-body">
          <div class="export-format-list">
            <button type="button" class="export-menu-btn" data-format="html"><i class="fa fa-code"></i>HTML</button>
            <button type="button" class="export-menu-btn" data-format="pdf"><i class="fa fa-file-pdf-o"></i>PDF</button>
            <button type="button" class="export-menu-btn" data-format="docx"><i class="fa fa-file-word-o"></i>DOCX</button>
            <button type="button" class="export-menu-btn" data-format="markdown"><i class="fa fa-file-text-o"></i>Markdown</button>
            <button type="button" class="export-menu-btn" data-format="original"><i class="fa fa-file-o"></i>åŸæ ¼å¼</button>
          </div>
          <div class="export-config" id="exportConfig">
            <div class="export-config-content" id="exportConfigContent">
              <div class="export-config-placeholder">è¯·é€‰æ‹©å¯¼å‡ºæ ¼å¼ä»¥æŸ¥çœ‹è®¾ç½®</div>
            </div>
            <button type="button" class="export-confirm-btn" id="exportConfirmBtn" disabled>å¯¼å‡º</button>
          </div>
        </div>
      </div>
    </div>
    <!-- æ ‡ç­¾é¡µå†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="tab-content" id="tabContent"></div>
  </div>

  <!-- ===================== -->
  <!-- è‡ªå®šä¹‰ä¸Šä¸‹æ–‡èœå• -->
  <!-- ===================== -->
  <div id="custom-context-menu" class="context-menu-hidden">
    <ul>
      <li data-action="highlight-block">
        é«˜äº®æ­¤åŒºå—
        <div class="color-palette">
          <span class="color-option color-yellow" data-color="yellow" title="é»„è‰²"></span>
          <span class="color-option color-pink" data-color="pink" title="ç²‰è‰²"></span>
          <span class="color-option color-lightblue" data-color="lightblue" title="æµ…è“è‰²"></span>
          <span class="color-option color-lightgreen" data-color="lightgreen" title="æµ…ç»¿è‰²"></span>
          <span class="color-option color-purple" data-color="purple" title="ç´«è‰²"></span>
          <span class="color-option color-orange" data-color="orange" title="æ©™è‰²"></span>
        </div>
      </li>
      <li data-action="remove-highlight" id="remove-highlight-option" style="display: none;">å–æ¶ˆé«˜äº®</li>
      <hr class="menu-divider" id="highlight-actions-divider" style="display: none;">
      <li data-action="add-note" id="add-note-option" style="display: none;">æ·»åŠ æ‰¹æ³¨</li>
      <li data-action="edit-note" id="edit-note-option" style="display: none;">ç¼–è¾‘æ‰¹æ³¨</li>
      <hr class="menu-divider" id="note-actions-divider" style="display: none;">
      <li data-action="copy-content" id="copy-content-option"><i class="fa fa-copy"></i>å¤åˆ¶å†…å®¹</li>
      <!-- æ›´å¤šæ“ä½œå¯ä»¥åç»­æ·»åŠ  -->
    </ul>
  </div>

  <!-- Dock Settings Modal -->
  <div id="dock-settings-modal" class="dock-settings-modal modal-overlay"> <!-- Default: not visible -->
    <div class="dock-settings-modal-content modal-content"> <!-- ADDED modal-content class -->
      <span class="dock-settings-modal-close-btn" id="dock-settings-close-btn">&times;</span>
      <h2>æ˜¾ç¤ºè®¾ç½®</h2>
      <div class="checkbox-container"> <!-- Container for checkboxes -->
        <div class="checkbox-group">
          <input type="checkbox" id="ds-readingProgress" data-config-key="readingProgress">
          <label for="ds-readingProgress">é˜…è¯»è¿›åº¦</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="ds-highlights" data-config-key="highlights">
          <label for="ds-highlights">é«˜äº®</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="ds-annotations" data-config-key="annotations">
          <label for="ds-annotations">æ‰¹æ³¨</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="ds-images" data-config-key="images">
          <label for="ds-images">å›¾ç‰‡</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="ds-tables" data-config-key="tables">
          <label for="ds-tables">è¡¨æ ¼</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="ds-formulas" data-config-key="formulas">
          <label for="ds-formulas">å…¬å¼</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="ds-words" data-config-key="words">
          <label for="ds-words">æ€»å­—æ•°</label>
        </div>
      </div>

      <!-- æ–°å¢TOCæ˜¾ç¤ºæ¨¡å¼è®¾ç½®éƒ¨åˆ† -->
      <h3>ç›®å½•(TOC)è®¾ç½®</h3>
      <div class="radio-container">
        <div class="radio-group">
          <input type="radio" id="toc-mode-both" name="toc-mode" value="both" checked>
          <label for="toc-mode-both">åŒè¯­ç›®å½•</label>
        </div>
        <div class="radio-group">
          <input type="radio" id="toc-mode-ocr" name="toc-mode" value="ocr">
          <label for="toc-mode-ocr">ä»…åŸæ–‡ç›®å½•</label>
        </div>
        <div class="radio-group">
          <input type="radio" id="toc-mode-translation" name="toc-mode" value="translation">
          <label for="toc-mode-translation">ä»…è¯‘æ–‡ç›®å½•</label>
        </div>
      </div>

      <div class="dock-settings-modal-buttons">
        <button id="dock-settings-save-btn" class="btn btn-primary">ä¿å­˜</button>
        <button id="dock-settings-cancel-btn" class="btn btn-secondary">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Annotations/Highlights Summary Modal -->
  <div id="annotations-summary-modal" class="modal-overlay"> <!-- Default: not visible via CSS -->
    <div class="modal-content">
      <span class="modal-close-btn" id="annotations-summary-close-btn">&times;</span>
      <h2 id="annotations-summary-title">æ‰¹æ³¨ä¸é«˜äº®è¯¦æƒ…</h2>
      <div class="annotations-summary-controls">
        <label for="annotations-filter-type">ç±»å‹:</label>
        <select id="annotations-filter-type">
          <option value="all">å…¨éƒ¨</option>
          <option value="highlighting">ä»…é«˜äº®</option>
          <option value="commenting">å¸¦æ‰¹æ³¨</option>
        </select>
        <label for="annotations-filter-content">å†…å®¹æ¥æº:</label>
        <select id="annotations-filter-content">
          <option value="all">å…¨éƒ¨ (OCR/ç¿»è¯‘)</option>
          <option value="ocr">ä»… OCR</option>
          <option value="translation">ä»…ç¿»è¯‘</option>
        </select>
        <div class="annotations-summary-color-filter" id="annotations-summary-color-filter">
          <!-- åŠ¨æ€æ’å…¥é¢œè‰²å¤šé€‰ -->
        </div>
      </div>
      <div class="table-container">
        <table id="annotations-summary-table">
          <thead>
            <tr>
              <th>ç±»å‹</th>
              <th>æ¥æº</th>
              <th>æ ‡è¯†ç¬¦</th>
              <th>æ–‡æœ¬ç‰‡æ®µ (é¢„è§ˆ)</th>
              <th>ç¬”è®°</th>
              <th>é¢œè‰²</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="annotations-summary-table-body">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

    </main> <!-- End app-main -->
  </div> <!-- End app-shell -->

  <!-- ===================== -->
  <!-- ä¾èµ–çš„JSåº“ -->
  <!-- ===================== -->
  <script src="https://gcore.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="../../js/lib/jszip.min.js"></script>
  <script src="../../js/storage/storage.js"></script>
  <!-- ç»“æ„åŒ–é‡è¯•éœ€è¦ API/Translation/Structured ç¿»è¯‘æ¨¡å— -->
  <script src="../../js/api/api.js"></script>
  <script src="../../js/process/translation.js"></script>
  <script src="../../js/process/mineru-structured-translation.js"></script>
  <script src="../../js/annotations/annotation_logic.js"></script>       <!-- Defines helpers like checkIfTextIsHighlighted -->
  <script src="../../js/annotations/custom_markdown_renderer.js"></script> <!-- Defines createCustomMarkdownRenderer -->
  <script src="../../js/annotations/annotation_highlighter.js"></script>   <!-- Defines applyPreprocessedAnnotations, uses helpers from annotation_logic.js -->
  <!-- ç§»é™¤å¤±æ•ˆçš„æ³¨é‡Šç›¸å…³è„šæœ¬å¼•ç”¨ -->
  <script src="../../js/ui/toc_logic_enhanced.js"></script>
  <script src="../../js/ui/toc_scroll_sync.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <!-- Markdown-it for AST-based processing (æ–°æ¶æ„) -->
  <script src="https://gcore.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- PDF.js for structured translation PDF comparison -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>

  <!-- Phase 3.5: æ€§èƒ½ä¼˜åŒ–é…ç½®ï¼ˆå¿…é¡»åœ¨æ‰€æœ‰ chatbot æ¨¡å—ä¹‹å‰åŠ è½½ï¼‰ -->
  <script src="../../js/chatbot/config/performance-config.js"></script>
  <!-- Phase 4.4.3: æœ¬åœ°æ€§èƒ½ç›‘æ§å·¥å…·ï¼ˆä»…å¼€å‘/æµ‹è¯•ç”¨ï¼Œä¸ä¸ŠæŠ¥æ•°æ®ï¼‰ -->
  <script src="../../js/chatbot/utils/performance-monitor.js"></script>
  <script src="../../js/chatbot/utils/mermaid-loader.js"></script>
  <!-- XSS é˜²æŠ¤ï¼šDOMPurify - ç”¨äºæ¸…ç† AI ç”Ÿæˆçš„ HTML å†…å®¹ -->
  <script src="https://gcore.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <!-- XSS é˜²æŠ¤ï¼šå®‰å…¨çš„ Markdown æ¸²æŸ“ï¼ˆå¿…é¡»åœ¨ markdown-katex-render.js ä¹‹å‰åŠ è½½ï¼‰ -->
  <script src="../../js/chatbot/utils/safe-markdown-render.js"></script>
  <!-- Phase 4.2+: KaTeX å…¬å¼ç¼“å­˜ç³»ç»Ÿï¼ˆè§£å†³å……æ»¡å…¬å¼åœºæ™¯ 4.6s é˜»å¡é—®é¢˜ï¼‰ -->
  <script src="../../js/chatbot/utils/katex-cache.js"></script>
  <script src="../../js/chatbot/utils/markdown-katex-render-cached.js"></script>
  <!-- Phase 4.2+: KaTeX æ¸è¿›å¼æ¸²æŸ“ç³»ç»Ÿï¼ˆè§£å†³é¦–æ¬¡æ¸²æŸ“ 4.6s é˜»å¡é—®é¢˜ï¼‰ -->
  <script src="../../js/chatbot/utils/katex-progressive-render.js"></script>
  <!-- Phase 4.2+: KaTeX ç¼“å­˜æŒä¹…åŒ–ï¼ˆlocalStorage è‡ªåŠ¨ä¿å­˜å’Œæ¢å¤ï¼‰ -->
  <script src="../../js/chatbot/utils/katex-cache-persistence.js"></script>
  <script src="../../js/chatbot/prompt/prompt-constructor.js"></script> <!-- Add this line -->
  <script src="../../js/chatbot/utils/chatbot-utils.js"></script>
  <script src="../../js/chatbot/prompt/chatbot-preset.js"></script>
  <script src="../../js/chatbot/utils/chatbot-image-utils.js"></script> <!-- Moved up to be with other utils -->
  <script src="../../js/chatbot/utils/chatbot-rendering-utils.js"></script> <!-- NEW -->
  <script src="../../js/chatbot/actions/chatbot-actions.js"></script> <!-- NEW -->
  <script src="../../js/chatbot/core/chat-message-event-manager.js"></script> <!-- Phase 3: äº‹ä»¶ç®¡ç†å™¨ï¼ˆäº‹ä»¶å§”æ‰˜ä¼˜åŒ–ï¼‰ -->
  <script src="../../js/chatbot/ui/chatbot-message-renderer.js"></script> <!-- NEW -->
  <!-- æ–°å¢ï¼šæ„ç¾¤èšåˆæ¨¡å— -->
  <script src="../../js/chatbot/agents/semantic-grouper.js"></script>
  <script src="../../js/chatbot/agents/semantic-tools.js"></script>
  <!-- æ–°å¢ï¼šå‘é‡æœç´¢æ¨¡å— -->
  <script src="../../js/boot/ensure-embedding.js"></script>
  <script src="../../js/chatbot/agents/embedding-client.js"></script>
  <script>
    (function(){
      try {
        if (!window.EmbeddingClient || typeof window.EmbeddingClient.saveConfig !== 'function') {
          var s = document.createElement('script');
          s.src = '../../js/chatbot/agents/embedding-client.js?v=' + Date.now();
          s.async = true;
          s.onload = function(){ console.log('[Boot] EmbeddingClient loaded via cache-bust (detail)'); };
          s.onerror = function(){ console.error('[Boot] Failed to load EmbeddingClient (detail)'); };
          document.head.appendChild(s);
        }
      } catch (e) { console.warn('[Boot] Embedding ensure failed (detail):', e.message); }
    })();
  </script>
  <!-- æ–°å¢ï¼šé‡æ’æ¨¡å—ï¼ˆç¡®ä¿åœ¨ semantic-vector-search ä¹‹å‰åŠ è½½ï¼‰ -->
  <script src="../../js/chatbot/agents/rerank-client.js"></script>
  <script src="../../js/chatbot/agents/vector-store.js"></script>
  <script src="../../js/chatbot/agents/semantic-vector-search.js"></script>
  <!-- æ–°å¢ï¼šBM25æ£€ç´¢æ¨¡å—ï¼ˆç‹¬ç«‹å·¥å…·ï¼‰ -->
  <script src="../../js/chatbot/agents/bm25-search.js"></script>
  <script src="../../js/chatbot/core/streaming-multi-hop.js"></script>
  <!-- Chatbot Core æ¨¡å—åŒ–ç»„ä»¶ï¼ˆå¿…é¡»åœ¨ chatbot-core.js ä¹‹å‰åŠ è½½ï¼‰ -->
  <script src="../../js/chatbot/core/api-config-builder.js"></script>
  <script src="../../js/chatbot/core/chat-history-manager.js"></script>
  <script src="../../js/chatbot/core/content-processor.js"></script>
  <script src="../../js/chatbot/core/semantic-groups-manager.js"></script>
  <script src="../../js/chatbot/core/message-sender.js"></script>
  <!-- Chatbot é…ç½®ç®¡ç†æ¨¡å—ï¼ˆç‹¬ç«‹äºç¿»è¯‘æ¨¡å‹ï¼‰ -->
  <script src="../../js/chatbot/core/chatbot-config-manager.js?v=20251107c"></script>
  <!-- Chatbot Core ä¸»å…¥å£ï¼ˆä¾èµ–ä¸Šè¿°æ‰€æœ‰æ¨¡å—ï¼‰ -->
  <script src="../../js/chatbot/core/chatbot-core.js"></script>
  <script src="../../js/chatbot/renderers/chatbot-mermaid-renderer.js"></script>
  <script src="../../js/chatbot/renderers/chatbot-mindmap-renderer.js"></script>
  <script src="../../js/chatbot/ui/chatbot-preset-questions-ui.js"></script>
  <script src="../../js/chatbot/ui/chatbot-floating-options.js"></script> <!-- æ–°å¢å¼•ç”¨ -->
  <script src="../../js/chatbot/ui/chatbot-tooltrace-ui.js"></script>
  <script src="../../js/chatbot/ui/semantic-groups-ui.js"></script> <!-- æ–°å¢ï¼šæ„ç¾¤é¢æ¿ -->
  <script src="../../js/chatbot/ui/embedding-config-ui.js"></script> <!-- æ–°å¢ï¼šå‘é‡æœç´¢é…ç½® -->
  <script src="../../js/chatbot/ui/chatbot-ui.js"></script>
  <!-- Chatbot æ¨¡å‹é…ç½®å¼¹çª—ï¼ˆç‹¬ç«‹é…ç½®ç•Œé¢ï¼‰ -->
  <script src="../../js/chatbot/ui/chatbot-model-config-modal.js?v=20251107f"></script>
  <script src="../../js/chatbot/ui/chatbot-model-selector-ui.js"></script>
  <script src="../../js/chatbot/strategy/segmentation-strategy.js"></script>

  <script src="../../js/ui/dock/dock_logic.js"></script>
  <script src="../../js/processing/markdown_processor_enhanced.js"></script>
  <!-- AST-based processor (æ–°æ¶æ„) -->
  <script src="../../js/processing/markdown_processor_ast.js"></script>
  <script src="../../js/processing/annotation_plugin_ast.js"></script>  <!-- æ³¨é‡Šæ’ä»¶ -->
  <script src="../../js/processing/markdown_processor_integration.js"></script>  <!-- é›†æˆå±‚ -->
  <script src="../../js/processing/formula_post_processor.js"></script>  <!-- å…¬å¼åå¤„ç† -->
  <script src="../../js/processing/markdown_text_fix.js"></script>
  <script src="../../js/processing/markdown_processor.js"></script>
  <script src="../../js/processing/sub_block_segmenter.js"></script>
  <script src="../../js/processing/content-list-to-chunks.js"></script>
  <script src="../../js/ui/dock/dock_settings_modal.js"></script> <!-- ADDED -->
  <script src="../../js/annotations/annotations_summary_modal.js"></script> <!-- ADDED -->
  <!-- DOCX å¯¼å‡º - MathML â†’ OMML è½¬æ¢å™¨ -->
  <script src="../../js/history/exporter/mathml2omml.browser.js"></script> <!-- ä¸“ä¸šè½¬æ¢åº“ï¼ˆä¼˜å…ˆï¼‰ -->
  <script src="../../js/history/exporter/docx_mathml_converter_enhanced.js"></script> <!-- å¢å¼ºè½¬æ¢å™¨ï¼ˆå¤‡ç”¨ï¼‰ -->
  <script src="../../js/history/exporter/history_exporter_docx.js"></script>
  <script src="../../js/history/history_exporter.js"></script>
  <!-- Text Fitting Engine for PDF Translation -->
  <script src="../../js/utils/text-fitting.js"></script>
  <script src="../../js/utils/text-fitting-integration.js"></script>

  <!-- PDF Compare View æ¨¡å—åŒ–ç»„ä»¶ -->
  <script src="../../js/history/modules/TextFitting.js"></script>
  <script src="../../js/history/modules/PDFExporter.js"></script>
  <script src="../../js/history/modules/SegmentManager.js"></script>

  <!-- PDF Compare View ä¸»ç±» -->
  <script src="../../js/history/history_pdf_compare.js"></script>

  <!-- ===================== -->
  <!-- é¡µé¢æ ¸å¿ƒé€»è¾‘è„šæœ¬ -->
  <!-- ===================== -->
  <script src="../../js/history/history_detail_globals.js"></script>
  <script src="../../js/history/history_detail_render.js"></script>
  <script src="../../js/history/history_detail_show_tab.js"></script>
  <script src="../../js/history/history_detail_scripts.js"></script>
  <script src="../../js/ui/immersive_layout_logic.js"></script> <!-- æ–°å¢æ²‰æµ¸å¼å¸ƒå±€JS -->
  <script src="../../js/ui/chunk_compare_optimizer.js"></script> <!-- åˆ†å—å¯¹æ¯”æ€§èƒ½ä¼˜åŒ–å™¨ -->
  <script src="../../js/ui/chunk_compare_integration.js"></script> <!-- åˆ†å—å¯¹æ¯”ä¼˜åŒ–å™¨é›†æˆ -->
  <script src="../../js/ui/chunk_compare_performance_tester.js"></script> <!-- åˆ†å—å¯¹æ¯”æ€§èƒ½æµ‹è¯•å™¨ -->
  <script src="../../js/ui/lightbox.js"></script> <!-- å›¾ç‰‡ç¯ç®±åŠŸèƒ½ -->

  <!-- å‚è€ƒæ–‡çŒ®ç®¡ç†æ¨¡å— -->
  <script src="../../js/processing/reference-detector.js"></script>
  <script src="../../js/processing/reference-extractor.js"></script>
  <script src="../../js/processing/reference-doi-resolver.js"></script>
  <script src="../../js/processing/reference-ai-processor.js"></script>
  <script src="../../js/processing/reference-indexer.js"></script>
  <script src="../../js/storage/reference-storage.js"></script>
  <script src="../../js/ui/reference-manager-ui.js"></script>
  <script src="../../js/ui/reference-manager-detail.js"></script> <!-- è¯¦æƒ…é¡µä¸“ç”¨ -->

  <!-- ç»Ÿä¸€ä¾§è¾¹æ é›†æˆ (Non-Immersive Mode) -->
  <script src="../../js/ui/sidebar-integration.js"></script>

</body>
</html>
