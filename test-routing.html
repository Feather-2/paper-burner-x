<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¯ç”±éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #1e293b;
        }
        .result {
            padding: 10px;
            background: white;
            border-radius: 4px;
            margin-top: 10px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }
        .success {
            color: #10b981;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        .info {
            color: #3b82f6;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #1d4ed8;
        }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” MarkdownProcessor è·¯ç”±éªŒè¯</h1>

        <div class="test-section">
            <div class="test-title">1. æ£€æµ‹åŠ è½½çš„å¤„ç†å™¨</div>
            <div id="loadCheck" class="result">æ£€æŸ¥ä¸­...</div>
        </div>

        <div class="test-section">
            <div class="test-title">2. æ£€æŸ¥ MarkdownProcessor çš„å®é™…è·¯ç”±</div>
            <div id="routingCheck" class="result">æ£€æŸ¥ä¸­...</div>
        </div>

        <div class="test-section">
            <div class="test-title">3. æµ‹è¯•å®é™…æ¸²æŸ“è°ƒç”¨</div>
            <button onclick="testRender()">æ‰§è¡Œæ¸²æŸ“æµ‹è¯•</button>
            <div id="renderResult" class="result" style="margin-top: 10px; display: none;"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. æ§åˆ¶å°æ—¥å¿—</div>
            <pre id="consoleLog">æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</pre>
        </div>
    </div>

    <!-- ä¾èµ–åº“ -->
    <script src="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://gcore.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://gcore.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- å¤„ç†å™¨ï¼ˆæŒ‰ç…§ index.html çš„é¡ºåºï¼‰ -->
    <script src="js/processing/markdown_processor_enhanced.js"></script>
    <script src="js/processing/markdown_processor_ast.js"></script>
    <script src="js/processing/markdown_processor.js"></script>

    <script>
        console.clear();
        console.log('%c=== è·¯ç”±éªŒè¯æµ‹è¯•å¼€å§‹ ===', 'font-size: 16px; font-weight: bold; color: #2563eb;');

        // 1. æ£€æµ‹åŠ è½½çš„å¤„ç†å™¨
        function checkLoaded() {
            const results = [];
            const loadCheck = document.getElementById('loadCheck');

            if (window.MarkdownProcessorEnhanced) {
                results.push('<span class="success">âœ“ MarkdownProcessorEnhanced å·²åŠ è½½</span>');
            } else {
                results.push('<span class="error">âœ— MarkdownProcessorEnhanced æœªåŠ è½½</span>');
            }

            if (window.MarkdownProcessorAST) {
                results.push('<span class="success">âœ“ MarkdownProcessorAST å·²åŠ è½½</span>');
                results.push('<span class="info">  ç‰ˆæœ¬: ' + window.MarkdownProcessorAST.version + '</span>');
            } else {
                results.push('<span class="error">âœ— MarkdownProcessorAST æœªåŠ è½½</span>');
            }

            if (window.MarkdownProcessor) {
                results.push('<span class="success">âœ“ MarkdownProcessor å·²åŠ è½½</span>');
            } else {
                results.push('<span class="error">âœ— MarkdownProcessor æœªåŠ è½½</span>');
            }

            loadCheck.innerHTML = results.join('<br>');
        }

        // 2. æ£€æŸ¥è·¯ç”±
        function checkRouting() {
            const routingCheck = document.getElementById('routingCheck');
            const results = [];

            // æ£€æŸ¥ MarkdownProcessor æ˜¯å¦ç­‰äº AST
            if (window.MarkdownProcessor && window.MarkdownProcessorAST) {
                // é€šè¿‡è°ƒç”¨ safeMarkdown æ¥æ£€æµ‹å®é™…ä½¿ç”¨çš„æ˜¯å“ªä¸ª
                const testInput = 'test $x + y$';
                let usedProcessor = 'æœªçŸ¥';

                try {
                    // ä¸´æ—¶åŠ«æŒ AST çš„ render æ–¹æ³•
                    const originalRender = window.MarkdownProcessorAST.render;
                    let astCalled = false;

                    window.MarkdownProcessorAST.render = function(...args) {
                        astCalled = true;
                        return originalRender.apply(this, args);
                    };

                    // è°ƒç”¨ MarkdownProcessor
                    window.MarkdownProcessor.safeMarkdown(testInput, []);

                    // æ¢å¤
                    window.MarkdownProcessorAST.render = originalRender;

                    if (astCalled) {
                        usedProcessor = 'AST æ¶æ„';
                        results.push('<span class="success">âœ“ MarkdownProcessor æ­£ç¡®è·¯ç”±åˆ° AST</span>');
                    } else {
                        usedProcessor = 'å…¶ä»–ç‰ˆæœ¬';
                        results.push('<span class="error">âœ— MarkdownProcessor æœªè·¯ç”±åˆ° AST</span>');
                    }
                } catch (error) {
                    results.push('<span class="error">âœ— è·¯ç”±æ£€æµ‹å¤±è´¥: ' + error.message + '</span>');
                }

                results.push('<span class="info">  å®é™…ä½¿ç”¨: ' + usedProcessor + '</span>');
            } else {
                results.push('<span class="error">âœ— æ— æ³•æ£€æµ‹è·¯ç”±ï¼ˆå¤„ç†å™¨æœªå®Œå…¨åŠ è½½ï¼‰</span>');
            }

            routingCheck.innerHTML = results.join('<br>');
        }

        // 3. æµ‹è¯•æ¸²æŸ“
        function testRender() {
            const renderResult = document.getElementById('renderResult');
            renderResult.style.display = 'block';

            const testMd = 'Test formula: $x^2 + y^2 = z^2$';

            try {
                const t1 = performance.now();
                const result = window.MarkdownProcessor.renderWithKatexFailback(testMd);
                const t2 = performance.now();

                renderResult.innerHTML = `
                    <span class="success">âœ“ æ¸²æŸ“æˆåŠŸ</span><br>
                    <span class="info">è€—æ—¶: ${(t2 - t1).toFixed(2)} ms</span><br>
                    <div style="margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 4px;">
                        ${result}
                    </div>
                `;

                // æ˜¾ç¤ºæŒ‡æ ‡
                if (window.MarkdownProcessorAST) {
                    const metrics = window.MarkdownProcessorAST.getMetrics();
                    console.log('%cæ¸²æŸ“æŒ‡æ ‡:', 'font-weight: bold; color: #3b82f6;', metrics);
                }
            } catch (error) {
                renderResult.innerHTML = '<span class="error">âœ— æ¸²æŸ“å¤±è´¥: ' + error.message + '</span>';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ£€æµ‹
        window.addEventListener('load', () => {
            console.log('%c--- å¼€å§‹æ£€æµ‹ ---', 'color: #64748b;');
            setTimeout(() => {
                checkLoaded();
                checkRouting();
                console.log('%c=== æ£€æµ‹å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹ç»“æœ ===', 'font-size: 16px; font-weight: bold; color: #10b981;');
            }, 100);
        });
    </script>
</body>
</html>
