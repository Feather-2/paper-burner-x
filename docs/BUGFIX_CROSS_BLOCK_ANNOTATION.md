# Bugä¿®å¤: è·¨å­å—æ‰¹æ³¨çŠ¶æ€æ±¡æŸ“

> **ä¿®å¤æ—¥æœŸ**: 2025-11-12
> **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ï¼ˆå½±å“æ‰¹æ³¨æ ¸å¿ƒåŠŸèƒ½ï¼‰
> **å½±å“èŒƒå›´**: æ‰¹æ³¨å’Œé«˜äº®ç³»ç»Ÿ
> **ä¿®å¤æ–‡ä»¶**: `js/annotations/annotation_logic.js`

---

## ğŸ› Bug æè¿°

### é—®é¢˜è¡¨ç°

ç”¨æˆ·åœ¨è¯¦æƒ…é¡µè¿›è¡Œæ‰¹æ³¨æ“ä½œæ—¶ï¼š

1. å…ˆåšä¸€æ¬¡**è·¨å­å—é«˜äº®**ï¼ˆæ¯”å¦‚é€‰ä¸­ 8 ä¸ªå­å—ï¼‰
2. å†åš**å•å­å—å†…é«˜äº®**ï¼ˆæ¯”å¦‚åªé€‰ä¸­ 109.0 å†…çš„æ–‡æœ¬ï¼‰
3. **Bug**: ç¬¬ 2 æ¬¡æ“ä½œå´æ‰§è¡Œäº†è·¨ 8 ä¸ªå­å—çš„é«˜äº® âŒ

### ç”¨æˆ·æ—¥å¿—

```
[è·¨å­å—æ£€æµ‹] é€‰æ‹©åœ¨åŒä¸€ä¸ªå­å—å†… âœ… æ£€æµ‹æ­£ç¡®
[è·¨å­å—æ£€æµ‹] æœªæ£€æµ‹åˆ°è·¨å­å—é€‰æ‹©ï¼Œç»§ç»­å•å­å—å¤„ç† âœ… æµç¨‹æ­£ç¡®

// ä½†æ˜¯ç‚¹å‡»é«˜äº®æŒ‰é’®åï¼š
[è·¨å­å—æ“ä½œ] æ‰§è¡Œæ“ä½œ: highlight-block, æ¶‰åŠ 8 ä¸ªå­å— âŒ ä½¿ç”¨äº†æ—§æ•°æ®ï¼
```

---

## ğŸ” æ ¹æºåˆ†æ

### é—®é¢˜ä»£ç 

**æ–‡ä»¶**: `annotation_logic.js:804-806`

```javascript
const isCrossBlockOperation = annotationContextMenuElement.dataset.contextIsCrossBlock === "true";
if (isCrossBlockOperation) {
    return handleCrossBlockMenuAction(action, color, event);
}
```

### Bug æœºåˆ¶

#### è·¨å­å—æ“ä½œæ—¶ï¼ˆç¬¬1æ¬¡ï¼‰

```javascript
// annotation_logic.js:1694-1699
annotationContextMenuElement.dataset.contextIsCrossBlock = "true";
annotationContextMenuElement.dataset.contextAffectedSubBlocks = JSON.stringify([...8ä¸ªå­å—ID]);
```

âœ… æ­£ç¡®è®¾ç½®

#### å•å­å—æ“ä½œæ—¶ï¼ˆç¬¬2æ¬¡ï¼‰

```javascript
// annotation_logic.js:716-738 (ä¿®å¤å‰)
annotationContextMenuElement.dataset.contextContentIdentifier = ...;
annotationContextMenuElement.dataset.contextTargetIdentifier = ...;
// ... è®¾ç½®å¾ˆå¤šå±æ€§

// âŒ é—®é¢˜ï¼šæ²¡æœ‰æ¸…é™¤è·¨å­å—ç›¸å…³å±æ€§ï¼
// contextIsCrossBlock ä»ç„¶æ˜¯ "true"
// contextAffectedSubBlocks ä»ç„¶æ˜¯æ—§çš„ 8 ä¸ªå­å—
```

#### ç‚¹å‡»èœå•æ—¶

```javascript
// annotation_logic.js:804
const isCrossBlockOperation = dataset.contextIsCrossBlock === "true";  // âŒ è¯»åˆ°æ—§å€¼ "true"

if (isCrossBlockOperation) {
    return handleCrossBlockMenuAction(...);  // âŒ è¯¯è°ƒç”¨è·¨å­å—å¤„ç†
    // ä½¿ç”¨äº†æ—§çš„ contextAffectedSubBlocksï¼ˆ8ä¸ªå­å—ï¼‰
}
```

### æ—¶åºå›¾

```
æ—¶é—´çº¿ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ç¬¬ 1 æ¬¡æ“ä½œï¼šè·¨å­å—é«˜äº®ï¼ˆ8 ä¸ªå­å—ï¼‰              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ contextIsCrossBlock = "true" âœ…                 â”‚
  â”‚ contextAffectedSubBlocks = [8ä¸ªID] âœ…            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ç¬¬ 2 æ¬¡æ“ä½œï¼šå•å­å—é«˜äº®ï¼ˆ109.0 å†…éƒ¨åˆ†æ–‡æœ¬ï¼‰      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ detectCrossBlockSelection() â†’ false âœ…          â”‚
  â”‚ è®¾ç½® contextContentIdentifier âœ…                â”‚
  â”‚ è®¾ç½® contextTargetIdentifier âœ…                 â”‚
  â”‚ âŒ æ²¡æœ‰æ¸…é™¤ contextIsCrossBlock!                â”‚
  â”‚ âŒ æ²¡æœ‰æ¸…é™¤ contextAffectedSubBlocks!           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ç”¨æˆ·ç‚¹å‡»"é«˜äº®"æŒ‰é’®                               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ è¯»å– contextIsCrossBlock = "true" âŒ (æ—§å€¼)     â”‚
  â”‚ è°ƒç”¨ handleCrossBlockMenuAction âŒ              â”‚
  â”‚ ä½¿ç”¨ contextAffectedSubBlocks = [8ä¸ªID] âŒ (æ—§å€¼â”‚
  â”‚ â†’ é«˜äº®äº†é”™è¯¯çš„ 8 ä¸ªå­å—ï¼                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

**æ–‡ä»¶**: `annotation_logic.js:740-743` (æ–°å¢)

```javascript
// ğŸ”§ BUG FIX: æ¸…é™¤è·¨å­å—ç›¸å…³å±æ€§ï¼Œé¿å…å•å­å—æ“ä½œæ—¶è¯¯ç”¨æ—§çš„è·¨å­å—æ•°æ®
delete annotationContextMenuElement.dataset.contextIsCrossBlock;
delete annotationContextMenuElement.dataset.contextCrossBlockAnnotationId;
delete annotationContextMenuElement.dataset.contextAffectedSubBlocks;
```

### ä¿®å¤ä½ç½®

åœ¨å•å­å—å³é”®äº‹ä»¶å¤„ç†ä¸­ï¼ˆ`annotation_logic.js:708-766`ï¼‰ï¼Œè®¾ç½®å®Œå…¶ä»–å±æ€§åï¼Œ**ç«‹å³æ¸…é™¤**è·¨å­å—ç›¸å…³å±æ€§ã€‚

### ä¿®å¤åçš„æµç¨‹

```
ç¬¬ 1 æ¬¡æ“ä½œï¼šè·¨å­å—é«˜äº®
  â†’ contextIsCrossBlock = "true" âœ…

ç¬¬ 2 æ¬¡æ“ä½œï¼šå•å­å—é«˜äº®
  â†’ æ¸…é™¤ contextIsCrossBlock âœ…
  â†’ æ¸…é™¤ contextAffectedSubBlocks âœ…
  â†’ è®¾ç½® contextTargetIdentifier = "109.0" âœ…

ç‚¹å‡»é«˜äº®æŒ‰é’®
  â†’ contextIsCrossBlock === undefined âœ…
  â†’ isCrossBlockOperation = false âœ…
  â†’ æ‰§è¡Œå•å­å—é«˜äº® âœ…
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

1. **åœºæ™¯ A: è·¨å­å— â†’ å•å­å—**
   - å…ˆè·¨ 5 ä¸ªå­å—é«˜äº®
   - å†åœ¨å•ä¸ªå­å—å†…é€‰æ‹©æ–‡æœ¬é«˜äº®
   - **é¢„æœŸ**: åªé«˜äº®é€‰ä¸­çš„æ–‡æœ¬ âœ…

2. **åœºæ™¯ B: å•å­å— â†’ è·¨å­å—**
   - å…ˆå•å­å—é«˜äº®
   - å†è·¨å¤šä¸ªå­å—é«˜äº®
   - **é¢„æœŸ**: æ­£ç¡®é«˜äº®å¤šä¸ªå­å— âœ…

3. **åœºæ™¯ C: è¿ç»­å•å­å—æ“ä½œ**
   - è¿ç»­åœ¨ä¸åŒæ®µè½åšå•å­å—é«˜äº®
   - **é¢„æœŸ**: æ¯æ¬¡éƒ½æ­£ç¡®é«˜äº® âœ…

### æµ‹è¯•æ­¥éª¤

```bash
# 1. æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°
Ctrl + Shift + R

# 2. æ‰“å¼€å†å²è¯¦æƒ…é¡µ
# 3. å…ˆé€‰ä¸­å¤šä¸ªæ®µè½ â†’ å³é”® â†’ é«˜äº®
# 4. å†é€‰ä¸­å•ä¸ªæ®µè½å†…çš„éƒ¨åˆ†æ–‡æœ¬ â†’ å³é”® â†’ é«˜äº®
# 5. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—
```

**é¢„æœŸæ—¥å¿—** âœ…:
```
[è·¨å­å—æ£€æµ‹] é€‰æ‹©åœ¨åŒä¸€ä¸ªå­å—å†…
[AnnotationLogic] å•å­å—é«˜äº®æ“ä½œ...
ï¼ˆä¸åº”è¯¥å‡ºç° "[è·¨å­å—æ“ä½œ] æ‰§è¡Œæ“ä½œ"ï¼‰
```

---

## ğŸ“Š å½±å“è¯„ä¼°

### ä¸¥é‡ç¨‹åº¦: ğŸ”´ é«˜

**åŸå› **:
- å½±å“æ‰¹æ³¨æ ¸å¿ƒåŠŸèƒ½
- å¯èƒ½å¯¼è‡´é”™è¯¯çš„é«˜äº®èŒƒå›´
- ç”¨æˆ·ä½“éªŒå·®ï¼ˆé«˜äº®äº†ä¸è¯¥é«˜äº®çš„å†…å®¹ï¼‰

### å½±å“èŒƒå›´

| åŠŸèƒ½ | æ˜¯å¦å—å½±å“ | å½±å“ç¨‹åº¦ |
|------|-----------|---------|
| è·¨å­å—é«˜äº® | âœ… æ˜¯ | ğŸ”´ é«˜ |
| å•å­å—é«˜äº® | âœ… æ˜¯ | ğŸ”´ é«˜ |
| æ‰¹æ³¨æ·»åŠ  | âœ… æ˜¯ | ğŸ”´ é«˜ |
| é«˜äº®ç§»é™¤ | âœ… æ˜¯ | ğŸŸ  ä¸­ |
| å…¶ä»–åŠŸèƒ½ | âŒ å¦ | - |

### å¤ç°æ¡ä»¶

- âœ… å¿…é¡»å…ˆåšè¿‡è·¨å­å—æ“ä½œ
- âœ… ç„¶ååšå•å­å—æ“ä½œ
- âœ… ä¸¤æ¬¡æ“ä½œåœ¨åŒä¸€ä¸ªé¡µé¢ä¼šè¯ä¸­

**å¤ç°ç‡**: 100%ï¼ˆç¬¦åˆæ¡ä»¶æ—¶ï¼‰

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ä¼˜å…ˆçº§: ğŸ”´ é«˜

å»ºè®®**ç«‹å³éƒ¨ç½²**ï¼ŒåŸå› ï¼š
1. Bug ä¸¥é‡å½±å“æ‰¹æ³¨æ ¸å¿ƒåŠŸèƒ½
2. ä¿®å¤ç®€å•ï¼ˆ3 è¡Œä»£ç ï¼‰ï¼Œé£é™©æä½
3. ä¸å½±å“å…¶ä»–åŠŸèƒ½

### å›å½’æµ‹è¯•æ¸…å•

```
[ ] è·¨å­å—é«˜äº® â†’ å•å­å—é«˜äº®
[ ] å•å­å—é«˜äº® â†’ è·¨å­å—é«˜äº®
[ ] è¿ç»­å¤šæ¬¡å•å­å—æ“ä½œ
[ ] è·¨å­å—æ‰¹æ³¨æ·»åŠ 
[ ] å•å­å—æ‰¹æ³¨æ·»åŠ 
[ ] é«˜äº®ç§»é™¤
[ ] åˆ‡æ¢æ ‡ç­¾åæ‰¹æ³¨æ¢å¤
```

---

## ğŸ“ ç›¸å…³ Issue

### ç”¨æˆ·æŠ¥å‘Š

> "æˆ‘é€‰ä¸­æŸä¸ªæ®µè½é‡Œé¢æœ‰å…¬å¼çš„æƒ…å†µï¼Œå°±ä¼šå‡ºé”™"

**æ ¹æºä¸æ˜¯å…¬å¼**ï¼Œè€Œæ˜¯ï¼š
- ç”¨æˆ·ä¹‹å‰å¯èƒ½é€‰ä¸­äº†åŒ…å«å…¬å¼çš„**å¤šä¸ªæ®µè½**ï¼ˆè·¨å­å—ï¼‰
- ç„¶åé€‰ä¸­å•ä¸ªæ®µè½å†…çš„æ–‡æœ¬ï¼ˆå•å­å—ï¼‰
- è§¦å‘äº†çŠ¶æ€æ±¡æŸ“ bug

**å…¬å¼åªæ˜¯è§¦å‘åœºæ™¯ä¹‹ä¸€**ï¼Œä»»ä½•è·¨å­å— â†’ å•å­å—æ“ä½œéƒ½ä¼šè§¦å‘ã€‚

---

## ğŸ”® é¢„é˜²æªæ–½

### ä»£ç æ¨¡å¼

**åŸåˆ™**: æ¯æ¬¡è®¾ç½®ä¸Šä¸‹æ–‡èœå•çš„ dataset æ—¶ï¼Œ**æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„æ—§çŠ¶æ€**

**æ¨èæ¨¡å¼**:
```javascript
// æ¸…é™¤æ‰€æœ‰çŠ¶æ€
function clearContextMenuState() {
    const keys = Object.keys(annotationContextMenuElement.dataset);
    keys.filter(k => k.startsWith('context')).forEach(k => {
        delete annotationContextMenuElement.dataset[k];
    });
}

// è®¾ç½®æ–°çŠ¶æ€å‰å…ˆæ¸…é™¤
clearContextMenuState();
annotationContextMenuElement.dataset.contextXXX = newValue;
```

### æœªæ¥æ”¹è¿›

**å»ºè®®**: ä½¿ç”¨çŠ¶æ€æœºç®¡ç†æ‰¹æ³¨ä¸Šä¸‹æ–‡ï¼Œè€Œä¸æ˜¯ä¾èµ– dataset

```javascript
class AnnotationContext {
    constructor() {
        this.reset();
    }

    reset() {
        this.isCrossBlock = false;
        this.affectedSubBlocks = [];
        this.targetIdentifier = null;
        // ...
    }

    setCrossBlock(data) {
        this.reset();
        this.isCrossBlock = true;
        this.affectedSubBlocks = data.subBlocks;
        // ...
    }

    setSingleBlock(data) {
        this.reset();  // è‡ªåŠ¨æ¸…é™¤æ—§çŠ¶æ€
        this.isCrossBlock = false;
        this.targetIdentifier = data.id;
        // ...
    }
}
```

---

## âœ… éªŒæ”¶æ¸…å•

- [x] Bug æ ¹æºåˆ†æå®Œæˆ
- [x] ä¿®å¤ä»£ç å®æ–½å®Œæˆ
- [x] è¯­æ³•æ£€æŸ¥é€šè¿‡
- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] å›å½’æµ‹è¯•é€šè¿‡
- [ ] ç”¨æˆ·éªŒè¯é€šè¿‡
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ“Œ æ€»ç»“

**Bug**: è·¨å­å—æ‰¹æ³¨çŠ¶æ€æ±¡æŸ“å•å­å—æ“ä½œ
**æ ¹æº**: å•å­å—å¤„ç†æ—¶æœªæ¸…é™¤è·¨å­å—ç›¸å…³çš„ dataset å±æ€§
**ä¿®å¤**: æ·»åŠ  3 è¡Œä»£ç æ¸…é™¤æ—§çŠ¶æ€
**å½±å“**: æ‰¹æ³¨æ ¸å¿ƒåŠŸèƒ½
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ï¼Œå»ºè®®ç«‹å³éƒ¨ç½²

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰

æ„Ÿè°¢ç”¨æˆ·çš„è¯¦ç»†åé¦ˆï¼Œè¿™ä¸ª bug å‘ç°å¾—éå¸¸åŠæ—¶ï¼
