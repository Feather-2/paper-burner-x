<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AST æ¶æ„æµ‹è¯•å¯¹æ¯”</title>
    <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 10px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #1d4ed8;
        }
        button.secondary {
            background: #64748b;
        }
        button.secondary:hover {
            background: #475569;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .panel-header {
            background: #f8fafc;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-title {
            font-weight: 600;
            color: #1e293b;
        }
        .panel-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #e0e7ff;
            color: #3730a3;
        }
        .panel-content {
            padding: 20px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
        }
        .test-cases {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-case {
            margin-bottom: 10px;
        }
        .test-case button {
            width: 100%;
            text-align: left;
            background: #f8fafc;
            color: #334155;
            border: 1px solid #e2e8f0;
        }
        .test-case button:hover {
            background: #e2e8f0;
        }
        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ AST æ¶æ„æµ‹è¯•å¯¹æ¯”</h1>

        <div class="controls">
            <h3 style="margin-bottom: 10px;">è¾“å…¥ Markdown æ–‡æœ¬ï¼š</h3>
            <textarea id="input" placeholder="è¾“å…¥è¦æµ‹è¯•çš„ Markdown æ–‡æœ¬...">where $R _ { i , t }$ represents the return of crypto $i$ in month t; $\alpha _ { i }$ represents the asset-specific intercept</textarea>
            <button onclick="renderBoth()">æ¸²æŸ“å¯¹æ¯”</button>
            <button class="secondary" onclick="clearResults()">æ¸…ç©º</button>
        </div>

        <div class="test-cases">
            <h3 style="margin-bottom: 10px;">é¢„è®¾æµ‹è¯•ç”¨ä¾‹ï¼š</h3>
            <div class="test-case">
                <button onclick="loadTestCase('formula')">ğŸ“ å…¬å¼è¯¯åŒ¹é…æµ‹è¯•</button>
            </div>
            <div class="test-case">
                <button onclick="loadTestCase('table')">ğŸ“Š è¡¨æ ¼é”™ä½æµ‹è¯•</button>
            </div>
            <div class="test-case">
                <button onclick="loadTestCase('ocr')">ğŸ”§ OCR é”™è¯¯ä¿®å¤æµ‹è¯•</button>
            </div>
            <div class="test-case">
                <button onclick="loadTestCase('mixed')">ğŸ­ ç»¼åˆåœºæ™¯æµ‹è¯•</button>
            </div>
        </div>

        <div class="metrics" id="metrics" style="display: none;">
            <div class="metric-card">
                <div class="metric-label">æ—§ç‰ˆæ¸²æŸ“æ—¶é—´</div>
                <div class="metric-value" id="oldTime">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">æ–°ç‰ˆæ¸²æŸ“æ—¶é—´</div>
                <div class="metric-value" id="newTime">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">é€Ÿåº¦æå‡</div>
                <div class="metric-value" id="speedup">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">å…¬å¼æˆåŠŸç‡</div>
                <div class="metric-value" id="formulaRate">-</div>
            </div>
        </div>

        <div class="comparison">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">æ—§ç‰ˆï¼ˆæ­£åˆ™æ–¹æ¡ˆï¼‰</span>
                    <span class="panel-badge">marked + regex</span>
                </div>
                <div class="panel-content" id="oldResult"></div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">æ–°ç‰ˆï¼ˆAST æ–¹æ¡ˆï¼‰</span>
                    <span class="panel-badge">markdown-it + AST</span>
                </div>
                <div class="panel-content" id="newResult"></div>
            </div>
        </div>
    </div>

    <!-- ä¾èµ–åº“ -->
    <script src="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://gcore.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://gcore.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <!-- æ—§ç‰ˆå¤„ç†å™¨ -->
    <script src="js/processing/markdown_processor_enhanced.js"></script>

    <!-- æ–°ç‰ˆå¤„ç†å™¨ -->
    <script src="js/processing/markdown_processor_ast.js"></script>

    <script>
        // æµ‹è¯•ç”¨ä¾‹
        const testCases = {
            formula: `where $R _ { i , t }$ represents the return of crypto $i$ in month t; $\\alpha _ { i }$ represents the asset-specific intercept; $\\beta _ { i , f a c t o r }$ represent crypto i's sensitivity to the respective factor`,

            table: `| æŒ‡æ ‡ | 1 | 2 | 3 | 4 | 5 |
|------|---|---|---|---|---|
| å¸‚åœº | 0.145*** | 0.200** | 0.061* | 0.136* | 0.106*** |
| | (2.774) | (2.441) | (1.938) | (1.689) | (2.703) |
| è§„æ¨¡ | 0.107** | 0.329* | 0.147** | 0.206** | 0.059*** |`,

            ocr: `This is a formula: $\\$ R_{i,t} \\$ and another one: $\\$ \\alpha_{i} \\$$`,

            mixed: `# æµ‹è¯•æ–‡æ¡£

## å…¬å¼æµ‹è¯•
The regression model is: $R_{i,t} = \\alpha_i + \\beta_i \\cdot Factor_t + \\epsilon_{i,t}$

## è¡¨æ ¼æµ‹è¯•
| å˜é‡ | ç³»æ•° | tå€¼ |
|------|------|-----|
| å¸¸æ•°é¡¹ | 0.05 | 2.3 |
| | (æ ‡å‡†è¯¯) | (0.02) |

## OCR é”™è¯¯æµ‹è¯•
Some text with $\\$ x + y \\$$ formula.`
        };

        function loadTestCase(name) {
            document.getElementById('input').value = testCases[name];
            renderBoth();
        }

        function renderBoth() {
            const input = document.getElementById('input').value;
            if (!input.trim()) {
                alert('è¯·è¾“å…¥ Markdown æ–‡æœ¬');
                return;
            }

            // æ˜¾ç¤ºæŒ‡æ ‡é¢æ¿
            document.getElementById('metrics').style.display = 'grid';

            // æ—§ç‰ˆæ¸²æŸ“
            const oldStart = performance.now();
            let oldResult = '';
            try {
                const processed = MarkdownProcessorEnhanced.safeMarkdown(input, []);
                oldResult = MarkdownProcessorEnhanced.renderWithKatexFailback(processed);
            } catch (error) {
                oldResult = `<div style="color: red;">æ¸²æŸ“é”™è¯¯: ${error.message}</div>`;
            }
            const oldTime = performance.now() - oldStart;

            // æ–°ç‰ˆæ¸²æŸ“
            const newStart = performance.now();
            let newResult = '';
            try {
                newResult = MarkdownProcessorAST.render(input, []);
            } catch (error) {
                newResult = `<div style="color: red;">æ¸²æŸ“é”™è¯¯: ${error.message}</div>`;
            }
            const newTime = performance.now() - newStart;

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('oldResult').innerHTML = oldResult;
            document.getElementById('newResult').innerHTML = newResult;

            // æ˜¾ç¤ºæŒ‡æ ‡
            document.getElementById('oldTime').textContent = oldTime.toFixed(2) + ' ms';
            document.getElementById('newTime').textContent = newTime.toFixed(2) + ' ms';

            const speedup = ((oldTime / newTime - 1) * 100).toFixed(1);
            document.getElementById('speedup').textContent = speedup > 0 ? '+' + speedup + '%' : speedup + '%';
            document.getElementById('speedup').style.color = speedup > 0 ? '#10b981' : '#ef4444';

            // è·å–æ–°ç‰ˆæŒ‡æ ‡
            const metrics = MarkdownProcessorAST.getMetrics();
            document.getElementById('formulaRate').textContent =
                `${metrics.formulaSuccesses}/${metrics.formulaSuccesses + metrics.formulaErrors}`;
        }

        function clearResults() {
            document.getElementById('input').value = '';
            document.getElementById('oldResult').innerHTML = '';
            document.getElementById('newResult').innerHTML = '';
            document.getElementById('metrics').style.display = 'none';
        }

        // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“é»˜è®¤ç¤ºä¾‹
        window.addEventListener('load', () => {
            renderBoth();
        });
    </script>
</body>
</html>
