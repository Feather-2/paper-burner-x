<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>renderBatch è¡¨æ ¼æ¸²æŸ“æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <script src="js/processing/markdown_processor_ast.js"></script>
    <script src="js/processing/formula_post_processor.js"></script>
    <script src="js/processing/markdown_processor_integration.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-case {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            color: #27ae60;
            font-weight: bold;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .fail {
            color: #e74c3c;
            font-weight: bold;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .result {
            border: 2px solid #3498db;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        .result table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .result th, .result td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .result th {
            background: #3498db;
            color: white;
        }
        .source {
            background: #ecf0f1;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #95a5a6;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª renderBatch è¡¨æ ¼æ¸²æŸ“æµ‹è¯•</h1>
    <p>æ­¤æµ‹è¯•æ¨¡æ‹Ÿå®é™…åº”ç”¨ä¸­çš„ renderBatch æ¸²æŸ“æµç¨‹ï¼ŒéªŒè¯ä¸‰å±‚ä¿®å¤æœºåˆ¶</p>

    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        const allLogs = [];

        // æ‹¦æˆª console
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        console.log = function(...args) {
            allLogs.push('[LOG] ' + args.join(' '));
            originalLog.apply(console, args);
        };

        console.warn = function(...args) {
            allLogs.push('[WARN] ' + args.join(' '));
            originalWarn.apply(console, args);
        };

        console.error = function(...args) {
            allLogs.push('[ERROR] ' + args.join(' '));
            originalError.apply(console, args);
        };

        // æµ‹è¯•ç”¨ä¾‹
        const testCases = [
            {
                name: 'æµ‹è¯• 1: æ™®é€šå¤šè¡Œè¡¨æ ¼',
                markdown: `| Header 1 | Header 2 | Header 3 |
|----------|----------|----------|
| Row 1 A  | Row 1 B  | Row 1 C  |
| Row 2 A  | Row 2 B  | Row 2 C  |`,
                expectedType: 'table'
            },
            {
                name: 'æµ‹è¯• 2: ç®€å•å‹ç¼©è¡¨æ ¼',
                markdown: `| A | B | C ||---|---|---|| 1 | 2 | 3 || 4 | 5 | 6 |`,
                expectedType: 'table'
            },
            {
                name: 'æµ‹è¯• 3: å¤æ‚å‹ç¼©è¡¨æ ¼ï¼ˆBlock #31ï¼‰',
                markdown: `| | | | äº”åˆ†ä½æ•° (Quintiles) | | | |---|---|---|---|---|---|---| | | 1 | 2 | 3 | 4 | 5 | 5-1 | | å¸‚åœº (Market) | 0.145*** | 0.200** | 0.061* | 0.136* | 0.106*** | -0.039 | | | (2.774) | (2.441) | (1.938) | (1.689) | (2.703) | (-0.930) | | è§„æ¨¡ (Size) | 0.107** | 0.329* | 0.147** | 0.206** | 0.059*** | 0.047 | | | (2.163) | (1.800) | (2.223) | (2.452) | (3.150) | (1.090) |`,
                expectedType: 'table'
            },
            {
                name: 'æµ‹è¯• 4: å¸¦å…¬å¼çš„è¡¨æ ¼',
                markdown: `| å˜é‡ | å€¼ |
|------|------|
| Î± | $\\alpha = 0.05$ |
| Î² | $\\beta = 0.95$ |`,
                expectedType: 'table'
            }
        ];

        // æ¨¡æ‹Ÿ renderBatch çš„æ¸²æŸ“é€»è¾‘
        function simulateRenderBatch(markdown, testName) {
            const logs = [];

            // æ­¥éª¤1: ä½¿ç”¨ marked.lexer è¿›è¡Œè¯æ³•åˆ†æ
            logs.push('=== æ­¥éª¤ 1: marked.lexer è¯æ³•åˆ†æ ===');
            const tokens = marked.lexer(markdown);
            logs.push(`Token æ•°é‡: ${tokens.length}`);
            if (tokens.length > 0) {
                logs.push(`Token[0] type: "${tokens[0].type}"`);
                logs.push(`Token[0] raw: "${tokens[0].raw.substring(0, 100)}..."`);
            }

            // æ­¥éª¤2: åº”ç”¨ä¸‰å±‚ä¿®å¤æœºåˆ¶
            logs.push('\n=== æ­¥éª¤ 2: åº”ç”¨ä¸‰å±‚ä¿®å¤æœºåˆ¶ ===');

            const tokenRaw = tokens[0]?.raw || '';

            // ã€ç¬¬ä¸€å±‚ã€‘Pre-render detection
            const hasTableSyntax = /\|(:?-+:?\|)+/.test(tokenRaw);
            logs.push(`æ£€æµ‹è¡¨æ ¼è¯­æ³•: ${hasTableSyntax ? 'âœ“ æ˜¯' : 'âœ— å¦'}`);

            if (tokens[0].type === 'paragraph' && hasTableSyntax) {
                logs.push('âœ“ [ç¬¬ä¸€å±‚] æ£€æµ‹åˆ° paragraph token åŒ…å«è¡¨æ ¼è¯­æ³•ï¼Œå¼ºåˆ¶ä½œä¸ºè¡¨æ ¼å¤„ç†');
                tokens[0].type = 'table';
            }
            logs.push(`å¤„ç†å token type: "${tokens[0].type}"`);

            // ã€ç¬¬äºŒå±‚ã€‘Use AST renderer
            logs.push('\n=== æ­¥éª¤ 3: AST æ¸²æŸ“å™¨æ¸²æŸ“ ===');
            let htmlStr;
            if (typeof MarkdownIntegration !== 'undefined' && MarkdownIntegration.smartRender) {
                logs.push('ä½¿ç”¨ MarkdownIntegration.smartRender');
                htmlStr = MarkdownIntegration.smartRender(tokenRaw, {}, null, 'test');
            } else if (typeof MarkdownProcessorAST !== 'undefined' && MarkdownProcessorAST.render) {
                logs.push('ä½¿ç”¨ MarkdownProcessorAST.render');
                htmlStr = MarkdownProcessorAST.render(tokenRaw, {});
            } else {
                logs.push('é™çº§åˆ°åŸºç¡€æ¸²æŸ“å™¨');
                const md = markdownit({ html: true });
                htmlStr = md.render(tokenRaw);
            }

            logs.push(`æ¸²æŸ“ç»“æœç±»å‹: ${htmlStr.trim().startsWith('<table') ? '<table>' : htmlStr.trim().startsWith('<p') ? '<p>' : 'å…¶ä»–'}`);
            logs.push(`æ¸²æŸ“ç»“æœé•¿åº¦: ${htmlStr.length} å­—ç¬¦`);

            // ã€ç¬¬ä¸‰å±‚ã€‘Post-render recovery
            logs.push('\n=== æ­¥éª¤ 4: åéªŒæ£€æŸ¥ ===');
            if (hasTableSyntax && htmlStr.trim().startsWith('<p')) {
                logs.push('âš  [ç¬¬ä¸‰å±‚] æ¸²æŸ“åä»ç„¶æ˜¯ <p>ï¼Œå°è¯•ç›´æ¥æå–å¹¶æ¸²æŸ“è¡¨æ ¼éƒ¨åˆ†');

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlStr;
                const pElement = tempDiv.querySelector('p');

                if (pElement && pElement.textContent.includes('|')) {
                    const tableMarkdown = pElement.textContent;
                    logs.push(`æå–åˆ°è¡¨æ ¼ Markdown: "${tableMarkdown.substring(0, 80)}..."`);

                    if (typeof MarkdownProcessorAST !== 'undefined' && MarkdownProcessorAST.render) {
                        htmlStr = MarkdownProcessorAST.render(tableMarkdown, {});
                        logs.push('âœ“ é‡æ–°æ¸²æŸ“è¡¨æ ¼æˆåŠŸ');
                        logs.push(`æ–°æ¸²æŸ“ç»“æœç±»å‹: ${htmlStr.trim().startsWith('<table') ? '<table>' : '<p>'}`);
                    }
                }
            } else {
                logs.push('âœ“ æ¸²æŸ“ç»“æœæ­£ç¡®ï¼Œæ— éœ€åå¤„ç†');
            }

            return { htmlStr, logs };
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        testCases.forEach((testCase, index) => {
            allLogs.length = 0; // æ¸…ç©ºæ—¥å¿—

            const section = document.createElement('div');
            section.className = 'test-case';

            const result = simulateRenderBatch(testCase.markdown, testCase.name);
            const isTable = result.htmlStr.trim().startsWith('<table');
            const passed = isTable && testCase.expectedType === 'table';

            section.innerHTML = `
                <h2>${testCase.name}</h2>
                <div class="${passed ? 'success' : 'fail'}">
                    ${passed ? 'âœ“ æµ‹è¯•é€šè¿‡' : 'âœ— æµ‹è¯•å¤±è´¥'}
                    - æœŸæœ›: &lt;${testCase.expectedType}&gt;,
                    å®é™…: ${isTable ? '&lt;table&gt;' : '&lt;p&gt;'}
                </div>

                <h3>æº Markdown:</h3>
                <div class="source">${testCase.markdown}</div>

                <h3>æ¸²æŸ“ç»“æœ:</h3>
                <div class="result">${result.htmlStr}</div>

                <h3>å¤„ç†æ—¥å¿—:</h3>
                <div class="log">${result.logs.join('\n')}</div>
            `;

            output.appendChild(section);
        });

        // æ˜¾ç¤ºæ±‡æ€»æ—¥å¿—
        setTimeout(() => {
            const summarySection = document.createElement('div');
            summarySection.className = 'test-case';
            summarySection.innerHTML = `
                <h2>ğŸ” å®Œæ•´æ§åˆ¶å°æ—¥å¿—</h2>
                <div class="log">${allLogs.join('\n')}</div>
            `;
            output.appendChild(summarySection);
        }, 500);
    </script>
</body>
</html>
