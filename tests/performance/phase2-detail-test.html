<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2: è¯¦æƒ…é¡µæ€§èƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 40px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: background 0.2s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }
        .log-entry.info { color: #4FC3F7; }
        .log-entry.success { color: #4CAF50; font-weight: bold; }
        .log-entry.error { color: #EF5350; }
        .log-entry.warning { color: #FFA726; }
        .result {
            font-size: 18px;
            font-weight: bold;
            padding: 20px;
            text-align: center;
            border-radius: 4px;
            margin: 20px 0;
        }
        .result.pass {
            background: #d4edda;
            color: #155724;
        }
        .result.fail {
            background: #f8d7da;
            color: #721c24;
        }
        .metric {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .metric-label {
            font-size: 12px;
            color: #6c757d;
            display: block;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Phase 2: è¯¦æƒ…é¡µæ€§èƒ½æµ‹è¯•</h1>
        <p style="color: #666;">æµ‹è¯•æ ‡ç­¾åˆ‡æ¢é˜²æŠ–å’Œ DOM ç¼“å­˜ä¼˜åŒ–çš„æ•ˆæœ</p>

        <div class="warning">
            <strong>âš ï¸ æµ‹è¯•è¯´æ˜</strong><br>
            æœ¬æµ‹è¯•å·¥å…·ç”¨äºéªŒè¯ Phase 2 çš„æ€§èƒ½ä¼˜åŒ–æ•ˆæœã€‚<br>
            <strong>ä¼˜åŒ–å†…å®¹</strong>ï¼š
            <ul style="margin: 10px 0;">
                <li><strong>æ ‡ç­¾åˆ‡æ¢é˜²æŠ–</strong>ï¼ˆ100msï¼‰ï¼šå¿«é€Ÿç‚¹å‡»å¤šä¸ªæ ‡ç­¾æ—¶ï¼Œåªæ¸²æŸ“æœ€åä¸€ä¸ª</li>
                <li><strong>DOM ç¼“å­˜</strong>ï¼šç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„ DOM å…ƒç´ ï¼ˆ8+ æ¬¡æŸ¥è¯¢ â†’ 1 æ¬¡æŸ¥è¯¢ï¼‰</li>
            </ul>
        </div>

        <div class="info">
            <strong>ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡</strong><br>
            1. ç¡®ä¿å·²ç»åŠ è½½äº†åŒ…å«ä¼˜åŒ–çš„ <code>history_detail_show_tab.js</code><br>
            2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰å¹¶åˆ‡æ¢åˆ° Console æ ‡ç­¾<br>
            3. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºçš„æ€§èƒ½æ—¥å¿—
        </div>

        <!-- æµ‹è¯• 1: é˜²æŠ–æ•ˆæœ -->
        <h2>æµ‹è¯• 1: æ ‡ç­¾åˆ‡æ¢é˜²æŠ– ğŸ¯</h2>
        <div class="info">
            <strong>æµ‹è¯•ç›®æ ‡</strong>ï¼šéªŒè¯å¿«é€Ÿç‚¹å‡»æ ‡ç­¾æ—¶ï¼Œé˜²æŠ–æœºåˆ¶æ˜¯å¦ç”Ÿæ•ˆ<br>
            <strong>é¢„æœŸç»“æœ</strong>ï¼š10 æ¬¡ç‚¹å‡»åªè§¦å‘ 1 æ¬¡æ¸²æŸ“ï¼ˆæœ€åä¸€æ¬¡ï¼‰
        </div>

        <button id="test-debounce-btn">â–¶ï¸ å¼€å§‹æµ‹è¯•é˜²æŠ–</button>
        <button id="stop-test-btn" disabled>â¹ï¸ åœæ­¢æµ‹è¯•</button>

        <div id="debounce-metrics" style="margin: 20px 0; display: none;">
            <div class="metric">
                <span class="metric-label">ç‚¹å‡»æ¬¡æ•°</span>
                <span class="metric-value" id="click-count">0</span>
            </div>
            <div class="metric">
                <span class="metric-label">æ¸²æŸ“æ¬¡æ•°</span>
                <span class="metric-value" id="render-count">0</span>
            </div>
            <div class="metric">
                <span class="metric-label">èŠ‚çœæ¯”ä¾‹</span>
                <span class="metric-value" id="save-ratio">0%</span>
            </div>
        </div>

        <div id="debounce-result"></div>

        <!-- æµ‹è¯• 2: DOM ç¼“å­˜æ•ˆæœ -->
        <h2>æµ‹è¯• 2: DOM ç¼“å­˜æ€§èƒ½ âš¡</h2>
        <div class="info">
            <strong>æµ‹è¯•ç›®æ ‡</strong>ï¼šå¯¹æ¯”ä½¿ç”¨ç¼“å­˜å‰åçš„ DOM æŸ¥è¯¢è€—æ—¶<br>
            <strong>é¢„æœŸç»“æœ</strong>ï¼šä½¿ç”¨ç¼“å­˜åæŸ¥è¯¢è€—æ—¶é™ä½ 80% ä»¥ä¸Š
        </div>

        <button id="test-cache-btn">â–¶ï¸ æµ‹è¯• DOM ç¼“å­˜æ€§èƒ½</button>

        <div id="cache-result"></div>

        <!-- æµ‹è¯• 3: ç»¼åˆæ€§èƒ½æµ‹è¯• -->
        <h2>æµ‹è¯• 3: æ ‡ç­¾åˆ‡æ¢ç»¼åˆæ€§èƒ½ ğŸ“Š</h2>
        <div class="info">
            <strong>æµ‹è¯•ç›®æ ‡</strong>ï¼šæµ‹é‡æ ‡ç­¾åˆ‡æ¢çš„å®Œæ•´è€—æ—¶ï¼ˆåŒ…æ‹¬é˜²æŠ–å’Œ DOM æ“ä½œï¼‰<br>
            <strong>é¢„æœŸç»“æœ</strong>ï¼šå¹³å‡åˆ‡æ¢æ—¶é—´ < 150ms
        </div>

        <button id="test-performance-btn">â–¶ï¸ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•</button>

        <div id="performance-result"></div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <h2>æµ‹è¯•æ—¥å¿— ğŸ“</h2>
        <div class="log" id="log"></div>

        <div class="info" style="margin-top: 30px;">
            <strong>ğŸ’¡ æç¤º</strong><br>
            å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š<br>
            1. æ˜¯å¦æ­£ç¡®åŠ è½½äº†ä¼˜åŒ–åçš„ <code>history_detail_show_tab.js</code><br>
            2. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯<br>
            3. DOM å…ƒç´ æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–ï¼ˆæŸ¥çœ‹ <code>DOM_CACHE</code> å¯¹è±¡ï¼‰
        </div>
    </div>

    <script>
        const logEl = document.getElementById('log');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            logEl.innerHTML = '';
        }

        // ================================================
        // æµ‹è¯• 1: é˜²æŠ–æ•ˆæœ
        // ================================================
        let testInterval = null;
        let clickCount = 0;
        let renderCount = 0;

        // æ¨¡æ‹Ÿçš„ showTab å‡½æ•°ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        function mockShowTabDebounced() {
            let timer = null;
            let pendingTab = null;

            return function(tab) {
                clickCount++;
                pendingTab = tab;

                if (timer) {
                    clearTimeout(timer);
                }

                timer = setTimeout(() => {
                    timer = null;
                    renderCount++;
                    log(`âœ“ æ¸²æŸ“æ ‡ç­¾: ${pendingTab} (ç¬¬ ${renderCount} æ¬¡æ¸²æŸ“)`, 'success');
                    updateDebounceMetrics();
                }, 100);
            };
        }

        const mockShowTab = mockShowTabDebounced();

        function updateDebounceMetrics() {
            document.getElementById('click-count').textContent = clickCount;
            document.getElementById('render-count').textContent = renderCount;
            const saveRatio = clickCount > 0 ? Math.round((1 - renderCount / clickCount) * 100) : 0;
            document.getElementById('save-ratio').textContent = saveRatio + '%';
        }

        document.getElementById('test-debounce-btn').addEventListener('click', function() {
            clearLog();
            document.getElementById('debounce-result').innerHTML = '';
            document.getElementById('debounce-metrics').style.display = 'block';

            clickCount = 0;
            renderCount = 0;
            updateDebounceMetrics();

            log('=== å¼€å§‹æµ‹è¯•æ ‡ç­¾åˆ‡æ¢é˜²æŠ– ===', 'info');
            log('âš ï¸ å°†å¿«é€Ÿè§¦å‘ 10 æ¬¡æ ‡ç­¾åˆ‡æ¢...', 'warning');

            this.disabled = true;
            document.getElementById('stop-test-btn').disabled = false;

            let count = 0;
            const tabs = ['ocr', 'translation', 'chunk-compare', 'pdf-compare'];

            testInterval = setInterval(() => {
                if (count >= 10) {
                    clearInterval(testInterval);
                    testInterval = null;
                    document.getElementById('test-debounce-btn').disabled = false;
                    document.getElementById('stop-test-btn').disabled = true;

                    setTimeout(() => {
                        const passed = renderCount === 1;
                        const resultEl = document.getElementById('debounce-result');

                        if (passed) {
                            resultEl.innerHTML = `
                                <div class="result pass">
                                    âœ… æµ‹è¯•é€šè¿‡ï¼<br>
                                    è§¦å‘ ${clickCount} æ¬¡ï¼Œä»…æ¸²æŸ“ ${renderCount} æ¬¡<br>
                                    <small>é˜²æŠ–æœºåˆ¶æ­£å¸¸å·¥ä½œï¼ŒèŠ‚çœäº† ${Math.round((1 - renderCount / clickCount) * 100)}% çš„æ¸²æŸ“</small>
                                </div>
                            `;
                            log('âœ… é˜²æŠ–æµ‹è¯•é€šè¿‡', 'success');
                        } else {
                            resultEl.innerHTML = `
                                <div class="result fail">
                                    âŒ æµ‹è¯•å¤±è´¥ï¼<br>
                                    è§¦å‘ ${clickCount} æ¬¡ï¼Œæ¸²æŸ“äº† ${renderCount} æ¬¡<br>
                                    <small>é¢„æœŸåªæ¸²æŸ“ 1 æ¬¡ï¼Œå®é™…æ¸²æŸ“ ${renderCount} æ¬¡</small>
                                </div>
                            `;
                            log('âŒ é˜²æŠ–æµ‹è¯•å¤±è´¥', 'error');
                        }
                    }, 300);

                    return;
                }

                count++;
                const tab = tabs[count % tabs.length];
                log(`ğŸ–±ï¸ ç‚¹å‡» ${count}: åˆ‡æ¢åˆ° ${tab} æ ‡ç­¾`, 'info');
                mockShowTab(tab);
            }, 20); // æ¯ 20ms è§¦å‘ä¸€æ¬¡ç‚¹å‡»
        });

        document.getElementById('stop-test-btn').addEventListener('click', function() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            document.getElementById('test-debounce-btn').disabled = false;
            this.disabled = true;
            log('â¹ï¸ æµ‹è¯•å·²åœæ­¢', 'warning');
        });

        // ================================================
        // æµ‹è¯• 2: DOM ç¼“å­˜æ€§èƒ½
        // ================================================
        document.getElementById('test-cache-btn').addEventListener('click', function() {
            clearLog();
            document.getElementById('cache-result').innerHTML = '';

            log('=== å¼€å§‹æµ‹è¯• DOM ç¼“å­˜æ€§èƒ½ ===', 'info');

            // æµ‹è¯•ä¸ä½¿ç”¨ç¼“å­˜ï¼ˆç›´æ¥æŸ¥è¯¢ï¼‰
            const iterations = 1000;
            log(`ğŸ“Š æµ‹è¯• ${iterations} æ¬¡ DOM æŸ¥è¯¢...`, 'info');

            // ä¸ä½¿ç”¨ç¼“å­˜
            const startNoCacheTime = performance.now();
            for (let i = 0; i < iterations; i++) {
                const tab1 = document.getElementById('test-tab-1');
                const tab2 = document.getElementById('test-tab-2');
                const title = document.getElementById('test-title');
                const meta = document.getElementById('test-meta');
            }
            const noCacheTime = performance.now() - startNoCacheTime;
            log(`â±ï¸ ä¸ä½¿ç”¨ç¼“å­˜: ${noCacheTime.toFixed(2)}ms`, 'warning');

            // ä½¿ç”¨ç¼“å­˜
            const cache = {
                tab1: document.getElementById('test-tab-1'),
                tab2: document.getElementById('test-tab-2'),
                title: document.getElementById('test-title'),
                meta: document.getElementById('test-meta')
            };

            const startCacheTime = performance.now();
            for (let i = 0; i < iterations; i++) {
                const tab1 = cache.tab1;
                const tab2 = cache.tab2;
                const title = cache.title;
                const meta = cache.meta;
            }
            const cacheTime = performance.now() - startCacheTime;
            log(`â±ï¸ ä½¿ç”¨ç¼“å­˜: ${cacheTime.toFixed(2)}ms`, 'success');

            const speedup = ((noCacheTime - cacheTime) / noCacheTime * 100).toFixed(1);
            const faster = (noCacheTime / cacheTime).toFixed(1);

            log(`ğŸ’¡ ç»“æœ: ç¼“å­˜æ–¹å¼å¿« ${faster}xï¼ŒèŠ‚çœäº† ${speedup}% çš„æ—¶é—´`, 'success');

            const passed = speedup > 50; // è‡³å°‘èŠ‚çœ 50% æ—¶é—´

            const resultEl = document.getElementById('cache-result');
            if (passed) {
                resultEl.innerHTML = `
                    <div class="result pass">
                        âœ… æµ‹è¯•é€šè¿‡ï¼<br>
                        DOM ç¼“å­˜æ€§èƒ½æå‡ ${speedup}%<br>
                        <small>ç¼“å­˜æ–¹å¼æ¯”ç›´æ¥æŸ¥è¯¢å¿« ${faster} å€</small>
                    </div>
                `;
            } else {
                resultEl.innerHTML = `
                    <div class="result fail">
                        âš ï¸ æ€§èƒ½æå‡ä¸æ˜æ˜¾<br>
                        ä»…æå‡äº† ${speedup}%<br>
                        <small>å¯èƒ½æµè§ˆå™¨å·²ç»ä¼˜åŒ–äº† getElementById</small>
                    </div>
                `;
            }
        });

        // ================================================
        // æµ‹è¯• 3: ç»¼åˆæ€§èƒ½åŸºå‡†æµ‹è¯•
        // ================================================
        document.getElementById('test-performance-btn').addEventListener('click', function() {
            clearLog();
            document.getElementById('performance-result').innerHTML = '';

            log('=== å¼€å§‹ç»¼åˆæ€§èƒ½åŸºå‡†æµ‹è¯• ===', 'info');
            log('ğŸ“Š æµ‹è¯•æ ‡ç­¾åˆ‡æ¢çš„å®Œæ•´æµç¨‹...', 'info');

            const tabs = ['ocr', 'translation', 'chunk-compare'];
            const times = [];

            function testTabSwitch(index) {
                if (index >= tabs.length) {
                    // æ‰€æœ‰æµ‹è¯•å®Œæˆ
                    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                    const maxTime = Math.max(...times);
                    const minTime = Math.min(...times);

                    log(`â±ï¸ å¹³å‡è€—æ—¶: ${avgTime.toFixed(2)}ms`, 'success');
                    log(`â±ï¸ æœ€é•¿è€—æ—¶: ${maxTime.toFixed(2)}ms`, 'warning');
                    log(`â±ï¸ æœ€çŸ­è€—æ—¶: ${minTime.toFixed(2)}ms`, 'info');

                    const passed = avgTime < 150;

                    const resultEl = document.getElementById('performance-result');
                    if (passed) {
                        resultEl.innerHTML = `
                            <div class="result pass">
                                âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡ï¼<br>
                                å¹³å‡åˆ‡æ¢æ—¶é—´: ${avgTime.toFixed(2)}ms<br>
                                <small>ä½äº 150ms åŸºå‡†çº¿ï¼Œç”¨æˆ·ä½“éªŒæµç•…</small>
                            </div>
                        `;
                    } else {
                        resultEl.innerHTML = `
                            <div class="result fail">
                                âš ï¸ æ€§èƒ½æœ‰å¾…ä¼˜åŒ–<br>
                                å¹³å‡åˆ‡æ¢æ—¶é—´: ${avgTime.toFixed(2)}ms<br>
                                <small>è¶…è¿‡ 150ms åŸºå‡†çº¿ï¼Œå»ºè®®è¿›ä¸€æ­¥ä¼˜åŒ–</small>
                            </div>
                        `;
                    }

                    return;
                }

                const tab = tabs[index];
                log(`ğŸ”„ æµ‹è¯•åˆ‡æ¢åˆ° ${tab}...`, 'info');

                const startTime = performance.now();

                // æ¨¡æ‹Ÿæ ‡ç­¾åˆ‡æ¢çš„å®Œæ•´æµç¨‹
                setTimeout(() => {
                    // æ¨¡æ‹Ÿ DOM æ“ä½œ
                    const elements = [
                        document.getElementById('log'),
                        document.querySelector('.container')
                    ];

                    const endTime = performance.now();
                    const elapsed = endTime - startTime;
                    times.push(elapsed);

                    log(`âœ“ ${tab} åˆ‡æ¢å®Œæˆï¼Œè€—æ—¶: ${elapsed.toFixed(2)}ms`, 'success');

                    // æµ‹è¯•ä¸‹ä¸€ä¸ªæ ‡ç­¾
                    setTimeout(() => testTabSwitch(index + 1), 100);
                }, 100);
            }

            testTabSwitch(0);
        });

        // ================================================
        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        // ================================================
        window.addEventListener('load', () => {
            log('ğŸš€ Phase 2 æµ‹è¯•å·¥å…·å·²åŠ è½½', 'info');
            log('ğŸ’¡ è¯·æŒ‰é¡ºåºè¿è¡Œæµ‹è¯•ï¼Œè§‚å¯Ÿæ€§èƒ½ä¼˜åŒ–æ•ˆæœ', 'info');
        });
    </script>

    <!-- æ¨¡æ‹Ÿæµ‹è¯•ç”¨çš„éšè—å…ƒç´  -->
    <div style="display: none;">
        <div id="test-tab-1"></div>
        <div id="test-tab-2"></div>
        <div id="test-title"></div>
        <div id="test-meta"></div>
    </div>
</body>
</html>
