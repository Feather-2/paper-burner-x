<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 1 æ€§èƒ½ä¼˜åŒ–æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-section h2 .icon {
            font-size: 24px;
        }

        .test-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        .results {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: #666;
        }

        .result-value {
            font-weight: bold;
            color: #333;
        }

        .result-value.good {
            color: #4CAF50;
        }

        .result-value.bad {
            color: #f44336;
        }

        .log-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.info {
            color: #4FC3F7;
        }

        .log-entry.success {
            color: #4CAF50;
        }

        .log-entry.warning {
            color: #FFA726;
        }

        .log-entry.error {
            color: #EF5350;
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 300px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-badge.pending {
            background: #FFF9C4;
            color: #F57F17;
        }

        .status-badge.running {
            background: #BBDEFB;
            color: #1565C0;
        }

        .status-badge.passed {
            background: #C8E6C9;
            color: #2E7D32;
        }

        .status-badge.failed {
            background: #FFCDD2;
            color: #C62828;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Phase 1 æ€§èƒ½ä¼˜åŒ–æµ‹è¯•å·¥å…·</h1>
        <p class="subtitle">è‡ªåŠ¨åŒ–æµ‹è¯•é˜²æŠ–å’Œå®šæ—¶å™¨ä¼˜åŒ–æ•ˆæœ</p>

        <!-- æµ‹è¯• 1: é˜²æŠ–åŠŸèƒ½ -->
        <div class="test-section">
            <h2>
                <span class="icon">ğŸ”</span>
                æµ‹è¯• 1: æœç´¢é˜²æŠ–ä¼˜åŒ–
                <span class="status-badge pending" id="test1-status">å¾…æµ‹è¯•</span>
            </h2>
            <p class="test-description">
                æµ‹è¯•å†å²è®°å½•æœç´¢è¾“å…¥çš„é˜²æŠ–åŠŸèƒ½ã€‚æ¨¡æ‹Ÿå¿«é€Ÿè¾“å…¥å¤šä¸ªå­—ç¬¦ï¼ŒéªŒè¯æ˜¯å¦åªè§¦å‘ä¸€æ¬¡æ¸²æŸ“ã€‚
                <br><strong>é¢„æœŸç»“æœ</strong>ï¼šå¿«é€Ÿè¾“å…¥ 10 æ¬¡ï¼Œåªè§¦å‘ 1 æ¬¡å‡½æ•°è°ƒç”¨ï¼ˆå‡å°‘ 90%ï¼‰
            </p>

            <div class="test-controls">
                <button onclick="runDebounceTest()">â–¶ï¸ è¿è¡Œæµ‹è¯•</button>
                <button class="secondary" onclick="clearDebounceLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>

            <div class="results" id="debounce-results" style="display: none;">
                <div class="result-item">
                    <span class="result-label">è§¦å‘æ¬¡æ•°:</span>
                    <span class="result-value" id="debounce-triggers">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å®é™…æ‰§è¡Œæ¬¡æ•°:</span>
                    <span class="result-value good" id="debounce-calls">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å‡å°‘æ¯”ä¾‹:</span>
                    <span class="result-value" id="debounce-reduction">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">æ€»è€—æ—¶:</span>
                    <span class="result-value" id="debounce-time">-</span>
                </div>
            </div>

            <div class="log-area" id="debounce-log"></div>
        </div>

        <!-- æµ‹è¯• 2: å®šæ—¶å™¨ä¼˜åŒ– -->
        <div class="test-section">
            <h2>
                <span class="icon">â±ï¸</span>
                æµ‹è¯• 2: è½®è¯¢å®šæ—¶å™¨ä¼˜åŒ–
                <span class="status-badge pending" id="test2-status">å¾…æµ‹è¯•</span>
            </h2>
            <p class="test-description">
                æµ‹è¯•é¡µé¢å¯è§æ€§æ£€æµ‹åŠŸèƒ½ã€‚éªŒè¯é¡µé¢éšè—æ—¶æ˜¯å¦è·³è¿‡è½®è¯¢æ‰§è¡Œã€‚
                <br><strong>é¢„æœŸç»“æœ</strong>ï¼šé¡µé¢éšè—æ—¶ï¼Œè½®è¯¢å‡½æ•°å†…éƒ¨é€»è¾‘ä¸æ‰§è¡Œï¼ˆ0 æ¬¡ï¼‰
            </p>

            <div class="test-controls">
                <button onclick="startPollingTest()">â–¶ï¸ å¼€å§‹ç›‘æ§</button>
                <button class="danger" onclick="stopPollingTest()">â¹ï¸ åœæ­¢ç›‘æ§</button>
                <button class="secondary" onclick="clearPollingLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>

            <div class="results" id="polling-results" style="display: none;">
                <div class="result-item">
                    <span class="result-label">é¡µé¢çŠ¶æ€:</span>
                    <span class="result-value" id="page-visibility">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å®šæ—¶å™¨è¿è¡Œæ¬¡æ•°:</span>
                    <span class="result-value" id="polling-ticks">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å‡½æ•°æ‰§è¡Œæ¬¡æ•°:</span>
                    <span class="result-value good" id="polling-executions">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">è·³è¿‡æ¬¡æ•°ï¼ˆé¡µé¢éšè—ï¼‰:</span>
                    <span class="result-value" id="polling-skipped">-</span>
                </div>
            </div>

            <div class="log-area" id="polling-log"></div>
        </div>

        <!-- ç»¼åˆæŠ¥å‘Š -->
        <div class="test-section" style="border-left-color: #2196F3;">
            <h2>
                <span class="icon">ğŸ“Š</span>
                ç»¼åˆæµ‹è¯•æŠ¥å‘Š
            </h2>
            <div class="results">
                <div class="result-item">
                    <span class="result-label">é˜²æŠ–æµ‹è¯•:</span>
                    <span class="result-value" id="summary-debounce">æœªè¿è¡Œ</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å®šæ—¶å™¨æµ‹è¯•:</span>
                    <span class="result-value" id="summary-polling">æœªè¿è¡Œ</span>
                </div>
                <div class="result-item">
                    <span class="result-label">æ€»ä½“è¯„ä»·:</span>
                    <span class="result-value" id="summary-overall">ç­‰å¾…æµ‹è¯•...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // æµ‹è¯• 1: é˜²æŠ–åŠŸèƒ½æµ‹è¯•
        // ============================================

        // é˜²æŠ–å‡½æ•°å®ç°ï¼ˆä» history.js å¤åˆ¶ï¼‰
        function debounce(fn, delay) {
            let timer = null;
            return function debounced(...args) {
                const context = this;
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => {
                    timer = null;
                    fn.apply(context, args);
                }, delay);
            };
        }

        let debounceTestData = {
            triggers: 0,
            calls: 0,
            startTime: 0
        };

        function logDebounce(message, type = 'info') {
            const log = document.getElementById('debounce-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function clearDebounceLog() {
            document.getElementById('debounce-log').innerHTML = '';
        }

        async function runDebounceTest() {
            const status = document.getElementById('test1-status');
            status.textContent = 'è¿è¡Œä¸­...';
            status.className = 'status-badge running';

            // é‡ç½®æ•°æ®
            debounceTestData = { triggers: 0, calls: 0, startTime: performance.now() };
            clearDebounceLog();

            logDebounce('=== å¼€å§‹é˜²æŠ–æµ‹è¯• ===', 'info');
            logDebounce('é…ç½®: å»¶è¿Ÿ 300ms, å¿«é€Ÿè§¦å‘ 10 æ¬¡', 'info');

            // åˆ›å»ºæµ‹è¯•å‡½æ•°
            let callCount = 0;
            const testFn = debounce(() => {
                callCount++;
                debounceTestData.calls = callCount;
                logDebounce(`âœ“ å‡½æ•°æ‰§è¡Œ (ç¬¬ ${callCount} æ¬¡)`, 'success');
                updateDebounceResults();
            }, 300);

            // æ¨¡æ‹Ÿå¿«é€Ÿè¾“å…¥ 10 æ¬¡
            logDebounce('å¼€å§‹æ¨¡æ‹Ÿå¿«é€Ÿè¾“å…¥...', 'info');
            for (let i = 1; i <= 10; i++) {
                debounceTestData.triggers++;
                logDebounce(`è§¦å‘ #${i}`, 'info');
                testFn();
                await new Promise(resolve => setTimeout(resolve, 50)); // 50ms é—´éš”
            }

            logDebounce('ç­‰å¾…é˜²æŠ–å®Œæˆ...', 'warning');

            // ç­‰å¾…é˜²æŠ–å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 400));

            const totalTime = performance.now() - debounceTestData.startTime;
            logDebounce(`=== æµ‹è¯•å®Œæˆ (è€—æ—¶ ${totalTime.toFixed(0)}ms) ===`, 'success');

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('debounce-results').style.display = 'block';
            updateDebounceResults();

            // è¯„ä¼°ç»“æœ
            if (debounceTestData.calls === 1) {
                status.textContent = 'âœ… é€šè¿‡';
                status.className = 'status-badge passed';
                logDebounce('âœ“ æµ‹è¯•é€šè¿‡ï¼é˜²æŠ–åŠŸèƒ½æ­£å¸¸å·¥ä½œ', 'success');
                document.getElementById('summary-debounce').textContent = 'âœ… é€šè¿‡';
                document.getElementById('summary-debounce').className = 'result-value good';
            } else {
                status.textContent = 'âŒ å¤±è´¥';
                status.className = 'status-badge failed';
                logDebounce(`âœ— æµ‹è¯•å¤±è´¥ï¼é¢„æœŸ 1 æ¬¡æ‰§è¡Œï¼Œå®é™… ${debounceTestData.calls} æ¬¡`, 'error');
                document.getElementById('summary-debounce').textContent = 'âŒ å¤±è´¥';
                document.getElementById('summary-debounce').className = 'result-value bad';
            }

            updateSummary();
        }

        function updateDebounceResults() {
            document.getElementById('debounce-triggers').textContent = debounceTestData.triggers;
            document.getElementById('debounce-calls').textContent = debounceTestData.calls;

            const reduction = ((1 - debounceTestData.calls / debounceTestData.triggers) * 100).toFixed(0);
            const reductionEl = document.getElementById('debounce-reduction');
            reductionEl.textContent = `${reduction}% â†“`;
            reductionEl.className = reduction >= 70 ? 'result-value good' : 'result-value bad';

            const time = (performance.now() - debounceTestData.startTime).toFixed(0);
            document.getElementById('debounce-time').textContent = `${time}ms`;
        }

        // ============================================
        // æµ‹è¯• 2: è½®è¯¢å®šæ—¶å™¨æµ‹è¯•
        // ============================================

        let pollingTestData = {
            ticks: 0,
            executions: 0,
            skipped: 0,
            timerId: null,
            isActive: false
        };

        function logPolling(message, type = 'info') {
            const log = document.getElementById('polling-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function clearPollingLog() {
            document.getElementById('polling-log').innerHTML = '';
        }

        function mockCheckFunction() {
            // æ¨¡æ‹Ÿæ‰¹æ³¨é¢œè‰²æ£€æŸ¥å‡½æ•°
            pollingTestData.executions++;
            logPolling(`âœ“ æ‰§è¡Œå‡½æ•°é€»è¾‘ (ç¬¬ ${pollingTestData.executions} æ¬¡)`, 'success');
            updatePollingResults();
        }

        function startPollingTest() {
            const status = document.getElementById('test2-status');
            status.textContent = 'è¿è¡Œä¸­...';
            status.className = 'status-badge running';

            // é‡ç½®æ•°æ®
            pollingTestData = { ticks: 0, executions: 0, skipped: 0, timerId: null, isActive: true };
            clearPollingLog();

            logPolling('=== å¼€å§‹å®šæ—¶å™¨ç›‘æ§ ===', 'info');
            logPolling('è¯´æ˜: è¯·åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µæµ‹è¯•é¡µé¢éšè—æ£€æµ‹', 'warning');

            document.getElementById('polling-results').style.display = 'block';

            // å¯åŠ¨è½®è¯¢ï¼ˆæ¨¡æ‹Ÿä¼˜åŒ–åçš„é€»è¾‘ï¼‰
            function poll() {
                if (!pollingTestData.isActive) {
                    logPolling('è½®è¯¢å·²åœæ­¢', 'info');
                    return;
                }

                pollingTestData.ticks++;

                if (document.hidden) {
                    pollingTestData.skipped++;
                    logPolling(`â­ï¸ è·³è¿‡æ‰§è¡Œ (é¡µé¢éšè—, æ€»è·³è¿‡: ${pollingTestData.skipped})`, 'warning');
                } else {
                    mockCheckFunction();
                }

                updatePollingResults();
                pollingTestData.timerId = setTimeout(poll, 1000);
            }

            poll();

            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', handleVisibilityChange);

            status.textContent = 'ç›‘æ§ä¸­...';
            document.getElementById('summary-polling').textContent = 'ğŸ”„ è¿è¡Œä¸­';
        }

        function stopPollingTest() {
            const status = document.getElementById('test2-status');

            if (!pollingTestData.isActive) {
                logPolling('âš ï¸ æµ‹è¯•æœªè¿è¡Œ', 'warning');
                return;
            }

            pollingTestData.isActive = false;

            if (pollingTestData.timerId) {
                clearTimeout(pollingTestData.timerId);
                pollingTestData.timerId = null;
            }

            document.removeEventListener('visibilitychange', handleVisibilityChange);

            logPolling('=== æµ‹è¯•åœæ­¢ ===', 'info');
            logPolling(`æ€»è®¡: è½®è¯¢ ${pollingTestData.ticks} æ¬¡, æ‰§è¡Œ ${pollingTestData.executions} æ¬¡, è·³è¿‡ ${pollingTestData.skipped} æ¬¡`, 'success');

            // è¯„ä¼°ç»“æœ
            if (pollingTestData.skipped > 0) {
                status.textContent = 'âœ… é€šè¿‡';
                status.className = 'status-badge passed';
                logPolling('âœ“ æµ‹è¯•é€šè¿‡ï¼é¡µé¢éšè—æ—¶æ­£ç¡®è·³è¿‡æ‰§è¡Œ', 'success');
                document.getElementById('summary-polling').textContent = 'âœ… é€šè¿‡';
                document.getElementById('summary-polling').className = 'result-value good';
            } else {
                status.textContent = 'âš ï¸ æœªéªŒè¯';
                status.className = 'status-badge pending';
                logPolling('âš ï¸ æœªæ£€æµ‹åˆ°é¡µé¢éšè—ï¼Œè¯·åˆ‡æ¢æ ‡ç­¾é¡µåå†æµ‹è¯•', 'warning');
                document.getElementById('summary-polling').textContent = 'âš ï¸ æœªå……åˆ†æµ‹è¯•';
                document.getElementById('summary-polling').className = 'result-value';
            }

            updateSummary();
        }

        function handleVisibilityChange() {
            const isHidden = document.hidden;
            logPolling(
                isHidden ? 'ğŸ”’ é¡µé¢éšè— - å°†è·³è¿‡æ‰§è¡Œ' : 'ğŸ‘ï¸ é¡µé¢å¯è§ - æ¢å¤æ‰§è¡Œ',
                isHidden ? 'warning' : 'success'
            );
            updatePollingResults();
        }

        function updatePollingResults() {
            document.getElementById('page-visibility').textContent =
                document.hidden ? 'ğŸ”’ éšè—' : 'ğŸ‘ï¸ å¯è§';
            document.getElementById('polling-ticks').textContent = pollingTestData.ticks;
            document.getElementById('polling-executions').textContent = pollingTestData.executions;
            document.getElementById('polling-skipped').textContent = pollingTestData.skipped;
        }

        function updateSummary() {
            const debounceResult = document.getElementById('summary-debounce').textContent;
            const pollingResult = document.getElementById('summary-polling').textContent;

            let overall = 'ç­‰å¾…æµ‹è¯•...';
            if (debounceResult.includes('âœ…') && pollingResult.includes('âœ…')) {
                overall = 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼';
                document.getElementById('summary-overall').className = 'result-value good';
            } else if (debounceResult.includes('âŒ') || pollingResult.includes('âŒ')) {
                overall = 'âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥';
                document.getElementById('summary-overall').className = 'result-value bad';
            } else if (debounceResult.includes('âœ…') || pollingResult.includes('âœ…')) {
                overall = 'âš ï¸ éƒ¨åˆ†æµ‹è¯•å®Œæˆ';
                document.getElementById('summary-overall').className = 'result-value';
            }

            document.getElementById('summary-overall').textContent = overall;
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('%cğŸš€ Phase 1 æµ‹è¯•å·¥å…·å·²åŠ è½½', 'color: #4CAF50; font-size: 16px; font-weight: bold;');
            console.log('%cæç¤º: åœ¨è¿™ä¸ªé¡µé¢æµ‹è¯•é˜²æŠ–å’Œå®šæ—¶å™¨ä¼˜åŒ–', 'color: #666;');
        });
    </script>
</body>
</html>
