<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€§èƒ½ç›‘æ§å·¥å…·æµ‹è¯• - Phase 4.4.3</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1, h2 {
      margin-top: 0;
      color: #333;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #da190b;
    }

    .btn-secondary {
      background: #2196F3;
      color: white;
    }

    .btn-secondary:hover {
      background: #0b7dda;
    }

    .btn-warning {
      background: #ff9800;
      color: white;
    }

    .btn-warning:hover {
      background: #e68900;
    }

    #stats-output {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      max-height: 600px;
      overflow-y: auto;
    }

    .status {
      padding: 8px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-weight: 500;
    }

    .status.running {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.stopped {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .test-area {
      padding: 20px;
      background: #e3f2fd;
      border-radius: 4px;
      margin-bottom: 16px;
    }

    .workload-item {
      padding: 12px;
      margin: 8px 0;
      background: white;
      border-radius: 4px;
      border-left: 4px solid #2196F3;
    }

    .info-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .info-box h3 {
      margin-top: 0;
      color: #856404;
    }

    .info-box ul {
      margin: 8px 0;
      padding-left: 24px;
    }

    .info-box code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Phase 4.4.3 - æ€§èƒ½ç›‘æ§å·¥å…·æµ‹è¯•</h1>

    <div class="info-box">
      <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
      <ul>
        <li>ç‚¹å‡»"å¯åŠ¨ç›‘æ§"å¼€å§‹æ”¶é›†æ€§èƒ½æ•°æ®</li>
        <li>è¿è¡Œæµ‹è¯•è´Ÿè½½æ¨¡æ‹ŸçœŸå®æ¸²æŸ“åœºæ™¯</li>
        <li>ç‚¹å‡»"æŸ¥çœ‹ç»Ÿè®¡"æŸ¥çœ‹å®æ—¶æ€§èƒ½æŒ‡æ ‡</li>
        <li>ç‚¹å‡»"å¯¼å‡ºæ•°æ®"å°†æ•°æ®è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆå¯å¤åˆ¶ä¿å­˜ï¼‰</li>
        <li>æ‰€æœ‰æ•°æ®ä»…åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨</li>
      </ul>
      <p><strong>æ§åˆ¶å°å‘½ä»¤ï¼š</strong></p>
      <ul>
        <li><code>PerfMonitor.start()</code> - å¯åŠ¨ç›‘æ§</li>
        <li><code>PerfMonitor.stop()</code> - åœæ­¢ç›‘æ§</li>
        <li><code>PerfMonitor.getStats()</code> - æŸ¥çœ‹ç»Ÿè®¡</li>
        <li><code>PerfMonitor.export()</code> - å¯¼å‡ºæ•°æ®</li>
      </ul>
    </div>

    <div id="status" class="status stopped">
      â¸ï¸ ç›‘æ§çŠ¶æ€ï¼šæœªå¯åŠ¨
    </div>

    <div class="controls">
      <button class="btn-primary" onclick="startMonitor()">ğŸš€ å¯åŠ¨ç›‘æ§</button>
      <button class="btn-danger" onclick="stopMonitor()">â¹ï¸ åœæ­¢ç›‘æ§</button>
      <button class="btn-secondary" onclick="viewStats()">ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡</button>
      <button class="btn-secondary" onclick="exportData()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
      <button class="btn-warning" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
    </div>
  </div>

  <div class="container">
    <h2>ğŸ”¬ æµ‹è¯•è´Ÿè½½</h2>
    <p>è¿è¡Œè¿™äº›æµ‹è¯•æ¥æ¨¡æ‹ŸçœŸå®åœºæ™¯å¹¶æ”¶é›†æ€§èƒ½æ•°æ®ï¼š</p>

    <div class="controls">
      <button class="btn-secondary" onclick="runLightWorkload()">è½»åº¦è´Ÿè½½ï¼ˆ50æ¬¡æ¸²æŸ“ï¼‰</button>
      <button class="btn-secondary" onclick="runMediumWorkload()">ä¸­åº¦è´Ÿè½½ï¼ˆ200æ¬¡æ¸²æŸ“ï¼‰</button>
      <button class="btn-secondary" onclick="runHeavyWorkload()">é‡åº¦è´Ÿè½½ï¼ˆ1000æ¬¡æ¸²æŸ“ï¼‰</button>
      <button class="btn-warning" onclick="runLongTask()">è§¦å‘é•¿ä»»åŠ¡ï¼ˆé˜»å¡300msï¼‰</button>
    </div>

    <div id="test-area" class="test-area">
      <div style="text-align: center; color: #666;">
        ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿è¡Œæµ‹è¯•è´Ÿè½½
      </div>
    </div>
  </div>

  <div class="container">
    <h2>ğŸ“ˆ æ€§èƒ½æ•°æ®</h2>
    <div id="stats-output">
ç­‰å¾…æ•°æ®...

ç‚¹å‡»"å¯åŠ¨ç›‘æ§"åï¼Œè¿è¡Œä¸€äº›æµ‹è¯•è´Ÿè½½ï¼Œç„¶åç‚¹å‡»"æŸ¥çœ‹ç»Ÿè®¡"æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡ã€‚
    </div>
  </div>

  <!-- åŠ è½½ä¾èµ–è„šæœ¬ -->
  <script src="../../js/chatbot/config/performance-config.js"></script>
  <script src="../../js/chatbot/utils/performance-monitor.js"></script>

  <script>
    // UI æ§åˆ¶å‡½æ•°
    function updateStatus(isRunning) {
      const statusEl = document.getElementById('status');
      if (isRunning) {
        statusEl.className = 'status running';
        statusEl.textContent = 'â–¶ï¸ ç›‘æ§çŠ¶æ€ï¼šè¿è¡Œä¸­';
      } else {
        statusEl.className = 'status stopped';
        statusEl.textContent = 'â¸ï¸ ç›‘æ§çŠ¶æ€ï¼šå·²åœæ­¢';
      }
    }

    function startMonitor() {
      PerfMonitor.start();
      updateStatus(true);
    }

    function stopMonitor() {
      PerfMonitor.stop();
      updateStatus(false);
    }

    function viewStats() {
      const stats = PerfMonitor.getStats();
      const output = document.getElementById('stats-output');

      output.textContent = `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ“Š æ€§èƒ½ç›‘æ§ç»Ÿè®¡æŠ¥å‘Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â±ï¸  ä¼šè¯ä¿¡æ¯ï¼š
   çŠ¶æ€ï¼š${stats.session.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
   æ—¶é•¿ï¼š${stats.session.duration}
   å¼€å§‹æ—¶é—´ï¼š${stats.session.startTime || 'N/A'}

ğŸ’» è®¾å¤‡ä¿¡æ¯ï¼š
   æ€§èƒ½ç­‰çº§ï¼š${stats.device.tier}
   CPU æ ¸å¿ƒï¼š${stats.device.cores}
   å†…å­˜ï¼š${stats.device.memory}

ğŸ¨ æ¸²æŸ“æ€§èƒ½ï¼š
   æ ·æœ¬æ•°é‡ï¼š${stats.rendering.samples}
   å¹³å‡è€—æ—¶ï¼š${stats.rendering.stats.avg.toFixed(1)} ms
   æœ€å°è€—æ—¶ï¼š${stats.rendering.stats.min.toFixed(1)} ms
   æœ€å¤§è€—æ—¶ï¼š${stats.rendering.stats.max.toFixed(1)} ms
   P50ï¼ˆä¸­ä½æ•°ï¼‰ï¼š${stats.rendering.stats.p50.toFixed(1)} ms
   P95ï¼š${stats.rendering.stats.p95.toFixed(1)} ms
   P99ï¼š${stats.rendering.stats.p99.toFixed(1)} ms

ğŸ“º å¸§ç‡ (FPS)ï¼š
   æ ·æœ¬æ•°é‡ï¼š${stats.fps.samples}
   å½“å‰ FPSï¼š${stats.fps.current || 'N/A'}
   å¹³å‡ FPSï¼š${stats.fps.stats.avg.toFixed(0)}
   æœ€ä½ FPSï¼š${stats.fps.stats.min}
   æœ€é«˜ FPSï¼š${stats.fps.stats.max}

${stats.memory.available ? `ğŸ’¾ å†…å­˜ä½¿ç”¨ï¼š
   æ ·æœ¬æ•°é‡ï¼š${stats.memory.samples}
   å½“å‰ä½¿ç”¨ï¼š${stats.memory.current?.used || 'N/A'}
   æ€»é‡ï¼š${stats.memory.current?.total || 'N/A'}
   å³°å€¼ï¼š${stats.memory.peak?.used || 'N/A'}` : 'ğŸ’¾ å†…å­˜ç›‘æ§ï¼šä¸å¯ç”¨ï¼ˆä»… Chrome æ”¯æŒï¼‰'}

âš ï¸  é•¿ä»»åŠ¡ï¼ˆ>${PerfMonitor._config.longTaskThreshold}msï¼‰ï¼š
   æ•°é‡ï¼š${stats.longTasks.samples}
   ${stats.longTasks.samples > 0 ? `å¹³å‡è€—æ—¶ï¼š${stats.longTasks.stats.avg.toFixed(1)} ms
   æœ€é•¿è€—æ—¶ï¼š${stats.longTasks.stats.max.toFixed(1)} ms` : ''}

ğŸŒ³ DOM èŠ‚ç‚¹ï¼š
   å½“å‰æ€»æ•°ï¼š${stats.dom.current?.total || 'N/A'}
   èŠå¤©æ¶ˆæ¯æ•°ï¼š${stats.dom.current?.chatMessages || 'N/A'}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ä½¿ç”¨ PerfMonitor.export() å¯¼å‡ºå®Œæ•´æ•°æ®åˆ°æ§åˆ¶å°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`;

      console.log('[æµ‹è¯•] ç»Ÿè®¡æ•°æ®ï¼š', stats);
    }

    function exportData() {
      const data = PerfMonitor.export();
      alert('æ•°æ®å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆF12ï¼‰\nå¯ä»¥å¤åˆ¶ JSON æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶ä¸­è¿›è¡Œåˆ†æ');
    }

    function clearData() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ€§èƒ½æ•°æ®å—ï¼Ÿ')) {
        PerfMonitor.clear();
        document.getElementById('stats-output').textContent = 'æ•°æ®å·²æ¸…ç©º';
      }
    }

    // æµ‹è¯•è´Ÿè½½å‡½æ•°
    function simulateRender(duration) {
      const start = performance.now();

      // æ¨¡æ‹Ÿ CPU å¯†é›†æ“ä½œ
      while (performance.now() - start < duration) {
        // å¿™ç­‰å¾…
      }

      // è®°å½•æ¸²æŸ“è€—æ—¶
      PerfMonitor.recordRender(duration, 'test_simulation');
    }

    function runLightWorkload() {
      const testArea = document.getElementById('test-area');
      testArea.innerHTML = '<div class="workload-item">ğŸŸ¢ è¿è¡Œè½»åº¦è´Ÿè½½æµ‹è¯•...</div>';

      let count = 0;
      const total = 50;

      const interval = setInterval(() => {
        simulateRender(10 + Math.random() * 20); // 10-30ms
        count++;

        if (count >= total) {
          clearInterval(interval);
          testArea.innerHTML = `<div class="workload-item">âœ… è½»åº¦è´Ÿè½½å®Œæˆï¼š${total} æ¬¡æ¸²æŸ“</div>`;
        } else {
          testArea.innerHTML = `<div class="workload-item">ğŸŸ¢ è½»åº¦è´Ÿè½½è¿›è¡Œä¸­... (${count}/${total})</div>`;
        }
      }, 100);
    }

    function runMediumWorkload() {
      const testArea = document.getElementById('test-area');
      testArea.innerHTML = '<div class="workload-item">ğŸŸ¡ è¿è¡Œä¸­åº¦è´Ÿè½½æµ‹è¯•...</div>';

      let count = 0;
      const total = 200;

      const interval = setInterval(() => {
        simulateRender(20 + Math.random() * 40); // 20-60ms
        count++;

        if (count >= total) {
          clearInterval(interval);
          testArea.innerHTML = `<div class="workload-item">âœ… ä¸­åº¦è´Ÿè½½å®Œæˆï¼š${total} æ¬¡æ¸²æŸ“</div>`;
        } else if (count % 20 === 0) {
          testArea.innerHTML = `<div class="workload-item">ğŸŸ¡ ä¸­åº¦è´Ÿè½½è¿›è¡Œä¸­... (${count}/${total})</div>`;
        }
      }, 50);
    }

    function runHeavyWorkload() {
      const testArea = document.getElementById('test-area');
      testArea.innerHTML = '<div class="workload-item">ğŸ”´ è¿è¡Œé‡åº¦è´Ÿè½½æµ‹è¯•...</div>';

      let count = 0;
      const total = 1000;

      const interval = setInterval(() => {
        simulateRender(30 + Math.random() * 70); // 30-100ms
        count++;

        if (count >= total) {
          clearInterval(interval);
          testArea.innerHTML = `<div class="workload-item">âœ… é‡åº¦è´Ÿè½½å®Œæˆï¼š${total} æ¬¡æ¸²æŸ“</div>`;
        } else if (count % 100 === 0) {
          testArea.innerHTML = `<div class="workload-item">ğŸ”´ é‡åº¦è´Ÿè½½è¿›è¡Œä¸­... (${count}/${total})</div>`;
        }
      }, 30);
    }

    function runLongTask() {
      const testArea = document.getElementById('test-area');
      testArea.innerHTML = '<div class="workload-item">âš ï¸ è§¦å‘é•¿ä»»åŠ¡ï¼ˆé˜»å¡ä¸»çº¿ç¨‹ 300msï¼‰...</div>';

      // é˜»å¡ä¸»çº¿ç¨‹ 300ms
      simulateRender(300);

      setTimeout(() => {
        testArea.innerHTML = '<div class="workload-item">âœ… é•¿ä»»åŠ¡å®Œæˆï¼ˆåº”è¯¥åœ¨é•¿ä»»åŠ¡åˆ—è¡¨ä¸­å¯è§ï¼‰</div>';
      }, 100);
    }

    // é¡µé¢åŠ è½½å®Œæˆæç¤º
    window.addEventListener('load', function() {
      console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #4CAF50; font-weight: bold');
      console.log('%c   Phase 4.4.3 æ€§èƒ½ç›‘æ§å·¥å…·æµ‹è¯•é¡µé¢', 'color: #4CAF50; font-weight: bold');
      console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #4CAF50; font-weight: bold');
      console.log('');
      console.log('ğŸ“Œ è¿™æ˜¯ä¸€ä¸ªæœ¬åœ°æ€§èƒ½ç›‘æ§å·¥å…·ï¼Œæ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­');
      console.log('ğŸ“Œ ä¸ä¼šä¸Šä¼ ä»»ä½•æ•°æ®åˆ°æœåŠ¡å™¨');
      console.log('');
      console.log('ä½¿ç”¨æ–¹æ³•ï¼š');
      console.log('  1. ç‚¹å‡»"å¯åŠ¨ç›‘æ§"å¼€å§‹æ”¶é›†æ•°æ®');
      console.log('  2. è¿è¡Œæµ‹è¯•è´Ÿè½½æ¨¡æ‹ŸçœŸå®åœºæ™¯');
      console.log('  3. ç‚¹å‡»"æŸ¥çœ‹ç»Ÿè®¡"æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡');
      console.log('  4. ç‚¹å‡»"å¯¼å‡ºæ•°æ®"å°†æ•°æ®è¾“å‡ºåˆ°æ§åˆ¶å°');
      console.log('');
      console.log('PerfMonitor API:');
      console.log('  PerfMonitor.start()    - å¯åŠ¨ç›‘æ§');
      console.log('  PerfMonitor.stop()     - åœæ­¢ç›‘æ§');
      console.log('  PerfMonitor.getStats() - æŸ¥çœ‹ç»Ÿè®¡');
      console.log('  PerfMonitor.export()   - å¯¼å‡ºæ•°æ®');
    });
  </script>
</body>
</html>
