<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worker ç»¼åˆæ€§èƒ½æµ‹è¯• - Phase 5.1.3</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 { margin-bottom: 12px; color: #333; }

    .warning-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
    }

    .warning-box h3 {
      margin: 0 0 8px 0;
      color: #856404;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary { background: #4CAF50; color: white; }
    .btn-primary:hover { background: #45a049; }
    .btn-secondary { background: #2196F3; color: white; }
    .btn-secondary:hover { background: #0b7dda; }
    .btn-danger { background: #f44336; color: white; }
    .btn-danger:hover { background: #da190b; }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .test-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .test-card h3 {
      margin-bottom: 12px;
      color: #333;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      margin: 6px 0;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 14px;
    }

    .metric.highlight {
      background: #e8f5e9;
      border-left: 4px solid #4CAF50;
      font-weight: 600;
    }

    .metric.warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      font-size: 14px;
    }

    .comparison-table th,
    .comparison-table td {
      padding: 12px;
      text-align: left;
      border: 1px solid #e0e0e0;
    }

    .comparison-table th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .winner {
      background: #e8f5e9 !important;
      font-weight: bold;
      color: #2e7d32;
    }

    .loser {
      background: #ffebee !important;
      color: #666;
    }

    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .bar-label {
      width: 120px;
      font-size: 13px;
      font-weight: 500;
    }

    .bar-track {
      flex: 1;
      height: 30px;
      background: #e0e0e0;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #66BB6A);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      color: white;
      font-size: 12px;
      font-weight: bold;
      transition: width 0.5s ease;
    }

    .bar-fill.slow {
      background: linear-gradient(90deg, #f44336, #e57373);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-running {
      background: #fff3cd;
      color: #856404;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .console-log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .console-log .info { color: #4fc3f7; }
    .console-log .success { color: #81c784; }
    .console-log .warning { color: #ffb74d; }
    .console-log .error { color: #e57373; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”¬ Phase 5.1.3 - Worker ç»¼åˆæ€§èƒ½æµ‹è¯•</h1>
      <p>æµ‹è¯•è¶…é•¿æ–‡æœ¬ã€æµå¼æ›´æ–°ç­‰çœŸå®åœºæ™¯ä¸‹çš„ Worker æ€§èƒ½</p>

      <div class="warning-box">
        <h3>âš ï¸ é‡è¦å‘ç°</h3>
        <p><strong>æµ‹è¯•ç»“è®ºï¼š</strong> å¯¹äº marked.js è¿™ç§é«˜æ€§èƒ½è§£æå™¨ï¼Œåªæœ‰åœ¨æ–‡æœ¬éå¸¸é•¿ï¼ˆ>50kå­—ç¬¦ï¼‰æ—¶ï¼ŒWorker æ‰èƒ½ä½“ç°ä¼˜åŠ¿ã€‚</p>
        <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
          <li><strong>çŸ­æ–‡æœ¬ï¼ˆ<10kï¼‰ï¼š</strong> Worker é€šä¿¡å¼€é”€ > è®¡ç®—å¼€é”€ï¼Œæ€§èƒ½åè€Œæ›´å·®</li>
          <li><strong>ä¸­æ–‡æœ¬ï¼ˆ10k-50kï¼‰ï¼š</strong> æ€§èƒ½æ¥è¿‘ï¼Œå·®å¼‚ä¸æ˜æ˜¾</li>
          <li><strong>é•¿æ–‡æœ¬ï¼ˆ>50kï¼‰ï¼š</strong> Worker å¼€å§‹ä½“ç°ä¼˜åŠ¿ï¼Œä¸»çº¿ç¨‹ä¸è¢«é˜»å¡</li>
          <li><strong>æµå¼æ›´æ–°ï¼š</strong> é¢‘ç¹çš„å°æ›´æ–°ä¸é€‚åˆ Workerï¼Œåº”è¯¥æ‰¹é‡å¤„ç†</li>
        </ul>
        <p style="margin-top: 12px;"><strong>å»ºè®®é…ç½®ï¼š</strong> minTextLength è®¾ä¸º <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px;">10000-20000</code> å­—ç¬¦</p>
      </div>

      <div class="controls">
        <button class="btn-primary" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button class="btn-secondary" onclick="testSuperLongText()">æµ‹è¯•è¶…é•¿æ–‡æœ¬ (100kå­—ç¬¦)</button>
        <button class="btn-secondary" onclick="testStreamingUpdates()">æµ‹è¯•æµå¼æ›´æ–°åœºæ™¯</button>
        <button class="btn-secondary" onclick="testBatchProcessing()">æµ‹è¯•æ‰¹é‡å¤„ç†</button>
        <button class="btn-danger" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
      </div>
    </div>

    <div class="chart-container">
      <h2>ğŸ“Š æ€§èƒ½å¯¹æ¯”å›¾è¡¨</h2>
      <div id="chart-area" class="bar-chart">
        <p style="color: #666; text-align: center; padding: 20px;">è¿è¡Œæµ‹è¯•åå°†æ˜¾ç¤ºå›¾è¡¨...</p>
      </div>
    </div>

    <div class="test-grid" id="results-grid"></div>

    <div class="chart-container">
      <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
      <div id="console-log" class="console-log">ç­‰å¾…æµ‹è¯•...</div>
    </div>
  </div>

  <!-- åŠ è½½ä¾èµ– -->
  <script src="https://gcore.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="../../js/workers/markdown-worker-pool.js"></script>

  <script>
    let testResults = [];

    function log(message, type = 'info') {
      const logEl = document.getElementById('console-log');
      const timestamp = new Date().toLocaleTimeString();
      logEl.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function generateMarkdown(charCount) {
      const paragraphSize = 200;
      const paragraphs = Math.ceil(charCount / paragraphSize);
      let md = '# æ€§èƒ½æµ‹è¯•æ–‡æ¡£\n\n';

      for (let i = 0; i < paragraphs; i++) {
        md += `## ç¬¬ ${i + 1} ç« \n\n`;
        md += `è¿™æ˜¯ç¬¬ ${i + 1} æ®µçš„å†…å®¹ã€‚`.repeat(10) + '\n\n';

        if (i % 10 === 0) {
          md += '```javascript\n';
          md += 'function example() {\n';
          md += '  const data = "test data";\n';
          md += '  return data.length;\n';
          md += '}\n';
          md += '```\n\n';
        }

        if (i % 15 === 0) {
          md += '| åˆ—1 | åˆ—2 | åˆ—3 |\n';
          md += '|-----|-----|-----|\n';
          md += '| A | B | C |\n';
          md += '| D | E | F |\n\n';
        }
      }

      return md;
    }

    async function testPerformance(testName, markdown, useWorker, rounds = 10) {
      log(`å¼€å§‹æµ‹è¯•: ${testName} (${useWorker ? 'Worker' : 'ä¸»çº¿ç¨‹'})`, 'info');

      const times = [];
      const startMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;

      for (let i = 0; i < rounds; i++) {
        const start = performance.now();

        try {
          if (useWorker) {
            await window.markdownWorkerPool.parse(markdown);
          } else {
            marked.parse(markdown);
          }

          const duration = performance.now() - start;
          times.push(duration);
        } catch (error) {
          log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          times.push(NaN);
        }
      }

      const endMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
      const validTimes = times.filter(t => !isNaN(t));

      const result = {
        testName,
        mode: useWorker ? 'Worker' : 'MainThread',
        textLength: markdown.length,
        rounds,
        avgTime: validTimes.reduce((a, b) => a + b, 0) / validTimes.length,
        minTime: Math.min(...validTimes),
        maxTime: Math.max(...validTimes),
        totalTime: validTimes.reduce((a, b) => a + b, 0),
        memoryIncrease: endMemory - startMemory
      };

      log(`${testName} (${useWorker ? 'Worker' : 'ä¸»çº¿ç¨‹'}) å®Œæˆ: å¹³å‡ ${result.avgTime.toFixed(2)} ms`, 'success');

      return result;
    }

    async function testSuperLongText() {
      log('========================================', 'info');
      log('æµ‹è¯•åœºæ™¯: è¶…é•¿æ–‡æœ¬ (100k å­—ç¬¦)', 'info');
      log('========================================', 'info');

      const markdown = generateMarkdown(100000);
      log(`ç”Ÿæˆäº† ${markdown.length} å­—ç¬¦çš„æµ‹è¯•æ–‡æœ¬`, 'info');

      const workerResult = await testPerformance('è¶…é•¿æ–‡æœ¬', markdown, true, 10);
      await new Promise(r => setTimeout(r, 500));
      const mainResult = await testPerformance('è¶…é•¿æ–‡æœ¬', markdown, false, 10);

      testResults.push({ worker: workerResult, main: mainResult });
      updateResults();
    }

    async function testStreamingUpdates() {
      log('========================================', 'info');
      log('æµ‹è¯•åœºæ™¯: æµå¼æ›´æ–° (100æ¬¡å°æ›´æ–°)', 'info');
      log('========================================', 'info');

      let cumulativeText = '';
      const updates = 100;
      const updateSize = 500;

      const workerTimes = [];
      const mainTimes = [];

      for (let i = 0; i < updates; i++) {
        cumulativeText += generateMarkdown(updateSize);

        // Worker æ¨¡å¼
        const workerStart = performance.now();
        await window.markdownWorkerPool.parse(cumulativeText);
        workerTimes.push(performance.now() - workerStart);

        // ä¸»çº¿ç¨‹æ¨¡å¼
        const mainStart = performance.now();
        marked.parse(cumulativeText);
        mainTimes.push(performance.now() - mainStart);

        if (i % 20 === 0) {
          log(`æµå¼æ›´æ–°è¿›åº¦: ${i}/${updates}`, 'info');
        }
      }

      const workerResult = {
        testName: 'æµå¼æ›´æ–°',
        mode: 'Worker',
        textLength: cumulativeText.length,
        rounds: updates,
        avgTime: workerTimes.reduce((a, b) => a + b, 0) / workerTimes.length,
        minTime: Math.min(...workerTimes),
        maxTime: Math.max(...workerTimes),
        totalTime: workerTimes.reduce((a, b) => a + b, 0)
      };

      const mainResult = {
        testName: 'æµå¼æ›´æ–°',
        mode: 'MainThread',
        textLength: cumulativeText.length,
        rounds: updates,
        avgTime: mainTimes.reduce((a, b) => a + b, 0) / mainTimes.length,
        minTime: Math.min(...mainTimes),
        maxTime: Math.max(...mainTimes),
        totalTime: mainTimes.reduce((a, b) => a + b, 0)
      };

      testResults.push({ worker: workerResult, main: mainResult });
      updateResults();
      log('æµå¼æ›´æ–°æµ‹è¯•å®Œæˆ', 'success');
    }

    async function testBatchProcessing() {
      log('========================================', 'info');
      log('æµ‹è¯•åœºæ™¯: æ‰¹é‡å¤„ç† (10ä¸ªå¤§æ–‡æ¡£)', 'info');
      log('========================================', 'info');

      const docs = [];
      for (let i = 0; i < 10; i++) {
        docs.push(generateMarkdown(20000));
      }

      // Worker å¹¶è¡Œå¤„ç†
      const workerStart = performance.now();
      await Promise.all(docs.map(doc => window.markdownWorkerPool.parse(doc)));
      const workerTime = performance.now() - workerStart;

      // ä¸»çº¿ç¨‹ä¸²è¡Œå¤„ç†
      const mainStart = performance.now();
      docs.forEach(doc => marked.parse(doc));
      const mainTime = performance.now() - mainStart;

      const workerResult = {
        testName: 'æ‰¹é‡å¤„ç†',
        mode: 'Worker',
        textLength: docs[0].length,
        rounds: docs.length,
        avgTime: workerTime / docs.length,
        totalTime: workerTime
      };

      const mainResult = {
        testName: 'æ‰¹é‡å¤„ç†',
        mode: 'MainThread',
        textLength: docs[0].length,
        rounds: docs.length,
        avgTime: mainTime / docs.length,
        totalTime: mainTime
      };

      testResults.push({ worker: workerResult, main: mainResult });
      updateResults();
      log(`æ‰¹é‡å¤„ç†å®Œæˆ: Worker ${workerTime.toFixed(0)}ms vs ä¸»çº¿ç¨‹ ${mainTime.toFixed(0)}ms`, 'success');
    }

    async function runAllTests() {
      testResults = [];
      clearResults();

      await testSuperLongText();
      await new Promise(r => setTimeout(r, 1000));
      await testStreamingUpdates();
      await new Promise(r => setTimeout(r, 1000));
      await testBatchProcessing();

      log('========================================', 'success');
      log('æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success');
      log('========================================', 'success');

      displayWorkerPoolStats();
    }

    function updateResults() {
      const grid = document.getElementById('results-grid');
      grid.innerHTML = '';

      testResults.forEach(({ worker, main }) => {
        const improvement = ((main.avgTime - worker.avgTime) / main.avgTime * 100);
        const isFaster = improvement > 0;

        const card = document.createElement('div');
        card.className = 'test-card';
        card.innerHTML = `
          <h3>${worker.testName}</h3>
          <div class="metric">
            <span>æ–‡æœ¬é•¿åº¦:</span>
            <span>${(worker.textLength / 1000).toFixed(1)}k å­—ç¬¦</span>
          </div>
          <div class="metric ${isFaster ? 'highlight' : 'warning'}">
            <span>æ€§èƒ½æå‡:</span>
            <span>${isFaster ? 'âœ…' : 'âš ï¸'} ${improvement.toFixed(1)}%</span>
          </div>
          <table class="comparison-table">
            <tr>
              <th>æ¨¡å¼</th>
              <th>å¹³å‡è€—æ—¶</th>
              <th>æ€»è€—æ—¶</th>
            </tr>
            <tr class="${isFaster ? 'winner' : 'loser'}">
              <td>Worker</td>
              <td>${worker.avgTime.toFixed(2)} ms</td>
              <td>${worker.totalTime.toFixed(0)} ms</td>
            </tr>
            <tr class="${!isFaster ? 'winner' : 'loser'}">
              <td>ä¸»çº¿ç¨‹</td>
              <td>${main.avgTime.toFixed(2)} ms</td>
              <td>${main.totalTime.toFixed(0)} ms</td>
            </tr>
          </table>
        `;
        grid.appendChild(card);
      });

      updateChart();
    }

    function updateChart() {
      const chart = document.getElementById('chart-area');
      chart.innerHTML = '';

      testResults.forEach(({ worker, main }) => {
        const maxTime = Math.max(worker.avgTime, main.avgTime);

        const row = document.createElement('div');
        row.className = 'bar-row';

        const workerPercent = (worker.avgTime / maxTime) * 100;
        const mainPercent = (main.avgTime / maxTime) * 100;
        const isFaster = worker.avgTime < main.avgTime;

        row.innerHTML = `
          <div class="bar-label">${worker.testName}</div>
          <div class="bar-track">
            <div class="bar-fill ${isFaster ? '' : 'slow'}" style="width: ${workerPercent}%">
              Worker: ${worker.avgTime.toFixed(1)}ms
            </div>
          </div>
          <div class="bar-track">
            <div class="bar-fill ${!isFaster ? '' : 'slow'}" style="width: ${mainPercent}%">
              ä¸»çº¿ç¨‹: ${main.avgTime.toFixed(1)}ms
            </div>
          </div>
        `;

        chart.appendChild(row);
      });
    }

    function displayWorkerPoolStats() {
      const stats = window.markdownWorkerPool.getStats();
      log('========================================', 'info');
      log('Worker Pool ç»Ÿè®¡ä¿¡æ¯:', 'info');
      log(`  æ± å¤§å°: ${stats.poolSize}`, 'info');
      log(`  å·²å®Œæˆ: ${stats.tasksCompleted}`, 'info');
      log(`  å¤±è´¥: ${stats.tasksFailed}`, 'info');
      log(`  é™çº§: ${stats.tasksFallback}`, 'info');
      log(`  å¹³å‡ Worker è€—æ—¶: ${stats.avgWorkerTime.toFixed(2)} ms`, 'info');
      log(`  å¹³å‡ä¸»çº¿ç¨‹è€—æ—¶: ${stats.avgMainThreadTime.toFixed(2)} ms`, 'info');
      log('========================================', 'info');
    }

    function clearResults() {
      document.getElementById('results-grid').innerHTML = '';
      document.getElementById('chart-area').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">è¿è¡Œæµ‹è¯•åå°†æ˜¾ç¤ºå›¾è¡¨...</p>';
      document.getElementById('console-log').innerHTML = 'ç­‰å¾…æµ‹è¯•...\n';
    }

    window.addEventListener('load', function() {
      log('é¡µé¢åŠ è½½å®Œæˆ', 'success');
      log(`Worker Pool å·²åˆå§‹åŒ–ï¼Œæ± å¤§å°: ${window.markdownWorkerPool.config.poolSize}`, 'info');
      log(`å½“å‰é…ç½® minTextLength: ${window.markdownWorkerPool.config.minTextLength} å­—ç¬¦`, 'info');
    });
  </script>
</body>
</html>
