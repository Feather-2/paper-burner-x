<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>KaTeX æ¸è¿›å¼æ¸²æŸ“æ€§èƒ½æµ‹è¯•</title>
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    .test-controls {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    button {
      padding: 12px 24px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
    .btn-secondary {
      background: #48bb78;
      color: white;
    }
    .btn-secondary:hover {
      background: #38a169;
    }
    .btn-danger {
      background: #f56565;
      color: white;
    }
    .btn-danger:hover {
      background: #e53e3e;
    }
    .results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .metric-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metric-card h3 {
      margin-top: 0;
      color: #2d3748;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .metric-value {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
    }
    .metric-good { color: #48bb78; }
    .metric-warning { color: #ed8936; }
    .metric-bad { color: #f56565; }
    .metric-info { color: #667eea; }
    .comparison {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .render-output {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      min-height: 200px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .log {
      background: #2d3748;
      color: #a0aec0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-entry {
      margin: 4px 0;
      padding: 2px 0;
    }
    .log-info { color: #63b3ed; }
    .log-success { color: #68d391; }
    .log-warning { color: #f6ad55; }
    .log-error { color: #fc8181; }
    .katex-placeholder {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .progress-bar {
      width: 100%;
      height: 24px;
      background: #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>âš¡ KaTeX æ¸è¿›å¼æ¸²æŸ“æ€§èƒ½æµ‹è¯•</h1>
    <p>æµ‹è¯•ç›®æ ‡ï¼šé¦–æ¬¡å¯è§å†…å®¹ &lt; 300msï¼Œç”¨æˆ·æ„ŸçŸ¥é€Ÿåº¦æå‡ 10 å€</p>
  </div>

  <div class="test-controls">
    <h2>æµ‹è¯•æ§åˆ¶</h2>
    <div class="button-group">
      <button class="btn-primary" onclick="testProgressive()">ğŸš€ æµ‹è¯•æ¸è¿›å¼æ¸²æŸ“</button>
      <button class="btn-secondary" onclick="testTraditional()">ğŸŒ æµ‹è¯•ä¼ ç»Ÿæ¸²æŸ“</button>
      <button class="btn-danger" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
    </div>
    <div>
      <label>
        <input type="checkbox" id="useRealMessage" checked>
        ä½¿ç”¨çœŸå®å¤æ‚æ¶ˆæ¯ï¼ˆ15+ å…¬å¼ + è¡¨æ ¼ï¼‰
      </label>
    </div>
  </div>

  <div class="results">
    <div class="metric-card">
      <h3>é¦–æ¬¡å¯è§æ—¶é—´</h3>
      <div class="metric-value metric-info" id="firstVisibleTime">--</div>
      <small>ç›®æ ‡: &lt; 300ms</small>
    </div>
    <div class="metric-card">
      <h3>å…¨éƒ¨å…¬å¼æ¸²æŸ“å®Œæˆ</h3>
      <div class="metric-value metric-info" id="allFormulasTime">--</div>
      <small>æ€»æ¸²æŸ“æ—¶é—´</small>
    </div>
    <div class="metric-card">
      <h3>å…¬å¼æ•°é‡</h3>
      <div class="metric-value metric-info" id="formulaCount">--</div>
      <small>æ€»è®¡</small>
    </div>
    <div class="metric-card">
      <h3>æ€§èƒ½æå‡</h3>
      <div class="metric-value metric-good" id="improvement">--</div>
      <small>ç›¸æ¯”ä¼ ç»Ÿæ¸²æŸ“</small>
    </div>
  </div>

  <div class="comparison">
    <h3>æ¸²æŸ“è¿›åº¦</h3>
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar" style="width: 0%;">0%</div>
    </div>
    <div id="progressText" style="margin-top: 10px; color: #718096;">ç­‰å¾…æµ‹è¯•...</div>
  </div>

  <div class="render-output">
    <h3>æ¸²æŸ“è¾“å‡ºé¢„è§ˆ</h3>
    <div id="renderOutput"></div>
  </div>

  <div class="log" id="logOutput"></div>

  <!-- ä¾èµ–åº“ -->
  <script src="https://gcore.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <!-- åŠ è½½æµ‹è¯•æ‰€éœ€çš„æ¨¡å— -->
  <script src="../../js/chatbot/utils/safe-markdown-render.js"></script>
  <script src="../../js/chatbot/utils/katex-cache.js"></script>
  <script src="../../js/chatbot/utils/markdown-katex-render-cached.js"></script>
  <script src="../../js/chatbot/utils/katex-progressive-render.js"></script>

  <script>
    // é…ç½® marked.js
    if (typeof marked !== 'undefined') {
      marked.setOptions({
        gfm: true,
        breaks: true,
        pedantic: false,
        sanitize: false,
        smartLists: false,
        smartypants: false,
        mangle: false,
        headerIds: false
      });
    }

    // æµ‹è¯•æ•°æ®ï¼šçœŸå®çš„å¤æ‚æ¶ˆæ¯
    const REAL_COMPLEX_MESSAGE = `# Fama-MacBeth å›å½’åˆ†ææ€»ç»“

## ä¸€ã€æ–¹æ³•è®ºæ¦‚è¿°

Fama-MacBeth å›å½’æ˜¯ä¸€ç§**ä¸¤æ­¥å›å½’æ–¹æ³•**ï¼Œä¸»è¦ç”¨äºé¢æ¿æ•°æ®åˆ†æï¼š

1. **ç¬¬ä¸€æ­¥ï¼ˆæ—¶é—´åºåˆ—å›å½’ï¼‰**ï¼šå¯¹æ¯ä¸ªæ—¶é—´ç‚¹ $t$ è¿›è¡Œæ¨ªæˆªé¢å›å½’
   $$r_{i,t} = \\alpha_t + \\beta_t X_{i,t} + \\varepsilon_{i,t}$$

2. **ç¬¬äºŒæ­¥ï¼ˆæ¨ªæˆªé¢å¹³å‡ï¼‰**ï¼šè®¡ç®—ç³»æ•°çš„æ—¶é—´åºåˆ—å‡å€¼å’Œ t ç»Ÿè®¡é‡
   $$\\bar{\\beta} = \\frac{1}{T}\\sum_{t=1}^{T}\\beta_t$$

## äºŒã€å…³é”®å‡è®¾

### 2.1 åŸºæœ¬å‡è®¾

| å‡è®¾ | æè¿° | é‡è¦æ€§ |
|------|------|--------|
| ç‹¬ç«‹åŒåˆ†å¸ƒ | æ¨ªæˆªé¢è¯¯å·®é¡¹ç‹¬ç«‹ | â­â­â­ |
| æ—¶é—´ç¨³å®šæ€§ | ç³»æ•°éšæ—¶é—´ç¨³å®š | â­â­â­ |
| æ— è‡ªç›¸å…³ | æ—¶é—´åºåˆ—æ— ç›¸å…³æ€§ | â­â­ |

### 2.2 æ•°å­¦è¡¨è¾¾

è¯¯å·®é¡¹çš„åæ–¹å·®çŸ©é˜µï¼š

$$\\text{Var}(\\varepsilon_t) = \\sigma^2 I_N$$

å…¶ä¸­ $I_N$ æ˜¯ $N \\times N$ å•ä½çŸ©é˜µã€‚

## ä¸‰ã€ç»Ÿè®¡æ¨æ–­

### 3.1 æ ‡å‡†è¯¯ä¼°è®¡

ä½¿ç”¨ Newey-West è°ƒæ•´çš„æ ‡å‡†è¯¯ï¼š

$$SE(\\bar{\\beta}) = \\sqrt{\\frac{1}{T}\\sum_{t=1}^{T}(\\beta_t - \\bar{\\beta})^2}$$

### 3.2 t ç»Ÿè®¡é‡

$$t = \\frac{\\bar{\\beta}}{SE(\\bar{\\beta})} \\sim t_{T-1}$$

### 3.3 æ˜¾è‘—æ€§æ£€éªŒ

åœ¨æ˜¾è‘—æ€§æ°´å¹³ $\\alpha$ ä¸‹ï¼š
- å¦‚æœ $|t| > t_{\\alpha/2, T-1}$ï¼Œåˆ™æ‹’ç» $H_0: \\beta = 0$
- ä¸´ç•Œå€¼é€šå¸¸ä¸º $t_{0.025, \\infty} \\approx 1.96$ï¼ˆåŒä¾§æ£€éªŒï¼‰

## å››ã€å®è¯åº”ç”¨æ¡ˆä¾‹

### 4.1 CAPM æ£€éªŒ

æ£€éªŒèµ„æœ¬èµ„äº§å®šä»·æ¨¡å‹ï¼š

$$E[r_i] - r_f = \\beta_i (E[r_m] - r_f)$$

å…¶ä¸­ï¼š
- $r_i$ï¼šèµ„äº§ i çš„æ”¶ç›Šç‡
- $r_f$ï¼šæ— é£é™©æ”¶ç›Šç‡
- $r_m$ï¼šå¸‚åœºæ”¶ç›Šç‡
- $\\beta_i = \\frac{\\text{Cov}(r_i, r_m)}{\\text{Var}(r_m)}$

### 4.2 Fama-French ä¸‰å› å­æ¨¡å‹

$$r_{i,t} - r_{f,t} = \\alpha_i + \\beta_{1i}(r_{m,t} - r_{f,t}) + \\beta_{2i}SMB_t + \\beta_{3i}HML_t + \\varepsilon_{i,t}$$

å…¶ä¸­ï¼š
- $SMB_t$ï¼šå°ç›˜è‚¡å‡å¤§ç›˜è‚¡æ”¶ç›Šï¼ˆSize Premiumï¼‰
- $HML_t$ï¼šé«˜è´¦é¢å¸‚å€¼æ¯”å‡ä½è´¦é¢å¸‚å€¼æ¯”æ”¶ç›Šï¼ˆValue Premiumï¼‰

## äº”ã€ä¼˜ç¼ºç‚¹åˆ†æ

### 5.1 ä¼˜ç‚¹

1. **æ§åˆ¶æ¨ªæˆªé¢ç›¸å…³æ€§**ï¼šé€šè¿‡æ—¶é—´å¹³å‡è‡ªåŠ¨æ¶ˆé™¤æ¨ªæˆªé¢ç›¸å…³
2. **ç¨³å¥æ ‡å‡†è¯¯**ï¼šFama-MacBeth æ ‡å‡†è¯¯å¯¹æ¨ªæˆªé¢ç›¸å…³æ€§ç¨³å¥
3. **ç®€å•æ˜“å®ç°**ï¼šè®¡ç®—è¿‡ç¨‹ç›´è§‚ï¼Œæ˜“äºç¼–ç¨‹å®ç°

### 5.2 ç¼ºç‚¹

1. **å‡è®¾ä¸¥æ ¼**ï¼šè¦æ±‚ç³»æ•°æ—¶é—´ç¨³å®šæ€§
2. **æ•ˆç‡æŸå¤±**ï¼šç›¸æ¯”å›ºå®šæ•ˆåº”æ¨¡å‹å¯èƒ½æŸå¤±æ•ˆç‡
3. **æ—¶é—´åºåˆ—ç›¸å…³**ï¼šéœ€è¦å¤„ç†æ—¶é—´åºåˆ—è‡ªç›¸å…³é—®é¢˜

## å…­ã€æ”¹è¿›æ–¹æ³•

### 6.1 Driscoll-Kraay æ ‡å‡†è¯¯

é€‚ç”¨äºé¢æ¿æ•°æ®çš„å¼‚æ–¹å·®å’Œè‡ªç›¸å…³ä¸€è‡´æ€§ï¼ˆHACï¼‰ä¼°è®¡ï¼š

$$\\hat{V}_{DK} = (X'X)^{-1}\\left[\\sum_{j=-q}^{q}w_j\\sum_{t=j+1}^{T}u_t u_{t-j}'\\right](X'X)^{-1}$$

### 6.2 èšç±»ç¨³å¥æ ‡å‡†è¯¯

æŒ‰æ—¶é—´æˆ–ä¸ªä½“èšç±»ï¼š

$$\\hat{V}_{cluster} = (X'X)^{-1}\\left[\\sum_{g=1}^{G}X_g'u_g u_g' X_g\\right](X'X)^{-1}$$

## ä¸ƒã€Python å®ç°ç¤ºä¾‹

\`\`\`python
import numpy as np
import pandas as pd
from scipy import stats

def fama_macbeth_regression(returns, factors):
    """
    Fama-MacBeth ä¸¤æ­¥å›å½’

    å‚æ•°:
    - returns: (T x N) æ”¶ç›Šç‡çŸ©é˜µ
    - factors: (T x K) å› å­çŸ©é˜µ

    è¿”å›:
    - betas: (K,) å› å­é£é™©æº¢ä»·
    - t_stats: (K,) t ç»Ÿè®¡é‡
    """
    T, N = returns.shape
    K = factors.shape[1]

    # ç¬¬ä¸€æ­¥ï¼šæ—¶é—´åºåˆ—å›å½’
    betas_t = np.zeros((T, K))
    for t in range(T):
        # æ¨ªæˆªé¢å›å½’
        X = factors[t].reshape(-1, K)
        y = returns[t]
        betas_t[t] = np.linalg.lstsq(X, y, rcond=None)[0]

    # ç¬¬äºŒæ­¥ï¼šæ¨ªæˆªé¢å¹³å‡
    betas = np.mean(betas_t, axis=0)
    se = np.std(betas_t, axis=0, ddof=1) / np.sqrt(T)
    t_stats = betas / se

    return betas, t_stats

# ç¤ºä¾‹ä½¿ç”¨
np.random.seed(42)
T, N, K = 120, 100, 3
returns = np.random.randn(T, N) * 0.02
factors = np.random.randn(T, K)

betas, t_stats = fama_macbeth_regression(returns, factors)
print(f"å› å­é£é™©æº¢ä»·: {betas}")
print(f"t ç»Ÿè®¡é‡: {t_stats}")
\`\`\`

## å…«ã€æ€»ç»“

Fama-MacBeth å›å½’æ˜¯**èµ„äº§å®šä»·å®è¯ç ”ç©¶çš„æ ‡å‡†å·¥å…·**ï¼Œç‰¹åˆ«é€‚ç”¨äºï¼š

1. æ£€éªŒèµ„äº§å®šä»·æ¨¡å‹ï¼ˆCAPMã€APTã€Fama-French ç­‰ï¼‰
2. ä¼°è®¡é£é™©æº¢ä»·å’Œå› å­è½½è·
3. æ§åˆ¶æ¨ªæˆªé¢ç›¸å…³æ€§çš„é¢æ¿æ•°æ®åˆ†æ

**æ ¸å¿ƒå…¬å¼å›é¡¾**ï¼š

$$\\bar{\\beta} = \\frac{1}{T}\\sum_{t=1}^{T}\\beta_t, \\quad SE(\\bar{\\beta}) = \\sqrt{\\frac{1}{T(T-1)}\\sum_{t=1}^{T}(\\beta_t - \\bar{\\beta})^2}$$

$$t = \\frac{\\bar{\\beta}}{SE(\\bar{\\beta})} \\sim t_{T-1}$$`;

    const SIMPLE_TEST_MESSAGE = `# ç®€å•æµ‹è¯•æ¶ˆæ¯

è¿™æ˜¯ä¸€ä¸ªåŒ…å«å‡ ä¸ªå…¬å¼çš„æµ‹è¯•ï¼š

è¡Œå†…å…¬å¼ï¼š$E = mc^2$ å’Œ $a^2 + b^2 = c^2$

å—çº§å…¬å¼ï¼š

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

$$\\frac{\\partial f}{\\partial x} = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$

æ›´å¤šå†…å®¹...`;

    let logEntries = [];
    let traditionalTime = null;
    let progressiveTime = null;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
      const entry = `[${timestamp}] ${message}`;
      logEntries.push({ message: entry, type });

      const logOutput = document.getElementById('logOutput');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = entry;
      logOutput.appendChild(logEntry);
      logOutput.scrollTop = logOutput.scrollHeight;

      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function updateMetric(id, value, colorClass = 'metric-info') {
      const elem = document.getElementById(id);
      elem.textContent = value;
      elem.className = `metric-value ${colorClass}`;
    }

    function updateProgress(percent, text) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      progressBar.style.width = `${percent}%`;
      progressBar.textContent = `${percent}%`;
      progressText.textContent = text;
    }

    async function testProgressive() {
      log('å¼€å§‹æ¸è¿›å¼æ¸²æŸ“æµ‹è¯•', 'info');
      clearResults();

      const useRealMessage = document.getElementById('useRealMessage').checked;
      const markdown = useRealMessage ? REAL_COMPLEX_MESSAGE : SIMPLE_TEST_MESSAGE;

      updateProgress(10, 'å‡†å¤‡æµ‹è¯•æ•°æ®...');
      await sleep(100);

      // æ¸…ç©ºè¾“å‡ºåŒºåŸŸ
      const renderOutput = document.getElementById('renderOutput');
      renderOutput.innerHTML = '';

      updateProgress(20, 'å¼€å§‹æ¸²æŸ“...');

      // è®°å½•å¼€å§‹æ—¶é—´
      const startTime = performance.now();

      // ä½¿ç”¨æ¸è¿›å¼æ¸²æŸ“
      const html = window.renderWithKatexStreaming(markdown);
      renderOutput.innerHTML = html;

      // è®°å½•é¦–æ¬¡å¯è§æ—¶é—´ï¼ˆMarkdown æ¸²æŸ“å®Œæˆï¼‰
      const firstVisibleTime = performance.now() - startTime;
      updateMetric('firstVisibleTime', `${firstVisibleTime.toFixed(1)}ms`,
        firstVisibleTime < 300 ? 'metric-good' : firstVisibleTime < 500 ? 'metric-warning' : 'metric-bad');
      log(`âœ… é¦–æ¬¡å¯è§: ${firstVisibleTime.toFixed(1)}ms`, 'success');

      updateProgress(50, 'æ–‡æœ¬å†…å®¹å·²å¯è§ï¼Œå…¬å¼æ­£åœ¨åå°æ¸²æŸ“...');

      // ç­‰å¾…æ‰€æœ‰å…¬å¼æ¸²æŸ“å®Œæˆ
      await waitForFormulas();

      const totalTime = performance.now() - startTime;
      const formulaCount = countFormulas(renderOutput);

      updateMetric('allFormulasTime', `${totalTime.toFixed(1)}ms`, 'metric-info');
      updateMetric('formulaCount', formulaCount, 'metric-info');

      log(`âœ… å…¨éƒ¨æ¸²æŸ“å®Œæˆ: ${totalTime.toFixed(1)}ms`, 'success');
      log(`ğŸ“Š å…±æ¸²æŸ“ ${formulaCount} ä¸ªå…¬å¼`, 'info');

      updateProgress(100, `âœ… æ¸²æŸ“å®Œæˆï¼é¦–æ¬¡å¯è§ ${firstVisibleTime.toFixed(1)}msï¼Œæ€»è€—æ—¶ ${totalTime.toFixed(1)}ms`);

      progressiveTime = { first: firstVisibleTime, total: totalTime };
      updateComparison();

      // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
      if (window.getKatexCacheStats) {
        const stats = window.katexCache.getStats();
        log(`ğŸ“ˆ ç¼“å­˜ç»Ÿè®¡: ${stats.hitRate} å‘½ä¸­ç‡, ${stats.hits} å‘½ä¸­, ${stats.misses} æœªå‘½ä¸­`, 'info');
      }
    }

    async function testTraditional() {
      log('å¼€å§‹ä¼ ç»Ÿæ¸²æŸ“æµ‹è¯•ï¼ˆå¯¹ç…§ç»„ï¼‰', 'info');
      clearResults();

      const useRealMessage = document.getElementById('useRealMessage').checked;
      const markdown = useRealMessage ? REAL_COMPLEX_MESSAGE : SIMPLE_TEST_MESSAGE;

      updateProgress(10, 'å‡†å¤‡æµ‹è¯•æ•°æ®...');
      await sleep(100);

      // æ¸…ç©ºè¾“å‡ºåŒºåŸŸ
      const renderOutput = document.getElementById('renderOutput');
      renderOutput.innerHTML = '';

      updateProgress(30, 'ä¼ ç»Ÿæ–¹å¼æ¸²æŸ“ä¸­ï¼ˆé˜»å¡ä¸»çº¿ç¨‹ï¼‰...');

      // è®°å½•å¼€å§‹æ—¶é—´
      const startTime = performance.now();

      // ä¸´æ—¶ç¦ç”¨æ¸è¿›å¼æ¸²æŸ“
      const originalEnable = window.katexProgressiveRenderer ?
        window.PROGRESSIVE_CONFIG?.ENABLE : false;

      if (window.katexProgressiveRenderer) {
        // ç›´æ¥ä½¿ç”¨ä¼ ç»Ÿæ¸²æŸ“
        const cacheRender = window.renderKatexCached || katex.renderToString;

        // ä¿å­˜åŸå§‹å‡½æ•°
        const progressiveRender = window.renderWithKatexStreaming;

        // ä¸´æ—¶ä½¿ç”¨éç¼“å­˜ç‰ˆæœ¬
        window.renderWithKatexStreaming = function(md) {
          // ä½¿ç”¨ä¼ ç»ŸåŒæ­¥æ¸²æŸ“æ‰€æœ‰å…¬å¼
          md = md.replace(/\$\$([\s\S]+?)\$\$/g, function(_, tex) {
            try {
              const html = katex.renderToString(tex.trim(), {
                displayMode: true,
                output: 'html',
                strict: 'ignore',
                throwOnError: false
              });
              return `<div class="katex-block">${html}</div>`;
            } catch (e) {
              return `<pre>${tex}</pre>`;
            }
          });

          md = md.replace(/\$([^\$]+?)\$/g, function(_, tex) {
            try {
              const html = katex.renderToString(tex.trim(), {
                displayMode: false,
                output: 'html',
                strict: 'ignore',
                throwOnError: false
              });
              return `<span class="katex-inline">${html}</span>`;
            } catch (e) {
              return tex;
            }
          });

          return marked.parse(md);
        };

        const html = window.renderWithKatexStreaming(markdown);
        renderOutput.innerHTML = html;

        // æ¢å¤åŸå§‹å‡½æ•°
        window.renderWithKatexStreaming = progressiveRender;
      }

      const totalTime = performance.now() - startTime;
      const formulaCount = countFormulas(renderOutput);

      updateMetric('firstVisibleTime', `${totalTime.toFixed(1)}ms`,
        totalTime < 300 ? 'metric-good' : totalTime < 500 ? 'metric-warning' : 'metric-bad');
      updateMetric('allFormulasTime', `${totalTime.toFixed(1)}ms`, 'metric-info');
      updateMetric('formulaCount', formulaCount, 'metric-info');

      log(`â±ï¸ ä¼ ç»Ÿæ¸²æŸ“å®Œæˆ: ${totalTime.toFixed(1)}msï¼ˆé˜»å¡ä¸»çº¿ç¨‹ï¼‰`, 'warning');
      log(`ğŸ“Š å…±æ¸²æŸ“ ${formulaCount} ä¸ªå…¬å¼`, 'info');

      updateProgress(100, `å®Œæˆï¼æ€»è€—æ—¶ ${totalTime.toFixed(1)}msï¼ˆä¸»çº¿ç¨‹é˜»å¡ï¼‰`);

      traditionalTime = { first: totalTime, total: totalTime };
      updateComparison();
    }

    async function waitForFormulas() {
      return new Promise((resolve) => {
        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å ä½ç¬¦
        const checkInterval = setInterval(() => {
          const placeholders = document.querySelectorAll('.katex-placeholder');
          if (placeholders.length === 0) {
            clearInterval(checkInterval);
            resolve();
          }
        }, 100);

        // æœ€å¤šç­‰å¾… 10 ç§’
        setTimeout(() => {
          clearInterval(checkInterval);
          resolve();
        }, 10000);
      });
    }

    function countFormulas(container) {
      const blocks = container.querySelectorAll('.katex-block, .katex-inline');
      return blocks.length;
    }

    function updateComparison() {
      if (progressiveTime && traditionalTime) {
        const improvement = ((traditionalTime.first - progressiveTime.first) / traditionalTime.first * 100);
        const improvementText = improvement > 0 ? `${improvement.toFixed(1)}%` : '0%';
        updateMetric('improvement', improvementText, improvement > 50 ? 'metric-good' : 'metric-warning');

        log(`ğŸ¯ æ€§èƒ½æå‡: ${improvementText} (${traditionalTime.first.toFixed(1)}ms â†’ ${progressiveTime.first.toFixed(1)}ms)`, 'success');
      }
    }

    function clearResults() {
      document.getElementById('renderOutput').innerHTML = '';
      updateMetric('firstVisibleTime', '--', 'metric-info');
      updateMetric('allFormulasTime', '--', 'metric-info');
      updateMetric('formulaCount', '--', 'metric-info');
      updateMetric('improvement', '--', 'metric-info');
      updateProgress(0, 'ç­‰å¾…æµ‹è¯•...');

      logEntries = [];
      document.getElementById('logOutput').innerHTML = '';
      log('æµ‹è¯•ç»“æœå·²æ¸…é™¤', 'info');
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // åˆå§‹åŒ–
    log('ğŸš€ KaTeX æ¸è¿›å¼æ¸²æŸ“æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
    log('ğŸ’¡ æç¤º: ç‚¹å‡»"æµ‹è¯•æ¸è¿›å¼æ¸²æŸ“"æŸ¥çœ‹ä¼˜åŒ–æ•ˆæœ', 'info');
    log(`ğŸ“¦ æ¸è¿›å¼æ¸²æŸ“å·²${window.katexProgressiveRenderer ? 'å¯ç”¨' : 'ç¦ç”¨'}`,
      window.katexProgressiveRenderer ? 'success' : 'warning');
  </script>
</body>
</html>
