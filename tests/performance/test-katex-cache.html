<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KaTeX ç¼“å­˜æ€§èƒ½æµ‹è¯• - Phase 4.2+</title>
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 { margin-bottom: 12px; color: #333; }

    .warning-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
    }

    .success-box {
      background: #d4edda;
      border: 2px solid #28a745;
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
    }

    .success-box h3 {
      color: #155724;
      margin-bottom: 8px;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary { background: #4CAF50; color: white; }
    .btn-primary:hover { background: #45a049; }
    .btn-secondary { background: #2196F3; color: white; }
    .btn-secondary:hover { background: #0b7dda; }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .test-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .test-card h3 {
      margin-bottom: 12px;
      color: #333;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      padding: 10px 12px;
      margin: 8px 0;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 14px;
    }

    .metric.highlight {
      background: #e8f5e9;
      border-left: 4px solid #4CAF50;
      font-weight: 600;
    }

    .metric.warning {
      background: #ffebee;
      border-left: 4px solid #f44336;
    }

    .huge-improvement {
      font-size: 32px;
      font-weight: bold;
      color: #2e7d32;
      text-align: center;
      margin: 20px 0;
    }

    .formulas-preview {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .console-log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .console-log .success { color: #81c784; }
    .console-log .warning { color: #ffb74d; }
    .console-log .info { color: #4fc3f7; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš€ Phase 4.2+ KaTeX å…¬å¼ç¼“å­˜æ€§èƒ½æµ‹è¯•</h1>
      <p>æµ‹è¯•ç¼“å­˜å¯¹å…¬å¼æ¸²æŸ“æ€§èƒ½çš„å½±å“ï¼ˆé’ˆå¯¹ 4.6s é˜»å¡é—®é¢˜ï¼‰</p>

      <div class="warning-box">
        <h3>âš ï¸ æµ‹è¯•åœºæ™¯</h3>
        <p><strong>é—®é¢˜ï¼š</strong> æ‰“å¼€å……æ»¡å…¬å¼çš„ chatbot æ—¶ï¼ŒKaTeX æ¸²æŸ“é˜»å¡ä¸»çº¿ç¨‹ 4.6 ç§’</p>
        <p><strong>ä¼˜åŒ–ï¼š</strong> ä½¿ç”¨ LRU ç¼“å­˜é¿å…é‡å¤å…¬å¼çš„é‡æ–°æ¸²æŸ“</p>
        <p><strong>é¢„æœŸæ”¶ç›Šï¼š</strong> ç¼“å­˜å‘½ä¸­æ—¶æ¸²æŸ“æ—¶é—´å‡å°‘ 99%ï¼ˆä» 50ms é™è‡³ 0.5msï¼‰</p>
      </div>

      <div class="controls">
        <button class="btn-primary" onclick="runTest(50)">æµ‹è¯• 50 ä¸ªå…¬å¼</button>
        <button class="btn-primary" onclick="runTest(100)">æµ‹è¯• 100 ä¸ªå…¬å¼</button>
        <button class="btn-secondary" onclick="viewCacheStats()">æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡</button>
        <button class="btn-secondary" onclick="clearCache()">æ¸…ç©ºç¼“å­˜</button>
      </div>
    </div>

    <div class="comparison" id="results-area"></div>

    <div class="formulas-preview">
      <h2>ğŸ“ æµ‹è¯•å…¬å¼é¢„è§ˆ</h2>
      <div id="formulas-preview"></div>
    </div>

    <div class="test-card">
      <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
      <div id="console-log" class="console-log">ç­‰å¾…æµ‹è¯•...</div>
    </div>
  </div>

  <!-- åŠ è½½ä¾èµ– -->
  <script src="https://gcore.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="../../js/chatbot/utils/katex-cache.js"></script>

  <script>
    // æµ‹è¯•å…¬å¼é›†åˆ
    const TEST_FORMULAS = [
      'E = mc^2',
      '\\int_{0}^{\\infty} e^{-x^2} dx = \\frac{\\sqrt{\\pi}}{2}',
      '\\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6}',
      'x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}',
      'f(x) = \\frac{1}{\\sigma\\sqrt{2\\pi}} e^{-\\frac{(x-\\mu)^2}{2\\sigma^2}}',
      '\\nabla \\times \\vec{E} = -\\frac{\\partial \\vec{B}}{\\partial t}',
      '\\lim_{n \\to \\infty} \\left(1 + \\frac{1}{n}\\right)^n = e',
      '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\end{pmatrix} = \\begin{pmatrix} ax+by \\\\ cx+dy \\end{pmatrix}',
      'P(A|B) = \\frac{P(B|A)P(A)}{P(B)}',
      '\\oint_{\\partial S} \\vec{E} \\cdot d\\vec{l} = -\\frac{d}{dt}\\int_S \\vec{B} \\cdot d\\vec{A}'
    ];

    function log(message, type = 'info') {
      const logEl = document.getElementById('console-log');
      const timestamp = new Date().toLocaleTimeString();
      logEl.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // æµ‹è¯•æ— ç¼“å­˜æ¸²æŸ“
    async function testWithoutCache(formulas, rounds = 3) {
      log('å¼€å§‹æµ‹è¯•ï¼šæ— ç¼“å­˜æ¸²æŸ“', 'info');

      const times = [];

      for (let round = 0; round < rounds; round++) {
        const roundStart = performance.now();

        formulas.forEach(tex => {
          katex.renderToString(tex, {
            displayMode: true,
            output: 'html',
            strict: 'ignore',
            throwOnError: false
          });
        });

        times.push(performance.now() - roundStart);
      }

      const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
      log(`æ— ç¼“å­˜å®Œæˆ: å¹³å‡ ${avgTime.toFixed(0)} ms`, 'success');

      return {
        avgTime,
        minTime: Math.min(...times),
        maxTime: Math.max(...times),
        totalRenders: formulas.length * rounds
      };
    }

    // æµ‹è¯•ç¼“å­˜æ¸²æŸ“
    async function testWithCache(formulas, rounds = 3) {
      log('å¼€å§‹æµ‹è¯•ï¼šç¼“å­˜æ¸²æŸ“', 'info');

      // ç¬¬ä¸€è½®ï¼šç¼“å­˜æœªå‘½ä¸­
      const firstRoundStart = performance.now();
      formulas.forEach(tex => {
        window.renderKatexCached(tex, {
          displayMode: true,
          output: 'html',
          strict: 'ignore',
          throwOnError: false
        });
      });
      const firstRoundTime = performance.now() - firstRoundStart;
      log(`ç¬¬ä¸€è½®ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰: ${firstRoundTime.toFixed(0)} ms`, 'info');

      // åç»­è½®æ¬¡ï¼šç¼“å­˜å‘½ä¸­
      const times = [];
      for (let round = 0; round < rounds - 1; round++) {
        const roundStart = performance.now();

        formulas.forEach(tex => {
          window.renderKatexCached(tex, {
            displayMode: true,
            output: 'html',
            strict: 'ignore',
            throwOnError: false
          });
        });

        times.push(performance.now() - roundStart);
      }

      const avgCachedTime = times.reduce((a, b) => a + b, 0) / times.length;
      log(`åç»­è½®æ¬¡ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰: å¹³å‡ ${avgCachedTime.toFixed(2)} ms`, 'success');

      return {
        firstRoundTime,
        avgCachedTime,
        minTime: Math.min(...times),
        maxTime: Math.max(...times),
        totalRenders: formulas.length * rounds
      };
    }

    // è¿è¡Œæµ‹è¯•
    async function runTest(formulaCount) {
      log('========================================', 'info');
      log(`å¼€å§‹æµ‹è¯•ï¼š${formulaCount} ä¸ªå…¬å¼ï¼Œæ¯ä¸ªæ¸²æŸ“ 3 æ¬¡`, 'info');
      log('========================================', 'info');

      // å‡†å¤‡æµ‹è¯•å…¬å¼ï¼ˆé‡å¤ä½¿ç”¨åŸºç¡€å…¬å¼ï¼‰
      const formulas = [];
      for (let i = 0; i < formulaCount; i++) {
        formulas.push(TEST_FORMULAS[i % TEST_FORMULAS.length]);
      }

      // æ¸…ç©ºç¼“å­˜
      window.katexCache.clear();

      // æµ‹è¯•æ— ç¼“å­˜
      const noCacheResult = await testWithoutCache(formulas, 3);

      // ç­‰å¾…ä¸€ä¸‹
      await new Promise(r => setTimeout(r, 500));

      // æµ‹è¯•ç¼“å­˜
      const cacheResult = await testWithCache(formulas, 3);

      // æ˜¾ç¤ºç»“æœ
      displayResults(noCacheResult, cacheResult, formulaCount);

      // æ˜¾ç¤ºå…¬å¼é¢„è§ˆ
      displayFormulas(formulas.slice(0, 10));

      log('========================================', 'success');
      log('æµ‹è¯•å®Œæˆï¼', 'success');
      log('========================================', 'success');
    }

    // æ˜¾ç¤ºç»“æœ
    function displayResults(noCacheResult, cacheResult, formulaCount) {
      const improvement = ((noCacheResult.avgTime - cacheResult.avgCachedTime) / noCacheResult.avgTime * 100);

      const html = `
        <div class="test-card">
          <h3>â±ï¸ æ— ç¼“å­˜æ¸²æŸ“</h3>
          <div class="metric warning">
            <span>å¹³å‡è€—æ—¶:</span>
            <span><strong>${noCacheResult.avgTime.toFixed(0)} ms</strong></span>
          </div>
          <div class="metric">
            <span>æœ€å°è€—æ—¶:</span>
            <span>${noCacheResult.minTime.toFixed(0)} ms</span>
          </div>
          <div class="metric">
            <span>æœ€å¤§è€—æ—¶:</span>
            <span>${noCacheResult.maxTime.toFixed(0)} ms</span>
          </div>
          <div class="metric">
            <span>æ€»æ¸²æŸ“æ•°:</span>
            <span>${noCacheResult.totalRenders} æ¬¡</span>
          </div>
        </div>

        <div class="test-card">
          <h3>âš¡ ç¼“å­˜æ¸²æŸ“</h3>
          <div class="metric highlight">
            <span>ç¼“å­˜å‘½ä¸­è€—æ—¶:</span>
            <span><strong>${cacheResult.avgCachedTime.toFixed(2)} ms</strong></span>
          </div>
          <div class="metric">
            <span>é¦–æ¬¡æœªå‘½ä¸­:</span>
            <span>${cacheResult.firstRoundTime.toFixed(0)} ms</span>
          </div>
          <div class="metric highlight">
            <span>æ€§èƒ½æå‡:</span>
            <span><strong>â†‘ ${improvement.toFixed(1)}%</strong></span>
          </div>
          <div class="metric highlight">
            <span>é€Ÿåº¦å€æ•°:</span>
            <span><strong>${(noCacheResult.avgTime / cacheResult.avgCachedTime).toFixed(0)}x æ›´å¿«</strong></span>
          </div>

          <div class="huge-improvement">
            ğŸš€ ${improvement.toFixed(0)}% æ€§èƒ½æå‡ï¼
          </div>

          <div class="success-box">
            <h3>âœ… å®é™…åº”ç”¨åœºæ™¯</h3>
            <p>å¦‚æœä½ çš„ chatbot æœ‰ ${formulaCount} ä¸ªå…¬å¼ï¼š</p>
            <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
              <li><strong>æ— ç¼“å­˜ï¼š</strong> æ¯æ¬¡æ‰“å¼€éœ€è¦ ${noCacheResult.avgTime.toFixed(0)} ms</li>
              <li><strong>æœ‰ç¼“å­˜ï¼š</strong> ç¬¬äºŒæ¬¡æ‰“å¼€åªéœ€ <strong>${cacheResult.avgCachedTime.toFixed(2)} ms</strong></li>
              <li><strong>èŠ‚çœæ—¶é—´ï¼š</strong> <strong>${(noCacheResult.avgTime - cacheResult.avgCachedTime).toFixed(0)} ms</strong></li>
            </ul>
          </div>
        </div>
      `;

      document.getElementById('results-area').innerHTML = html;
    }

    // æ˜¾ç¤ºå…¬å¼é¢„è§ˆ
    function displayFormulas(formulas) {
      const preview = document.getElementById('formulas-preview');
      preview.innerHTML = '<p style="margin-bottom: 12px; color: #666;">æµ‹è¯•å…¬å¼ç¤ºä¾‹ï¼ˆä»…æ˜¾ç¤ºå‰ 10 ä¸ªï¼‰ï¼š</p>';

      formulas.forEach((tex, index) => {
        const div = document.createElement('div');
        div.style.margin = '12px 0';
        div.style.padding = '12px';
        div.style.background = '#f8f9fa';
        div.style.borderRadius = '4px';

        try {
          const html = window.renderKatexCached(tex, {
            displayMode: true,
            output: 'html',
            strict: 'ignore',
            throwOnError: false
          });
          div.innerHTML = `<div style="color: #666; font-size: 12px; margin-bottom: 4px;">å…¬å¼ ${index + 1}</div>${html}`;
        } catch (e) {
          div.textContent = `å…¬å¼ ${index + 1}: æ¸²æŸ“å¤±è´¥`;
        }

        preview.appendChild(div);
      });
    }

    // æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
    function viewCacheStats() {
      window.getKatexCacheStats();
    }

    // æ¸…ç©ºç¼“å­˜
    function clearCache() {
      window.katexCache.clear();
      log('ç¼“å­˜å·²æ¸…ç©º', 'warning');
      alert('ç¼“å­˜å·²æ¸…ç©ºï¼');
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('load', function() {
      log('é¡µé¢åŠ è½½å®Œæˆ', 'success');
      log('KaTeX ç¼“å­˜ç³»ç»Ÿå·²å°±ç»ª', 'info');
      log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
    });
  </script>
</body>
</html>
