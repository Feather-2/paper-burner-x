<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown Worker æ€§èƒ½æµ‹è¯• - Phase 5.1.2</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      margin-bottom: 12px;
      color: #333;
    }

    .info-box {
      background: #e3f2fd;
      border: 1px solid #2196F3;
      border-radius: 4px;
      padding: 16px;
      margin: 16px 0;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-secondary {
      background: #2196F3;
      color: white;
    }

    .btn-secondary:hover {
      background: #0b7dda;
    }

    .btn-warning {
      background: #ff9800;
      color: white;
    }

    .btn-warning:hover {
      background: #e68900;
    }

    .test-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .test-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .test-panel h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #333;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      margin: 6px 0;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .metric.highlight {
      background: #e8f5e9;
      border-left: 4px solid #4CAF50;
      font-weight: 600;
    }

    .progress {
      margin: 12px 0;
    }

    .progress-bar {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #4CAF50;
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }

    .results {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .comparison-table th,
    .comparison-table td {
      padding: 12px;
      text-align: left;
      border: 1px solid #e0e0e0;
    }

    .comparison-table th {
      background: #f5f5f5;
      font-weight: 600;
    }

    .winner {
      background: #e8f5e9 !important;
      font-weight: bold;
      color: #2e7d32;
    }

    .console-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .console-output .info { color: #4fc3f7; }
    .console-output .success { color: #81c784; }
    .console-output .warning { color: #ffb74d; }
    .console-output .error { color: #e57373; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš€ Phase 5.1.2 - Markdown Worker æ€§èƒ½æµ‹è¯•</h1>
      <p>å¯¹æ¯” Web Worker å¤šçº¿ç¨‹è§£æ vs. ä¸»çº¿ç¨‹è§£æçš„æ€§èƒ½å·®å¼‚</p>

      <div class="info-box">
        <strong>æµ‹è¯•è¯´æ˜ï¼š</strong>
        <ul style="margin: 8px 0 0 20px;">
          <li>æµ‹è¯•ä¸åŒé•¿åº¦çš„ Markdown æ–‡æœ¬è§£ææ€§èƒ½</li>
          <li>å¯¹æ¯” Worker æ± å’Œä¸»çº¿ç¨‹çš„æ€§èƒ½æŒ‡æ ‡</li>
          <li>éªŒè¯æµå¼æ›´æ–°åœºæ™¯çš„æµç•…åº¦</li>
          <li>æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†æ—¥å¿—</li>
        </ul>
      </div>

      <div class="controls">
        <button class="btn-primary" onclick="runAllTests()">ğŸ”¬ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button class="btn-secondary" onclick="runShortTextTest()">æµ‹è¯•çŸ­æ–‡æœ¬ (500å­—)</button>
        <button class="btn-secondary" onclick="runMediumTextTest()">æµ‹è¯•ä¸­æ–‡æœ¬ (5000å­—)</button>
        <button class="btn-secondary" onclick="runLongTextTest()">æµ‹è¯•é•¿æ–‡æœ¬ (20000å­—)</button>
        <button class="btn-warning" onclick="viewStats()">ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡</button>
      </div>
    </div>

    <div class="test-grid">
      <div class="test-panel">
        <h2>ğŸ”µ Web Worker æ¨¡å¼</h2>
        <div id="worker-status" class="metric">çŠ¶æ€ï¼šç­‰å¾…æµ‹è¯•</div>
        <div class="progress">
          <div class="progress-bar">
            <div class="progress-fill" id="worker-progress" style="width: 0%"></div>
          </div>
          <div class="progress-text" id="worker-progress-text">...</div>
        </div>
        <div id="worker-metrics"></div>
      </div>

      <div class="test-panel">
        <h2>ğŸŸ  ä¸»çº¿ç¨‹æ¨¡å¼</h2>
        <div id="main-status" class="metric">çŠ¶æ€ï¼šç­‰å¾…æµ‹è¯•</div>
        <div class="progress">
          <div class="progress-bar">
            <div class="progress-fill" id="main-progress" style="width: 0%"></div>
          </div>
          <div class="progress-text" id="main-progress-text">...</div>
        </div>
        <div id="main-metrics"></div>
      </div>
    </div>

    <div class="results">
      <h2>ğŸ“Š å¯¹æ¯”ç»“æœ</h2>
      <div id="comparison-results">
        <p style="color: #666;">è¿è¡Œæµ‹è¯•åå°†æ˜¾ç¤ºå¯¹æ¯”ç»“æœ...</p>
      </div>
    </div>

    <div class="results">
      <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
      <div id="console-log" class="console-output">
ç­‰å¾…æµ‹è¯•...
      </div>
    </div>
  </div>

  <!-- åŠ è½½ä¾èµ– -->
  <script src="https://gcore.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="../../js/chatbot/config/performance-config.js"></script>
  <script src="../../js/chatbot/utils/performance-monitor.js"></script>
  <script src="../../js/workers/markdown-worker-pool.js"></script>

  <script>
    // æµ‹è¯•æ•°æ®ç”Ÿæˆ
    function generateMarkdown(length) {
      const paragraphs = Math.ceil(length / 100);
      let md = '# æ€§èƒ½æµ‹è¯•æ–‡æ¡£\n\n';

      for (let i = 0; i < paragraphs; i++) {
        md += `## ç« èŠ‚ ${i + 1}\n\n`;
        md += `è¿™æ˜¯ç¬¬ ${i + 1} ä¸ªæ®µè½ã€‚`.repeat(5) + '\n\n';

        if (i % 3 === 0) {
          md += '```javascript\n';
          md += 'function test() {\n';
          md += '  return "Hello World";\n';
          md += '}\n';
          md += '```\n\n';
        }

        if (i % 5 === 0) {
          md += '- åˆ—è¡¨é¡¹ 1\n';
          md += '- åˆ—è¡¨é¡¹ 2\n';
          md += '- åˆ—è¡¨é¡¹ 3\n\n';
        }
      }

      return md;
    }

    // æµ‹è¯•ç»“æœå­˜å‚¨
    const testResults = {
      worker: [],
      mainThread: []
    };

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logEl = document.getElementById('console-log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // æ›´æ–°è¿›åº¦
    function updateProgress(mode, percent, text) {
      document.getElementById(`${mode}-progress`).style.width = percent + '%';
      document.getElementById(`${mode}-progress-text`).textContent = text;
    }

    // æ›´æ–°çŠ¶æ€
    function updateStatus(mode, text) {
      document.getElementById(`${mode}-status`).textContent = text;
    }

    // æ›´æ–°æŒ‡æ ‡
    function updateMetrics(mode, metrics) {
      const metricsEl = document.getElementById(`${mode}-metrics`);
      metricsEl.innerHTML = `
        <div class="metric"><span>å¹³å‡è€—æ—¶:</span><span>${metrics.avgTime.toFixed(2)} ms</span></div>
        <div class="metric"><span>æœ€å°è€—æ—¶:</span><span>${metrics.minTime.toFixed(2)} ms</span></div>
        <div class="metric"><span>æœ€å¤§è€—æ—¶:</span><span>${metrics.maxTime.toFixed(2)} ms</span></div>
        <div class="metric"><span>æ€»è€—æ—¶:</span><span>${metrics.totalTime.toFixed(2)} ms</span></div>
      `;
    }

    // æµ‹è¯• Worker æ¨¡å¼
    async function testWorkerMode(markdown, rounds = 10) {
      log('å¼€å§‹æµ‹è¯• Worker æ¨¡å¼...', 'info');
      updateStatus('worker', 'çŠ¶æ€ï¼šæµ‹è¯•ä¸­...');

      const times = [];

      for (let i = 0; i < rounds; i++) {
        const start = performance.now();

        try {
          await window.markdownWorkerPool.parse(markdown);
          const duration = performance.now() - start;
          times.push(duration);

          updateProgress('worker', ((i + 1) / rounds) * 100, `${i + 1}/${rounds}`);
        } catch (error) {
          log(`Worker æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          times.push(NaN);
        }
      }

      const validTimes = times.filter(t => !isNaN(t));
      const metrics = {
        avgTime: validTimes.reduce((a, b) => a + b, 0) / validTimes.length,
        minTime: Math.min(...validTimes),
        maxTime: Math.max(...validTimes),
        totalTime: validTimes.reduce((a, b) => a + b, 0)
      };

      updateStatus('worker', 'çŠ¶æ€ï¼šå®Œæˆ âœ…');
      updateMetrics('worker', metrics);
      log(`Worker æ¨¡å¼å®Œæˆ: å¹³å‡ ${metrics.avgTime.toFixed(2)} ms`, 'success');

      return metrics;
    }

    // æµ‹è¯•ä¸»çº¿ç¨‹æ¨¡å¼
    async function testMainThreadMode(markdown, rounds = 10) {
      log('å¼€å§‹æµ‹è¯•ä¸»çº¿ç¨‹æ¨¡å¼...', 'info');
      updateStatus('main', 'çŠ¶æ€ï¼šæµ‹è¯•ä¸­...');

      const times = [];

      for (let i = 0; i < rounds; i++) {
        const start = performance.now();

        try {
          marked.parse(markdown);
          const duration = performance.now() - start;
          times.push(duration);

          updateProgress('main', ((i + 1) / rounds) * 100, `${i + 1}/${rounds}`);
        } catch (error) {
          log(`ä¸»çº¿ç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          times.push(NaN);
        }
      }

      const validTimes = times.filter(t => !isNaN(t));
      const metrics = {
        avgTime: validTimes.reduce((a, b) => a + b, 0) / validTimes.length,
        minTime: Math.min(...validTimes),
        maxTime: Math.max(...validTimes),
        totalTime: validTimes.reduce((a, b) => a + b, 0)
      };

      updateStatus('main', 'çŠ¶æ€ï¼šå®Œæˆ âœ…');
      updateMetrics('main', metrics);
      log(`ä¸»çº¿ç¨‹æ¨¡å¼å®Œæˆ: å¹³å‡ ${metrics.avgTime.toFixed(2)} ms`, 'success');

      return metrics;
    }

    // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
    function displayComparison(workerMetrics, mainMetrics, testName) {
      const improvement = ((mainMetrics.avgTime - workerMetrics.avgTime) / mainMetrics.avgTime * 100);
      const faster = workerMetrics.avgTime < mainMetrics.avgTime ? 'worker' : 'main';

      const html = `
        <h3>${testName} - æ€§èƒ½å¯¹æ¯”</h3>
        <table class="comparison-table">
          <thead>
            <tr>
              <th>æŒ‡æ ‡</th>
              <th>Web Worker</th>
              <th>ä¸»çº¿ç¨‹</th>
              <th>æ”¹å–„</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>å¹³å‡è€—æ—¶</td>
              <td class="${faster === 'worker' ? 'winner' : ''}">${workerMetrics.avgTime.toFixed(2)} ms</td>
              <td class="${faster === 'main' ? 'winner' : ''}">${mainMetrics.avgTime.toFixed(2)} ms</td>
              <td>${improvement > 0 ? 'â†“' : 'â†‘'} ${Math.abs(improvement).toFixed(1)}%</td>
            </tr>
            <tr>
              <td>æœ€å°è€—æ—¶</td>
              <td>${workerMetrics.minTime.toFixed(2)} ms</td>
              <td>${mainMetrics.minTime.toFixed(2)} ms</td>
              <td>-</td>
            </tr>
            <tr>
              <td>æœ€å¤§è€—æ—¶</td>
              <td>${workerMetrics.maxTime.toFixed(2)} ms</td>
              <td>${mainMetrics.maxTime.toFixed(2)} ms</td>
              <td>-</td>
            </tr>
            <tr>
              <td>æ€»è€—æ—¶</td>
              <td>${workerMetrics.totalTime.toFixed(0)} ms</td>
              <td>${mainMetrics.totalTime.toFixed(0)} ms</td>
              <td>${improvement > 0 ? 'â†“' : 'â†‘'} ${Math.abs(improvement).toFixed(1)}%</td>
            </tr>
          </tbody>
        </table>

        <div class="info-box" style="margin-top: 16px; background: ${improvement > 0 ? '#e8f5e9' : '#fff3cd'};">
          <strong>ç»“è®ºï¼š</strong>
          ${improvement > 0
            ? `âœ… <strong>Web Worker æ€§èƒ½æå‡ ${improvement.toFixed(1)}%</strong>ï¼Œä¸»çº¿ç¨‹é˜»å¡æ—¶é—´æ˜¾è‘—å‡å°‘`
            : `âš ï¸ å¯¹äºçŸ­æ–‡æœ¬ï¼Œé€šä¿¡å¼€é”€å¯èƒ½è¶…è¿‡è®¡ç®—å¼€é”€ï¼ŒWorker æ€§èƒ½åè€Œç¨å·®`
          }
        </div>
      `;

      document.getElementById('comparison-results').innerHTML = html;
    }

    // å•ç‹¬æµ‹è¯•å‡½æ•°
    async function runShortTextTest() {
      document.getElementById('console-log').innerHTML = '';
      log('========================================', 'info');
      log('å¼€å§‹æµ‹è¯•ï¼šçŸ­æ–‡æœ¬ (500å­—)', 'info');
      log('========================================', 'info');

      const markdown = generateMarkdown(500);
      log(`ç”Ÿæˆäº† ${markdown.length} å­—ç¬¦çš„æµ‹è¯•æ–‡æœ¬`, 'info');

      const workerMetrics = await testWorkerMode(markdown, 20);
      await new Promise(resolve => setTimeout(resolve, 500));
      const mainMetrics = await testMainThreadMode(markdown, 20);

      displayComparison(workerMetrics, mainMetrics, 'çŸ­æ–‡æœ¬æµ‹è¯•');
    }

    async function runMediumTextTest() {
      document.getElementById('console-log').innerHTML = '';
      log('========================================', 'info');
      log('å¼€å§‹æµ‹è¯•ï¼šä¸­æ–‡æœ¬ (5000å­—)', 'info');
      log('========================================', 'info');

      const markdown = generateMarkdown(5000);
      log(`ç”Ÿæˆäº† ${markdown.length} å­—ç¬¦çš„æµ‹è¯•æ–‡æœ¬`, 'info');

      const workerMetrics = await testWorkerMode(markdown, 20);
      await new Promise(resolve => setTimeout(resolve, 500));
      const mainMetrics = await testMainThreadMode(markdown, 20);

      displayComparison(workerMetrics, mainMetrics, 'ä¸­æ–‡æœ¬æµ‹è¯•');
    }

    async function runLongTextTest() {
      document.getElementById('console-log').innerHTML = '';
      log('========================================', 'info');
      log('å¼€å§‹æµ‹è¯•ï¼šé•¿æ–‡æœ¬ (20000å­—)', 'info');
      log('========================================', 'info');

      const markdown = generateMarkdown(20000);
      log(`ç”Ÿæˆäº† ${markdown.length} å­—ç¬¦çš„æµ‹è¯•æ–‡æœ¬`, 'info');

      const workerMetrics = await testWorkerMode(markdown, 10);
      await new Promise(resolve => setTimeout(resolve, 500));
      const mainMetrics = await testMainThreadMode(markdown, 10);

      displayComparison(workerMetrics, mainMetrics, 'é•¿æ–‡æœ¬æµ‹è¯•');
    }

    // è¿è¡Œæ‰€æœ‰æµ‹è¯•
    async function runAllTests() {
      await runShortTextTest();
      await new Promise(resolve => setTimeout(resolve, 1000));
      await runMediumTextTest();
      await new Promise(resolve => setTimeout(resolve, 1000));
      await runLongTextTest();

      log('========================================', 'success');
      log('æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success');
      log('========================================', 'success');
    }

    // æŸ¥çœ‹ç»Ÿè®¡
    function viewStats() {
      const stats = window.markdownWorkerPool.getStats();
      console.log('Worker Pool ç»Ÿè®¡ï¼š', stats);

      alert(`Worker Pool ç»Ÿè®¡ä¿¡æ¯ï¼š

æ± å¤§å°: ${stats.poolSize}
åˆå§‹åŒ–: ${stats.initialized ? 'æ˜¯' : 'å¦'}
å¯ç”¨: ${stats.available ? 'æ˜¯' : 'å¦'}

å·²å®Œæˆä»»åŠ¡: ${stats.tasksCompleted}
å¤±è´¥ä»»åŠ¡: ${stats.tasksFailed}
é™çº§ä»»åŠ¡: ${stats.tasksFallback}
é˜Ÿåˆ—é•¿åº¦: ${stats.queueLength}
å¾…å¤„ç†: ${stats.pendingTasks}

å¹³å‡ Worker è€—æ—¶: ${stats.avgWorkerTime.toFixed(2)} ms
å¹³å‡ä¸»çº¿ç¨‹è€—æ—¶: ${stats.avgMainThreadTime.toFixed(2)} ms

è¯¦ç»†ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°`);
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('load', function() {
      console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #4CAF50; font-weight: bold');
      console.log('%c   Phase 5.1.2 Markdown Worker æµ‹è¯•', 'color: #4CAF50; font-weight: bold');
      console.log('%câ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'color: #4CAF50; font-weight: bold');
      console.log('');
      console.log('Worker æ± çŠ¶æ€:', window.markdownWorkerPool ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–');
      console.log('');
      console.log('ä½¿ç”¨æ–¹æ³•ï¼š');
      console.log('  1. ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"è¿›è¡Œå®Œæ•´æµ‹è¯•');
      console.log('  2. æˆ–é€‰æ‹©å•ç‹¬çš„æµ‹è¯•åœºæ™¯');
      console.log('  3. æŸ¥çœ‹å¯¹æ¯”ç»“æœå’Œæ€§èƒ½æŒ‡æ ‡');
      console.log('');

      log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ª', 'success');
      log(`Worker æ± å·²åˆå§‹åŒ–ï¼Œå¤§å°: ${window.markdownWorkerPool.config.poolSize}`, 'info');
    });
  </script>
</body>
</html>
