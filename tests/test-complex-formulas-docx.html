<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤æ‚å…¬å¼ DOCX å¯¼å‡ºæµ‹è¯•</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1e40af;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 10px;
        }
        h2 {
            color: #1e3a8a;
            margin-top: 0;
        }
        .formula-example {
            margin: 15px 0;
            padding: 15px;
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
        }
        .formula-example h3 {
            margin-top: 0;
            color: #475569;
            font-size: 14px;
            font-weight: 600;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .status {
            padding: 12px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 500;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
    </style>
</head>
<body>
    <h1>ğŸ§® å¤æ‚å…¬å¼ DOCX å¯¼å‡ºæµ‹è¯•</h1>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
        <p>æœ¬é¡µé¢æµ‹è¯•å¢å¼ºçš„ MathML â†’ OMML è½¬æ¢å™¨ï¼ŒåŒ…å«ä»¥ä¸‹å¤æ‚å…¬å¼ç±»å‹ï¼š</p>
        <ul>
            <li>âœ… <strong>çŸ©é˜µ</strong> - mtable/mtr/mtd</li>
            <li>âœ… <strong>å¤§å‹è¿ç®—ç¬¦</strong> - æ±‚å’Œã€ç§¯åˆ†ã€ä¹˜ç§¯</li>
            <li>âœ… <strong>ä¸Šä¸‹æ ‡</strong> - æé™ã€æ±‚å’ŒèŒƒå›´</li>
            <li>âœ… <strong>å¤æ‚åˆ†æ•°</strong> - åµŒå¥—åˆ†æ•°</li>
            <li>âœ… <strong>æ ¹å¼</strong> - å¤šé‡æ ¹å¼</li>
        </ul>
        <div id="status"></div>
        <button onclick="exportToDOCX()">ğŸ“¥ å¯¼å‡ºä¸º DOCX</button>
        <button onclick="testConverter()">ğŸ”¬ æµ‹è¯•è½¬æ¢å™¨</button>
    </div>

    <!-- æµ‹è¯•å…¬å¼ -->
    <div class="test-section" id="formulas-content">
        <h2>ğŸ”¢ æµ‹è¯•å…¬å¼</h2>

        <div class="formula-example">
            <h3>1. çŸ©é˜µç¤ºä¾‹</h3>
            $$
            A = \begin{bmatrix}
            a_{11} & a_{12} & a_{13} \\
            a_{21} & a_{22} & a_{23} \\
            a_{31} & a_{32} & a_{33}
            \end{bmatrix}
            $$
        </div>

        <div class="formula-example">
            <h3>2. æ±‚å’Œä¸æé™</h3>
            $$
            \lim_{n \to \infty} \sum_{i=1}^{n} \frac{1}{i^2} = \frac{\pi^2}{6}
            $$
        </div>

        <div class="formula-example">
            <h3>3. ç§¯åˆ†</h3>
            $$
            \int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}
            $$
        </div>

        <div class="formula-example">
            <h3>4. å¤æ‚åˆ†æ•°</h3>
            $$
            \frac{1}{1 + \frac{1}{1 + \frac{1}{1 + x}}}
            $$
        </div>

        <div class="formula-example">
            <h3>5. è¡Œåˆ—å¼</h3>
            $$
            \det(A) = \begin{vmatrix}
            a & b & c \\
            d & e & f \\
            g & h & i
            \end{vmatrix}
            = aei + bfg + cdh - ceg - bdi - afh
            $$
        </div>

        <div class="formula-example">
            <h3>6. å¤šé‡ç§¯åˆ†</h3>
            $$
            \iiint_V f(x,y,z) \, dV = \int_0^1 \int_0^1 \int_0^1 xyz \, dx\,dy\,dz
            $$
        </div>

        <div class="formula-example">
            <h3>7. å¤æ‚ä¸Šä¸‹æ ‡</h3>
            $$
            \sum_{k=1}^{\infty} \frac{(-1)^{k+1}}{k} = \ln(2)
            $$
        </div>

        <div class="formula-example">
            <h3>8. æ ¹å¼ç»„åˆ</h3>
            $$
            x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
            $$
        </div>

        <div class="formula-example">
            <h3>9. å¤§å‹çŸ©é˜µ</h3>
            $$
            \begin{pmatrix}
            1 & 0 & 0 & 0 \\
            0 & 1 & 0 & 0 \\
            0 & 0 & 1 & 0 \\
            0 & 0 & 0 & 1
            \end{pmatrix}
            $$
        </div>

        <div class="formula-example">
            <h3>10. å¸¦è¾¹ç•Œçš„ç§¯åˆ†</h3>
            $$
            \int\limits_0^{\frac{\pi}{2}} \sin(x) \, dx = 1
            $$
        </div>
    </div>

    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <!-- Paper Burner æ¨¡å— -->
    <script src="../js/history/exporter/mathml2omml.browser.js"></script>
    <script src="../js/history/exporter/docx_mathml_converter_enhanced.js"></script>
    <script src="../js/history/exporter/history_exporter_docx.js"></script>

    <script>
        // æ¸²æŸ“æ‰€æœ‰å…¬å¼
        document.addEventListener('DOMContentLoaded', function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ]
            });

            showStatus('å…¬å¼æ¸²æŸ“å®Œæˆï¼å¯ä»¥å¼€å§‹æµ‹è¯•ã€‚', 'info');
        });

        // æ¸²æŸ“å…¬å¼çš„è¾…åŠ©å‡½æ•°
        function renderMathInElement(element, options) {
            const delimiters = options.delimiters || [];
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT);
            const nodes = [];

            while (walker.nextNode()) {
                nodes.push(walker.currentNode);
            }

            nodes.forEach(node => {
                const text = node.textContent;
                for (const delim of delimiters) {
                    const regex = new RegExp(
                        delim.left.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') +
                        '([\\s\\S]*?)' +
                        delim.right.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),
                        'g'
                    );

                    if (regex.test(text)) {
                        const container = document.createElement('span');
                        let lastIndex = 0;
                        let html = '';

                        text.replace(regex, (match, formula, offset) => {
                            html += text.substring(lastIndex, offset);
                            try {
                                html += katex.renderToString(formula, {
                                    displayMode: delim.display,
                                    throwOnError: false,
                                    output: 'mathml'
                                });
                            } catch (e) {
                                html += `<span class="error">${match}</span>`;
                            }
                            lastIndex = offset + match.length;
                        });

                        html += text.substring(lastIndex);
                        container.innerHTML = html;
                        node.parentNode.replaceChild(container, node);
                        return;
                    }
                }
            });
        }

        // æµ‹è¯•è½¬æ¢å™¨
        function testConverter() {
            showStatus('æ­£åœ¨æµ‹è¯•è½¬æ¢å™¨...', 'info');

            try {
                // æµ‹è¯•å¢å¼ºè½¬æ¢å™¨æ˜¯å¦åŠ è½½
                if (!window.PBXMathMlToOmmlConverterEnhanced) {
                    throw new Error('å¢å¼ºè½¬æ¢å™¨æœªåŠ è½½ï¼');
                }

                const converter = new window.PBXMathMlToOmmlConverterEnhanced();

                // æ‰¾ä¸€ä¸ªçŸ©é˜µå…¬å¼æµ‹è¯•
                const mathElements = document.querySelectorAll('math');
                if (mathElements.length === 0) {
                    throw new Error('æœªæ‰¾åˆ° MathML å…ƒç´ ï¼è¯·ç­‰å¾…å…¬å¼æ¸²æŸ“å®Œæˆã€‚');
                }

                // æµ‹è¯•ç¬¬ä¸€ä¸ªå…¬å¼
                const testMath = mathElements[0];
                const omml = converter.convert(testMath);

                if (!omml || omml.length === 0) {
                    throw new Error('è½¬æ¢å¤±è´¥ï¼šOMML ä¸ºç©º');
                }

                console.log('âœ… è½¬æ¢æˆåŠŸï¼', omml);
                showStatus(
                    `âœ… è½¬æ¢å™¨æµ‹è¯•æˆåŠŸï¼\næ‰¾åˆ° ${mathElements.length} ä¸ªå…¬å¼ï¼Œç¬¬ä¸€ä¸ªå…¬å¼è½¬æ¢åé•¿åº¦ï¼š${omml.length} å­—ç¬¦`,
                    'success'
                );
            } catch (error) {
                console.error('âŒ è½¬æ¢å™¨æµ‹è¯•å¤±è´¥:', error);
                showStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¯¼å‡ºä¸º DOCX
        async function exportToDOCX() {
            showStatus('æ­£åœ¨ç”Ÿæˆ DOCX...', 'info');

            try {
                if (!window.PBXHistoryExporterDocx || !window.PBXHistoryExporterDocx.exportAsDocx) {
                    throw new Error('DOCX å¯¼å‡ºæ¨¡å—æœªåŠ è½½ï¼');
                }

                // è·å–æ¸²æŸ“åçš„ HTML
                const content = document.getElementById('formulas-content');
                const bodyHtml = content.innerHTML;

                // æ„å»º payload
                const payload = {
                    bodyHtml: bodyHtml,
                    data: {
                        name: 'å¤æ‚å…¬å¼æµ‹è¯•'
                    },
                    images: [],
                    exportTime: new Date(),
                    fileNameBase: 'å¤æ‚å…¬å¼æµ‹è¯•'
                };

                // å¯¼å‡º
                await window.PBXHistoryExporterDocx.exportAsDocx(payload, {
                    debug: true,
                    validateXml: true
                });

                showStatus('âœ… DOCX å¯¼å‡ºæˆåŠŸï¼è¯·æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶ã€‚', 'success');
            } catch (error) {
                console.error('âŒ å¯¼å‡ºå¤±è´¥:', error);
                showStatus(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + type;
            statusDiv.textContent = message;
        }
    </script>
</body>
</html>
