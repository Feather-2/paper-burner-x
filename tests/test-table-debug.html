<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è°ƒè¯•å‹ç¼©è¡¨æ ¼ä¿®å¤</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .result {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ› è°ƒè¯•å‹ç¼©è¡¨æ ¼ä¿®å¤</h1>

    <div id="output"></div>

    <script>
        const compressedTable = `| | | | äº”åˆ†ä½æ•° (Quintiles) | | | |---|---|---|---|---|---|---| | | 1 | 2 | 3 | 4 | 5 | 5-1 | | å¸‚åœº (Market) | 0.145*** | 0.200** | 0.061* | 0.136* | 0.106*** | -0.039 | | | (2.774) | (2.441) | (1.938) | (1.689) | (2.703) | (-0.930) | | è§„æ¨¡ (Size) | 0.107** | 0.329* | 0.147** | 0.206** | 0.059*** | 0.047 | | | (2.163) | (1.800) | (2.223) | (2.452) | (3.150) | (1.090) |`;

        const output = document.getElementById('output');
        const logs = [];

        function log(message) {
            logs.push(message);
            console.log(message);
        }

        // æµ‹è¯•æ­£åˆ™åŒ¹é…
        log('=== æµ‹è¯• 1: æ£€æµ‹åˆ†éš”ç¬¦ ===');
        const separatorPattern = /\|\s*:?-+:?\s*\|/;
        log(`æ­£åˆ™: ${separatorPattern}`);
        log(`æµ‹è¯•ç»“æœ: ${separatorPattern.test(compressedTable)}`);

        // æŸ¥æ‰¾åˆ†éš”ç¬¦ä½ç½®
        log('\n=== æµ‹è¯• 2: æŸ¥æ‰¾åˆ†éš”ç¬¦ä½ç½® ===');
        const fullSeparatorMatch = compressedTable.match(/(\|\s*:?-+:?\s*)+\|/);
        if (fullSeparatorMatch) {
            log(`æ‰¾åˆ°åˆ†éš”ç¬¦: "${fullSeparatorMatch[0]}"`);
            log(`èµ·å§‹ä½ç½®: ${fullSeparatorMatch.index}`);
            log(`é•¿åº¦: ${fullSeparatorMatch[0].length}`);
        } else {
            log('æœªæ‰¾åˆ°åˆ†éš”ç¬¦ï¼');
        }

        // ç»Ÿè®¡ç®¡é“ç¬¦
        log('\n=== æµ‹è¯• 3: ç»Ÿè®¡ç®¡é“ç¬¦ ===');
        const pipeCount = (compressedTable.match(/\|/g) || []).length;
        log(`ç®¡é“ç¬¦æ•°é‡: ${pipeCount}`);
        log(`é•¿åº¦: ${compressedTable.length}`);

        // æµ‹è¯•åˆ—æ•°è¯†åˆ«
        if (fullSeparatorMatch) {
            log('\n=== æµ‹è¯• 4: è¯†åˆ«åˆ—æ•° ===');
            const separator = fullSeparatorMatch[0];
            const separatorPipes = (separator.match(/\|/g) || []).length;
            const columnCount = separatorPipes - 1; // åˆ—æ•° = ç®¡é“ç¬¦æ•° - 1
            log(`åˆ†éš”ç¬¦ç®¡é“ç¬¦: ${separatorPipes}`);
            log(`åˆ—æ•°: ${columnCount}`);

            // æå–å„éƒ¨åˆ†
            log('\n=== æµ‹è¯• 5: æå–è¡¨æ ¼éƒ¨åˆ† ===');
            const separatorIndex = fullSeparatorMatch.index;
            const separatorLength = fullSeparatorMatch[0].length;

            const beforeSeparator = compressedTable.substring(0, separatorIndex);
            const afterSeparator = compressedTable.substring(separatorIndex + separatorLength);

            log(`è¡¨å¤´éƒ¨åˆ† (${beforeSeparator.length} å­—ç¬¦):`);
            log(`  "${beforeSeparator.substring(0, 100)}..."`);
            log(`\næ•°æ®éƒ¨åˆ† (${afterSeparator.length} å­—ç¬¦):`);
            log(`  "${afterSeparator.substring(0, 100)}..."`);

            // è®¡ç®—æ¯è¡Œéœ€è¦çš„ç®¡é“ç¬¦æ•°é‡
            log('\n=== æµ‹è¯• 6: æŒ‰åˆ—æ•°åˆ†å‰² ===');
            const pipesPerRow = columnCount + 1; // æ¯è¡Œç®¡é“ç¬¦ = åˆ—æ•° + 1
            log(`æ¯è¡Œéœ€è¦ ${pipesPerRow} ä¸ªç®¡é“ç¬¦`);

            // åˆ†å‰²è¡¨å¤´
            log('\næå–è¡¨å¤´è¡Œ:');
            const headerPipes = [];
            for (let i = 0; i < beforeSeparator.length && headerPipes.length < pipesPerRow; i++) {
                if (beforeSeparator[i] === '|') {
                    headerPipes.push(i);
                }
            }
            log(`è¡¨å¤´ä¸­æ‰¾åˆ° ${headerPipes.length} ä¸ªç®¡é“ç¬¦ï¼Œä½ç½®: ${headerPipes.slice(0, 5)}...`);

            if (headerPipes.length >= pipesPerRow) {
                const headerRow = beforeSeparator.substring(0, headerPipes[pipesPerRow - 1] + 1);
                log(`è¡¨å¤´è¡Œ: "${headerRow}"`);
            }

            // åˆ†å‰²æ•°æ®è¡Œ
            log('\næå–æ•°æ®è¡Œ:');
            let remaining = afterSeparator.trim();
            let rowNum = 1;
            const dataRows = [];

            while (remaining.length > 0 && rowNum <= 5) { // æœ€å¤šæå–5è¡Œç”¨äºè°ƒè¯•
                // è·³è¿‡å¼€å¤´çš„ç®¡é“ç¬¦
                if (remaining.startsWith('|')) {
                    remaining = remaining.slice(1).trim();
                }

                const rowPipes = [];
                for (let i = 0; i < remaining.length && rowPipes.length < pipesPerRow - 1; i++) {
                    if (remaining[i] === '|') {
                        rowPipes.push(i);
                    }
                }

                if (rowPipes.length < pipesPerRow - 1) {
                    log(`è¡Œ ${rowNum}: ç®¡é“ç¬¦ä¸è¶³ (${rowPipes.length}/${pipesPerRow - 1})ï¼Œåœæ­¢`);
                    break;
                }

                const endIndex = rowPipes[pipesPerRow - 2];
                const row = '|' + remaining.substring(0, endIndex + 1);
                dataRows.push(row);
                log(`è¡Œ ${rowNum}: "${row.substring(0, 80)}..."`);

                remaining = remaining.substring(endIndex + 1).trim();
                rowNum++;
            }

            // ç»„åˆç»“æœ
            log('\n=== æµ‹è¯• 7: ç»„åˆå¤šè¡Œè¡¨æ ¼ ===');
            const headerRow = beforeSeparator.substring(0, headerPipes[pipesPerRow - 1] + 1);
            const fixedTable = [
                headerRow.trim(),
                separator.trim(),
                ...dataRows
            ].join('\n');

            log('ä¿®å¤åçš„è¡¨æ ¼:');
            log(fixedTable);
        }

        // æ˜¾ç¤ºæ—¥å¿—
        const logDiv = document.createElement('div');
        logDiv.className = 'log';
        logDiv.textContent = logs.join('\n');
        output.appendChild(logDiv);
    </script>
</body>
</html>
