<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Block #31 è¡¨æ ¼è¯Šæ–­</title>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <script src="../js/processing/markdown_processor_ast.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1600px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .success { color: #27ae60; font-weight: bold; }
        .fail { color: #e74c3c; font-weight: bold; }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result {
            border: 3px solid #3498db;
            padding: 20px;
            margin: 15px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .result table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
        }
        .result th, .result td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
        }
        .result th {
            background: #3498db;
            color: white;
            font-weight: bold;
        }
        .code {
            background: #f1f3f5;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d9480f;
        }
        h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        h3 { color: #495057; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ” Block #31 è¡¨æ ¼è¯Šæ–­</h1>

    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        const logs = [];

        function log(msg) {
            logs.push(msg);
            console.log(msg);
        }

        // Block #31 çš„å®é™…å†…å®¹
        const block31Content = `| | | | äº”åˆ†ä½æ•° (Quintiles) | | |
|---|---|---|---|---|---|---|
| | 1 | 2 | 3 | 4 | 5 | 5-1 |
| å¸‚åœº (Market) | 0.145*** | 0.200** | 0.061* | 0.136* | 0.106*** | -0.039 |
| | (2.774) | (2.441) | (1.938) | (1.689) | (2.703) | (-0.930) |
| è§„æ¨¡ (Size) | 0.107** | 0.329* | 0.147** | 0.206** | 0.059*** | 0.047 |
| | (2.163) | (1.800) | (2.223) | (2.452) | (3.150) | (1.090) |`;

        // ============ æ­¥éª¤ 1: æ£€æŸ¥ä¾èµ– ============
        const section1 = document.createElement('div');
        section1.className = 'section';
        section1.innerHTML = '<h2>æ­¥éª¤ 1: æ£€æŸ¥ä¾èµ–åŠ è½½</h2>';

        log('=== æ­¥éª¤ 1: æ£€æŸ¥ä¾èµ– ===');

        const checks = {
            'marked': typeof marked !== 'undefined',
            'markdownit': typeof markdownit !== 'undefined',
            'MarkdownProcessorAST': typeof MarkdownProcessorAST !== 'undefined'
        };

        let checksHTML = '<ul>';
        for (const [name, loaded] of Object.entries(checks)) {
            const status = loaded ? '<span class="success">âœ“ å·²åŠ è½½</span>' : '<span class="fail">âœ— æœªåŠ è½½</span>';
            checksHTML += `<li><strong>${name}</strong>: ${status}</li>`;
            log(`${name}: ${loaded ? 'âœ“ å·²åŠ è½½' : 'âœ— æœªåŠ è½½'}`);
        }
        checksHTML += '</ul>';
        section1.innerHTML += checksHTML;
        output.appendChild(section1);

        // ============ æ­¥éª¤ 2: æ£€æµ‹è¡¨æ ¼è¯­æ³• ============
        const section2 = document.createElement('div');
        section2.className = 'section';
        section2.innerHTML = '<h2>æ­¥éª¤ 2: è¡¨æ ¼è¯­æ³•æ£€æµ‹</h2>';

        log('\n=== æ­¥éª¤ 2: è¡¨æ ¼è¯­æ³•æ£€æµ‹ ===');

        const hasTableSyntax = /\|(:?-+:?\|)+/.test(block31Content);
        const pipeCount = (block31Content.match(/\|/g) || []).length;
        const lineCount = block31Content.split('\n').length;

        section2.innerHTML += `
            <p>åŒ…å«è¡¨æ ¼åˆ†éš”ç¬¦: ${hasTableSyntax ? '<span class="success">âœ“ æ˜¯</span>' : '<span class="fail">âœ— å¦</span>'}</p>
            <p>ç®¡é“ç¬¦æ•°é‡: <strong>${pipeCount}</strong></p>
            <p>è¡Œæ•°: <strong>${lineCount}</strong></p>
            <p>å†…å®¹é•¿åº¦: <strong>${block31Content.length} å­—ç¬¦</strong></p>
        `;

        log(`åŒ…å«è¡¨æ ¼åˆ†éš”ç¬¦: ${hasTableSyntax}`);
        log(`ç®¡é“ç¬¦æ•°é‡: ${pipeCount}`);
        log(`è¡Œæ•°: ${lineCount}`);

        output.appendChild(section2);

        // ============ æ­¥éª¤ 3: marked.lexer() æµ‹è¯• ============
        const section3 = document.createElement('div');
        section3.className = 'section';
        section3.innerHTML = '<h2>æ­¥éª¤ 3: marked.lexer() è¯æ³•åˆ†æ</h2>';

        log('\n=== æ­¥éª¤ 3: marked.lexer() æµ‹è¯• ===');

        if (typeof marked !== 'undefined') {
            const tokens = marked.lexer(block31Content);
            log(`Token æ•°é‡: ${tokens.length}`);

            if (tokens.length > 0) {
                log(`Token[0] type: "${tokens[0].type}"`);
                log(`Token[0] raw é•¿åº¦: ${tokens[0].raw.length}`);

                section3.innerHTML += `
                    <p>Token æ•°é‡: <strong>${tokens.length}</strong></p>
                    <p>ç¬¬ä¸€ä¸ª Token ç±»å‹: <strong class="${tokens[0].type === 'table' ? 'success' : 'fail'}">${tokens[0].type}</strong></p>
                    ${tokens[0].type === 'paragraph' ? '<p class="fail">âš ï¸ è¢«è¯¯åˆ¤ä¸º paragraphï¼éœ€è¦ä¸‰å±‚ä¿®å¤æœºåˆ¶</p>' : ''}
                `;
            }
        } else {
            section3.innerHTML += '<p class="fail">âœ— marked æœªåŠ è½½ï¼Œæ— æ³•æµ‹è¯•</p>';
        }

        output.appendChild(section3);

        // ============ æ­¥éª¤ 4: MarkdownProcessorAST æ¸²æŸ“ ============
        const section4 = document.createElement('div');
        section4.className = 'section';
        section4.innerHTML = '<h2>æ­¥éª¤ 4: MarkdownProcessorAST æ¸²æŸ“</h2>';

        log('\n=== æ­¥éª¤ 4: MarkdownProcessorAST æ¸²æŸ“ ===');

        if (typeof MarkdownProcessorAST !== 'undefined' && MarkdownProcessorAST.render) {
            try {
                const rendered = MarkdownProcessorAST.render(block31Content, {});
                const isTable = rendered.trim().startsWith('<table');

                log(`æ¸²æŸ“ç»“æœæ˜¯ table: ${isTable}`);
                log(`æ¸²æŸ“ç»“æœé•¿åº¦: ${rendered.length}`);

                section4.innerHTML += `
                    <p>æ¸²æŸ“ç»“æœ: ${isTable ? '<span class="success">âœ“ &lt;table&gt;</span>' : '<span class="fail">âœ— &lt;p&gt;</span>'}</p>
                    <h3>æ¸²æŸ“è¾“å‡º:</h3>
                    <div class="result">${rendered}</div>
                `;

                // å¦‚æœæ˜¯ p æ ‡ç­¾ï¼Œæå–å†…å®¹é‡æ–°æ¸²æŸ“
                if (!isTable && rendered.trim().startsWith('<p')) {
                    log('\nå°è¯•ä» <p> ä¸­æå–å¹¶é‡æ–°æ¸²æŸ“...');

                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = rendered;
                    const pElement = tempDiv.querySelector('p');

                    if (pElement) {
                        const extractedContent = pElement.textContent;
                        log(`æå–çš„å†…å®¹é•¿åº¦: ${extractedContent.length}`);

                        const reRendered = MarkdownProcessorAST.render(extractedContent, {});
                        const isTableNow = reRendered.trim().startsWith('<table');

                        log(`é‡æ–°æ¸²æŸ“ç»“æœæ˜¯ table: ${isTableNow}`);

                        section4.innerHTML += `
                            <h3>ğŸ”„ ä» &lt;p&gt; æå–åé‡æ–°æ¸²æŸ“:</h3>
                            <p>é‡æ–°æ¸²æŸ“ç»“æœ: ${isTableNow ? '<span class="success">âœ“ &lt;table&gt;</span>' : '<span class="fail">âœ— ä»ç„¶æ˜¯ &lt;p&gt;</span>'}</p>
                            <div class="result">${reRendered}</div>
                        `;
                    }
                }
            } catch (error) {
                section4.innerHTML += `<p class="fail">âœ— æ¸²æŸ“å‡ºé”™: ${error.message}</p>`;
                log(`æ¸²æŸ“å‡ºé”™: ${error.message}`);
            }
        } else {
            section4.innerHTML += '<p class="fail">âœ— MarkdownProcessorAST æœªåŠ è½½</p>';
            log('MarkdownProcessorAST æœªåŠ è½½');
        }

        output.appendChild(section4);

        // ============ æ­¥éª¤ 5: æ¨¡æ‹Ÿä¸‰å±‚ä¿®å¤æœºåˆ¶ ============
        const section5 = document.createElement('div');
        section5.className = 'section';
        section5.innerHTML = '<h2>æ­¥éª¤ 5: æ¨¡æ‹Ÿä¸‰å±‚ä¿®å¤æœºåˆ¶</h2>';

        log('\n=== æ­¥éª¤ 5: æ¨¡æ‹Ÿä¸‰å±‚ä¿®å¤æœºåˆ¶ ===');

        if (typeof marked !== 'undefined' && typeof MarkdownProcessorAST !== 'undefined') {
            const tokens = marked.lexer(block31Content);
            const tokenRaw = tokens[0]?.raw || '';

            // ç¬¬ä¸€å±‚ï¼šæ£€æµ‹å¹¶ä¿®æ­£ token ç±»å‹
            log('ã€ç¬¬ä¸€å±‚ã€‘Token ç±»å‹æ£€æµ‹');
            const hasTableSyntaxCheck = /\|(:?-+:?\|)+/.test(tokenRaw);
            log(`åŒ…å«è¡¨æ ¼è¯­æ³•: ${hasTableSyntaxCheck}`);
            log(`åŸå§‹ token ç±»å‹: ${tokens[0].type}`);

            if (tokens[0].type === 'paragraph' && hasTableSyntaxCheck) {
                log('âœ“ å¼ºåˆ¶ä¿®æ­£ token ç±»å‹ä¸º table');
                tokens[0].type = 'table';
            }
            log(`ä¿®æ­£å token ç±»å‹: ${tokens[0].type}`);

            // ç¬¬äºŒå±‚ï¼šä½¿ç”¨ AST æ¸²æŸ“å™¨
            log('\nã€ç¬¬äºŒå±‚ã€‘ä½¿ç”¨ AST æ¸²æŸ“å™¨');
            let htmlStr = MarkdownProcessorAST.render(tokenRaw, {});
            log(`æ¸²æŸ“ç»“æœç±»å‹: ${htmlStr.trim().startsWith('<table') ? '<table>' : '<p>'}`);

            // ç¬¬ä¸‰å±‚ï¼šåéªŒæ£€æŸ¥
            log('\nã€ç¬¬ä¸‰å±‚ã€‘åéªŒæ£€æŸ¥');
            if (hasTableSyntaxCheck && htmlStr.trim().startsWith('<p')) {
                log('âš ï¸ æ¸²æŸ“ç»“æœä»ç„¶æ˜¯ <p>ï¼Œå°è¯•æå–å¹¶é‡æ–°æ¸²æŸ“');

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlStr;
                const pElement = tempDiv.querySelector('p');

                if (pElement && pElement.textContent.includes('|')) {
                    const tableMarkdown = pElement.textContent;
                    htmlStr = MarkdownProcessorAST.render(tableMarkdown, {});
                    log('âœ“ é‡æ–°æ¸²æŸ“å®Œæˆ');
                    log(`æœ€ç»ˆç»“æœç±»å‹: ${htmlStr.trim().startsWith('<table') ? '<table>' : '<p>'}`);
                }
            } else {
                log('âœ“ æ¸²æŸ“ç»“æœæ­£ç¡®ï¼Œæ— éœ€åå¤„ç†');
            }

            const finalIsTable = htmlStr.trim().startsWith('<table');

            section5.innerHTML += `
                <p><strong>ä¸‰å±‚ä¿®å¤æœºåˆ¶æ‰§è¡Œç»“æœ:</strong></p>
                <ul>
                    <li>ç¬¬ä¸€å±‚ - Token ç±»å‹ä¿®æ­£: ${tokens[0].type === 'table' ? '<span class="success">âœ“</span>' : '<span class="fail">âœ—</span>'}</li>
                    <li>ç¬¬äºŒå±‚ - AST æ¸²æŸ“å™¨: <span class="success">âœ“</span></li>
                    <li>ç¬¬ä¸‰å±‚ - åéªŒæ£€æŸ¥: <span class="success">âœ“</span></li>
                </ul>
                <p><strong>æœ€ç»ˆç»“æœ:</strong> ${finalIsTable ? '<span class="success">âœ“ æˆåŠŸæ¸²æŸ“ä¸º &lt;table&gt;</span>' : '<span class="fail">âœ— ä»ç„¶æ˜¯ &lt;p&gt;</span>'}</p>
                <h3>æœ€ç»ˆæ¸²æŸ“è¾“å‡º:</h3>
                <div class="result">${htmlStr}</div>
            `;
        } else {
            section5.innerHTML += '<p class="fail">âœ— æ— æ³•æ‰§è¡Œï¼šç¼ºå°‘å¿…è¦çš„åº“</p>';
        }

        output.appendChild(section5);

        // ============ æ˜¾ç¤ºæ—¥å¿— ============
        setTimeout(() => {
            const logSection = document.createElement('div');
            logSection.className = 'section';
            logSection.innerHTML = `
                <h2>ğŸ“‹ å®Œæ•´æ—¥å¿— (${logs.length} æ¡)</h2>
                <div class="log">${logs.join('\n')}</div>
            `;
            output.appendChild(logSection);

            // ============ è¯Šæ–­å»ºè®® ============
            const suggestionSection = document.createElement('div');
            suggestionSection.className = 'section';
            suggestionSection.innerHTML = `
                <h2>ğŸ’¡ è¯Šæ–­å»ºè®®</h2>
                <ol>
                    <li><strong>å¦‚æœ MarkdownProcessorAST æœªåŠ è½½ï¼š</strong>
                        <ul>
                            <li>æ£€æŸ¥ <span class="code">views/history/history_detail.html</span> ä¸­çš„è„šæœ¬å¼•ç”¨</li>
                            <li>ç¡®è®¤ <span class="code">js/processing/markdown_processor_ast.js</span> æ–‡ä»¶å­˜åœ¨</li>
                            <li>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ (Ctrl + Shift + R)</li>
                        </ul>
                    </li>
                    <li><strong>å¦‚æœæ¸²æŸ“ä¸º &lt;table&gt; ä½†åº”ç”¨ä¸­ä»æ˜¾ç¤º &lt;p&gt;ï¼š</strong>
                        <ul>
                            <li>ç¡®è®¤åº”ç”¨å·²åˆ·æ–° (Ctrl + Shift + R)</li>
                            <li>æ£€æŸ¥ <span class="code">js/history/history_detail_show_tab.js</span> ä¸­çš„ä¸‰å±‚ä¿®å¤ä»£ç </li>
                            <li>åœ¨åº”ç”¨æ§åˆ¶å°ä¸­æŸ¥æ‰¾ <span class="code">[renderBatch]</span> æ—¥å¿—</li>
                        </ul>
                    </li>
                    <li><strong>å¦‚æœä¸‰å±‚ä¿®å¤æœºåˆ¶æœªç”Ÿæ•ˆï¼š</strong>
                        <ul>
                            <li>æ‰“å¼€åº”ç”¨çš„å¼€å‘è€…å·¥å…· (F12)</li>
                            <li>æ‰§è¡Œ: <span class="code">console.log(typeof MarkdownProcessorAST)</span></li>
                            <li>åº”è¯¥è¾“å‡º <span class="code">'object'</span> è€Œä¸æ˜¯ <span class="code">'undefined'</span></li>
                        </ul>
                    </li>
                </ol>
            `;
            output.appendChild(suggestionSection);
        }, 200);
    </script>
</body>
</html>
