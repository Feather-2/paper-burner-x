<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>KaTeX é”™è¯¯ä¿®å¤æµ‹è¯•</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script src="../js/processing/formula_post_processor.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        h1 {
            color: white;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .test-case {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .success { color: #27ae60; font-weight: bold; }
        .fail { color: #e74c3c; font-weight: bold; }
        .result {
            border: 3px solid #3498db;
            padding: 20px;
            margin: 15px 0;
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 50px;
            font-size: 18px;
        }
        .source {
            background: #fff3bf;
            border: 2px dashed #fcc419;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge-before { background: #ffe3e3; color: #c92a2a; }
        .badge-after { background: #d3f9d8; color: #2b8a3e; }
    </style>
</head>
<body>
    <h1>ğŸ”§ KaTeX é”™è¯¯è‡ªåŠ¨ä¿®å¤æµ‹è¯•</h1>

    <div id="output"></div>

    <script>
        const output = document.getElementById('output');

        // æµ‹è¯•ç”¨ä¾‹
        const testCases = [
            {
                name: 'ç”¨æˆ·é—®é¢˜ 1: è¡Œå†…å…¬å¼ä¸­çš„ \\tag',
                before: `$i = \\left| {{0.37}{v}_{\\mathrm{r}}}\\right| + \\left| {{0.28}{d}_{\\mathrm{r}}}\\right| + \\left| {{0.2}{o}_{\\mathrm{r}}}\\right| + \\left| {{0.15}{t}_{\\mathrm{r}}}\\right| \\tag{7}$`,
                error: '\\tag åªèƒ½åœ¨å—çº§å…¬å¼ä¸­ä½¿ç”¨',
                fix: 'è‡ªåŠ¨ç§»é™¤è¡Œå†…å…¬å¼ä¸­çš„ \\tag'
            },
            {
                name: 'ç”¨æˆ·é—®é¢˜ 2: \\;^\\circ è¯­æ³•é”™è¯¯',
                before: `$0.1 - 0.2 \\mathrm{\\;^\\circ C}$`,
                error: 'Got group of unknown type: internal',
                fix: 'ä¿®å¤ä¸º \\,^{\\circ}\\mathrm{C}'
            },
            {
                name: 'é¢å¤–ä¿®å¤: åŒèŠ±æ‹¬å·',
                before: `$\\left| {{0.37}{v}_{\\mathrm{r}}}\\right|$`,
                error: 'å¯èƒ½å¯¼è‡´å†…éƒ¨ç»„é”™è¯¯',
                fix: 'ç§»é™¤å¤šä½™çš„èŠ±æ‹¬å· {{...}} â†’ {...}'
            },
            {
                name: 'å—çº§å…¬å¼æµ‹è¯•: \\tag åº”ä¿ç•™',
                before: `$$i = a + b \\tag{1}$$`,
                error: 'æ— é”™è¯¯ï¼ˆå—çº§å…¬å¼ï¼‰',
                fix: 'ä¿æŒä¸å˜ï¼ˆ\\tag åœ¨å—çº§å…¬å¼ä¸­æœ‰æ•ˆï¼‰'
            },
            {
                name: 'æ¸©åº¦ç¬¦å·æµ‹è¯•',
                before: `$25\\;^\\circ\\mathrm{C}$`,
                error: '\\;^\\circ é”™è¯¯',
                fix: 'ä¿®å¤ä¸º 25\\,^{\\circ}\\mathrm{C}'
            }
        ];

        testCases.forEach((test, idx) => {
            const testDiv = document.createElement('div');
            testDiv.className = 'test-case';

            testDiv.innerHTML = `
                <h2>${test.name}</h2>
                <p><strong>åŸå§‹å…¬å¼:</strong> <span class="badge badge-before">ä¿®å¤å‰</span></p>
                <div class="source">${test.before}</div>
                <p><strong>é”™è¯¯åŸå› :</strong> ${test.error}</p>
                <p><strong>ä¿®å¤ç­–ç•¥:</strong> ${test.fix}</p>
            `;

            // ä¿®å¤å‰
            const beforeDiv = document.createElement('div');
            beforeDiv.className = 'result';
            beforeDiv.innerHTML = '<p><strong>ä¿®å¤å‰æ¸²æŸ“:</strong></p>' + test.before;

            testDiv.appendChild(beforeDiv);

            // åº”ç”¨å…¬å¼åå¤„ç†å™¨
            if (typeof FormulaPostProcessor !== 'undefined') {
                FormulaPostProcessor.processFormulasInElement(beforeDiv);
            }

            // ä¿®å¤å
            const afterDiv = document.createElement('div');
            afterDiv.className = 'result';
            afterDiv.innerHTML = '<p><strong><span class="badge badge-after">ä¿®å¤å</span> æ¸²æŸ“:</strong></p>' + test.before;

            testDiv.appendChild(afterDiv);

            // åº”ç”¨å…¬å¼åå¤„ç†å™¨
            setTimeout(() => {
                if (typeof FormulaPostProcessor !== 'undefined') {
                    FormulaPostProcessor.processFormulasInElement(afterDiv);

                    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                    setTimeout(() => {
                        const hasError = afterDiv.querySelector('.katex-error') !== null;
                        const statusDiv = document.createElement('div');
                        statusDiv.style.marginTop = '15px';
                        statusDiv.innerHTML = hasError
                            ? '<p class="fail">âœ— ä»æœ‰é”™è¯¯</p>'
                            : '<p class="success">âœ“ ä¿®å¤æˆåŠŸ</p>';
                        testDiv.appendChild(statusDiv);
                    }, 100);
                }
            }, 50);

            output.appendChild(testDiv);
        });

        // æ·»åŠ è¯´æ˜
        setTimeout(() => {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'test-case';
            infoDiv.innerHTML = `
                <h2>ğŸ“‹ ä¿®å¤è§„åˆ™è¯´æ˜</h2>
                <ol>
                    <li><strong>\\tag ç§»é™¤è§„åˆ™:</strong> æ£€æµ‹è¡Œå†…å…¬å¼ï¼ˆ$...$ï¼‰ä¸­çš„ \\tag{...}ï¼Œè‡ªåŠ¨ç§»é™¤</li>
                    <li><strong>\\;^\\circ ä¿®å¤:</strong> æ›¿æ¢ä¸º \\,^{\\circ}ï¼ˆæ›´å®‰å…¨çš„è¯­æ³•ï¼‰</li>
                    <li><strong>åŒèŠ±æ‹¬å·ç§»é™¤:</strong> é€’å½’ç§»é™¤ {{...}} â†’ {...}</li>
                    <li><strong>\\mathrm{\\;^\\circ C} é‡å†™:</strong> æå–åˆ°å¤–éƒ¨ â†’ \\,^{\\circ}\\mathrm{C}</li>
                    <li><strong>ä¸Šæ ‡èŠ±æ‹¬å·è¡¥å…¨:</strong> ^xy â†’ ^{xy}ï¼ˆå¤šå­—ç¬¦ä¸Šæ ‡ï¼‰</li>
                </ol>

                <h2>âœ… éªŒè¯æ­¥éª¤</h2>
                <ol>
                    <li>æ£€æŸ¥"ä¿®å¤å‰"æ˜¯å¦æ˜¾ç¤ºé”™è¯¯ï¼ˆçº¢è‰² katex-errorï¼‰</li>
                    <li>æ£€æŸ¥"ä¿®å¤å"æ˜¯å¦æ­£ç¡®æ¸²æŸ“ï¼ˆæ— é”™è¯¯ï¼‰</li>
                    <li>åœ¨å®é™…åº”ç”¨ä¸­åˆ·æ–°é¡µé¢ï¼ˆCtrl + Shift + Rï¼‰</li>
                    <li>æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤ä¿®å¤è§„åˆ™æ‰§è¡Œ</li>
                </ol>

                <h2>ğŸ” æ§åˆ¶å°æ—¥å¿—</h2>
                <p>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š</p>
                <pre>[FormulaPostProcessor] ç§»é™¤è¡Œå†…å…¬å¼ä¸­çš„ \\tag
[FormulaPostProcessor] ä¿®å¤ \\;^\\circ â†’ \\,^{\\circ}
[FormulaPostProcessor] ä¿®å¤åŒèŠ±æ‹¬å· {{...}} â†’ {...}
[FormulaPostProcessor] ä¿®å¤ \\mathrm{\\;^\\circ C}</pre>
            `;
            output.appendChild(infoDiv);
        }, 200);
    </script>
</body>
</html>
