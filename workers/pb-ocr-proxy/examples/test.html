<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCR Worker æµ‹è¯•å·¥å…· - MinerU & Doc2X</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 40px 20px;
      max-width: 1000px;
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    .tab:hover {
      background: #e8ecff;
      color: #667eea;
    }
    .tab.active {
      color: #667eea;
      background: white;
      border-bottom-color: #667eea;
    }
    .content {
      padding: 30px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      color: #555;
      font-size: 14px;
      margin-bottom: 5px;
      font-weight: 500;
    }
    input[type="text"],
    input[type="password"],
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .radio-group {
      display: flex;
      gap: 20px;
      margin: 15px 0;
    }
    .radio-option {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .radio-option input[type="radio"] {
      margin-right: 8px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .service-select {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .service-btn {
      flex: 1;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      background: white;
    }
    .service-btn:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .service-btn.active {
      border-color: #667eea;
      background: #e8ecff;
      font-weight: 600;
      color: #667eea;
    }
    .service-btn .emoji {
      font-size: 24px;
      display: block;
      margin-bottom: 5px;
    }
    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }
    .upload-area:hover {
      border-color: #667eea;
      background: #f0f0ff;
    }
    .upload-area.dragover {
      border-color: #667eea;
      background: #e8ecff;
      transform: scale(1.02);
    }
    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    input[type="file"] {
      display: none;
    }
    .selected-file {
      margin-top: 15px;
      padding: 12px;
      background: #e8ecff;
      border-radius: 6px;
      display: none;
      font-size: 14px;
      color: #333;
    }
    .selected-file.active {
      display: block;
    }
    .options {
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
    }
    .option {
      margin: 10px 0;
    }
    .option label {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      font-weight: normal;
    }
    input[type="checkbox"] {
      margin-right: 8px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #28a745;
      margin-top: 10px;
    }
    .btn-secondary:hover:not(:disabled) {
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }
    .progress-section {
      margin-top: 20px;
      padding: 20px;
      background: #f0f4ff;
      border-radius: 8px;
      display: none;
    }
    .progress-section.active {
      display: block;
    }
    .progress-text {
      color: #333;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .progress-bar {
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      width: 0%;
    }
    .result-section {
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
      display: none;
    }
    .result-section.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      display: block;
    }
    .result-section.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      display: block;
    }
    .result-section h4 {
      margin-bottom: 10px;
    }
    .result-section a {
      color: #667eea;
      word-break: break-all;
      text-decoration: none;
      font-weight: 600;
    }
    .result-section pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-section {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-item {
      margin: 5px 0;
      color: #555;
    }
    .log-item.error {
      color: #d32f2f;
    }
    .log-item.success {
      color: #2e7d32;
    }
    .token-mode-hint {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      margin-top: 10px;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”¬ OCR Worker æµ‹è¯•å·¥å…·</h1>
      <p>æ”¯æŒ MinerU å’Œ Doc2X åŒå¼•æ“ OCR æœåŠ¡</p>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('upload')">ğŸ“¤ ä¸Šä¼ æµ‹è¯•</div>
      <div class="tab" onclick="switchTab('query')">ğŸ” æŸ¥è¯¢ç»“æœ</div>
    </div>

    <div class="content">
      <!-- ä¸Šä¼ æµ‹è¯•æ ‡ç­¾é¡µ -->
      <div class="tab-content active" id="uploadTab">
        <!-- Worker é…ç½® -->
        <div class="section">
          <h3>âš™ï¸ Worker é…ç½®</h3>
          <div class="form-group">
            <label for="workerUrl">Worker URL</label>
            <input type="text" id="workerUrl" placeholder="https://your-worker.workers.dev">
            <div class="hint">ä½ çš„ Cloudflare Worker åœ°å€</div>
          </div>
          <div class="form-group">
            <label for="authKey">AUTH_SECRETï¼ˆå¯é€‰ï¼‰</label>
            <input type="password" id="authKey" placeholder="å¦‚æœ Worker å¯ç”¨äº† ENABLE_AUTHï¼Œå¡«å†™è¿™é‡Œ">
            <div class="hint">åœ¨ Worker ç¯å¢ƒå˜é‡ä¸­é…ç½®çš„ AUTH_SECRETï¼ˆå¦‚æœå¯ç”¨äº†è®¿é—®æ§åˆ¶ï¼‰</div>
          </div>
        </div>

        <!-- é€‰æ‹©æœåŠ¡ -->
        <div class="section">
          <h3>ğŸ¯ é€‰æ‹© OCR æœåŠ¡</h3>
          <div class="service-select">
            <div class="service-btn active" id="mineruBtn" onclick="selectService('mineru')">
              <span class="emoji">â›ï¸</span>
              <div>MinerU</div>
              <div style="font-size: 12px; color: #999; margin-top: 5px;">ZIPæ‰“åŒ…ä¸‹è½½</div>
            </div>
            <div class="service-btn" id="doc2xBtn" onclick="selectService('doc2x')">
              <span class="emoji">ğŸ“</span>
              <div>Doc2X</div>
              <div style="font-size: 12px; color: #999; margin-top: 5px;">å¿«é€ŸMarkdown</div>
            </div>
          </div>
        </div>

        <!-- OCR Token é…ç½® -->
        <div class="section">
          <h3>ğŸ”‘ OCR Token é…ç½®</h3>

          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="tokenMode" value="frontend" checked onchange="updateTokenMode()">
              <span>å‰ç«¯é€ä¼  Tokenï¼ˆæ¨èï¼‰</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="tokenMode" value="worker" onchange="updateTokenMode()">
              <span>ä½¿ç”¨ Worker ç¯å¢ƒå˜é‡</span>
            </label>
          </div>

          <div id="frontendTokenSection">
            <div class="form-group" id="mineruTokenGroup">
              <label for="mineruToken">MinerU Token</label>
              <input type="password" id="mineruToken" placeholder="eyJ0eXBlIjoiSldUIi...">
              <div class="hint">ä» https://mineru.net è·å–ï¼Œæ ¼å¼ï¼šJWTï¼ˆeyJ å¼€å¤´ï¼‰</div>
            </div>
            <div class="form-group" id="doc2xTokenGroup" style="display: none;">
              <label for="doc2xToken">Doc2X Token</label>
              <input type="password" id="doc2xToken" placeholder="sk-xxx...">
              <div class="hint">ä» https://open.noedgeai.com è·å–ï¼Œæ ¼å¼ï¼šsk- å¼€å¤´</div>
            </div>
            <div class="token-mode-hint">
              ğŸ’¡ <strong>å‰ç«¯é€ä¼ æ¨¡å¼</strong>ï¼šé€šè¿‡è¯·æ±‚å¤´ï¼ˆX-MinerU-Key / X-Doc2X-Keyï¼‰ä¼ é€’ Tokenï¼ŒWorker æ— éœ€é…ç½®
            </div>
          </div>

          <div id="workerTokenSection" style="display: none;">
            <div class="token-mode-hint">
              ğŸ’¡ <strong>Worker é…ç½®æ¨¡å¼</strong>ï¼šOCR Token å­˜å‚¨åœ¨ Worker ç¯å¢ƒå˜é‡ä¸­ï¼ˆMINERU_API_TOKEN æˆ– DOC2X_API_TOKENï¼‰ï¼Œå‰ç«¯ä¸éœ€è¦æä¾›
            </div>
          </div>
        </div>

        <!-- ä¸Šä¼ åŒº -->
        <div class="section">
          <h3>ğŸ“ ä¸Šä¼ æ–‡ä»¶</h3>
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div style="font-size: 16px; margin-bottom: 8px;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
            <div style="color: #999; font-size: 14px;">
              æ”¯æŒ: PDF, DOC, DOCX, PPT, PPTX, PNG, JPG, JPEG
            </div>
            <div style="color: #999; font-size: 12px; margin-top: 5px;">
              MinerU: æœ€å¤§200MB, 600é¡µ | Doc2X: æœ€å¤§1GB, 1000é¡µ
            </div>
            <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg">
          </div>
          <div class="selected-file" id="selectedFile"></div>

          <!-- MinerU é€‰é¡¹ -->
          <div class="options" id="mineruOptions">
            <div class="option">
              <label>
                <input type="checkbox" id="isOcr" checked>
                å¯ç”¨ OCR è¯†åˆ«
              </label>
            </div>
            <div class="option">
              <label>
                <input type="checkbox" id="enableFormula" checked>
                è¯†åˆ«å…¬å¼
              </label>
            </div>
            <div class="option">
              <label>
                <input type="checkbox" id="enableTable" checked>
                è¯†åˆ«è¡¨æ ¼
              </label>
            </div>
          </div>

          <!-- Doc2X é€‰é¡¹ -->
          <div class="options" id="doc2xOptions" style="display: none;">
            <div class="form-group">
              <label for="formulaMode">å…¬å¼æ ¼å¼</label>
              <select id="formulaMode">
                <option value="dollar">Dollar æ¨¡å¼ï¼ˆ$ å’Œ $$ åŒ…è£¹å…¬å¼ï¼‰</option>
                <option value="normal">Normal æ¨¡å¼ï¼ˆLaTeX æ ¼å¼ï¼‰</option>
              </select>
              <div class="hint">Dollar æ¨¡å¼é€‚åˆå¤§å¤šæ•° Markdown ç¼–è¾‘å™¨ï¼Œæ¨èä½¿ç”¨</div>
            </div>

            <div class="form-group">
              <label for="exportFormat">å¯¼å‡ºæ ¼å¼ï¼ˆå¯é€‰ï¼‰</label>
              <select id="exportFormat">
                <option value="">ä»…è·å– Markdownï¼ˆä¸å¯¼å‡ºæ–‡ä»¶ï¼Œå†…å®¹æ°¸ä¹…æœ‰æ•ˆï¼‰</option>
                <option value="md">Markdown æ–‡ä»¶ (.md) - âš ï¸ é“¾æ¥5åˆ†é’Ÿæœ‰æ•ˆ</option>
                <option value="tex">LaTeX æ–‡ä»¶ (.tex) - âš ï¸ é“¾æ¥5åˆ†é’Ÿæœ‰æ•ˆ</option>
                <option value="docx">Word æ–‡æ¡£ (.docx) - âš ï¸ é“¾æ¥5åˆ†é’Ÿæœ‰æ•ˆ</option>
              </select>
              <div class="hint">å¯¼å‡ºæ–‡ä»¶çš„ä¸‹è½½é“¾æ¥åªæœ‰5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼Œè¶…æ—¶å¯ç‚¹å‡»"åˆ·æ–°é“¾æ¥"æŒ‰é’®</div>
            </div>
          </div>

          <button id="uploadBtn" disabled onclick="handleUpload()">å¼€å§‹å¤„ç†</button>
        </div>

        <!-- è¿›åº¦åŒº -->
        <div class="progress-section" id="progressSection">
          <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
          <div class="progress-bar">
            <div class="progress-bar-fill" id="progressBar"></div>
          </div>
        </div>

        <!-- ç»“æœåŒº -->
        <div class="result-section" id="resultSection"></div>

        <!-- æ—¥å¿—åŒº -->
        <div class="log-section" id="logSection"></div>
      </div>

      <!-- æŸ¥è¯¢ç»“æœæ ‡ç­¾é¡µ -->
      <div class="tab-content" id="queryTab">
        <div class="section">
          <h3>âš™ï¸ Worker é…ç½®</h3>
          <div class="form-group">
            <label for="queryWorkerUrl">Worker URL</label>
            <input type="text" id="queryWorkerUrl" placeholder="https://your-worker.workers.dev">
          </div>
          <div class="form-group">
            <label for="queryAuthKey">AUTH_SECRETï¼ˆå¯é€‰ï¼‰</label>
            <input type="password" id="queryAuthKey" placeholder="å¦‚æœ Worker å¯ç”¨äº† ENABLE_AUTHï¼Œå¡«å†™è¿™é‡Œ">
            <div class="hint">åœ¨ Worker ç¯å¢ƒå˜é‡ä¸­é…ç½®çš„ AUTH_SECRET</div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ¯ é€‰æ‹©æœåŠ¡</h3>
          <div class="service-select">
            <div class="service-btn active" id="queryMineruBtn" onclick="selectQueryService('mineru')">
              <span class="emoji">â›ï¸</span>
              <div>MinerU</div>
            </div>
            <div class="service-btn" id="queryDoc2xBtn" onclick="selectQueryService('doc2x')">
              <span class="emoji">ğŸ“</span>
              <div>Doc2X</div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ”‘ OCR Token é…ç½®</h3>

          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="queryTokenMode" value="frontend" checked onchange="updateQueryTokenMode()">
              <span>å‰ç«¯é€ä¼  Token</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="queryTokenMode" value="worker" onchange="updateQueryTokenMode()">
              <span>ä½¿ç”¨ Worker ç¯å¢ƒå˜é‡</span>
            </label>
          </div>

          <div id="queryFrontendTokenSection">
            <div class="form-group" id="queryMineruTokenGroup">
              <label for="queryMineruToken">MinerU Token</label>
              <input type="password" id="queryMineruToken" placeholder="eyJ0eXBlIjoiSldUIi...">
            </div>
            <div class="form-group" id="queryDoc2xTokenGroup" style="display: none;">
              <label for="queryDoc2xToken">Doc2X Token</label>
              <input type="password" id="queryDoc2xToken" placeholder="sk-xxx...">
            </div>
          </div>

          <div id="queryWorkerTokenSection" style="display: none;">
            <div class="token-mode-hint">
              ğŸ’¡ OCR Token å­˜å‚¨åœ¨ Worker ç¯å¢ƒå˜é‡ä¸­ï¼Œå‰ç«¯ä¸éœ€è¦æä¾›
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ” æŸ¥è¯¢å‚æ•°</h3>
          <div class="form-group" id="batchIdGroup">
            <label for="batchId">Batch ID (MinerU)</label>
            <input type="text" id="batchId" placeholder="4b886bc5-6dd1-42ed-a670-ced0f1c6af8a">
            <div class="hint">ä¸Šä¼ æ–‡ä»¶æ—¶è¿”å›çš„ batch_id</div>
          </div>
          <div class="form-group" id="uidGroup" style="display: none;">
            <label for="uid">UID (Doc2X)</label>
            <input type="text" id="uid" placeholder="xxx-xxx-xxx">
            <div class="hint">ä¸Šä¼ æ–‡ä»¶æ—¶è¿”å›çš„ uid</div>
          </div>
          <button onclick="handleQuery()">æŸ¥è¯¢ç»“æœ</button>
        </div>

        <div class="result-section" id="queryResultSection"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== å…¨å±€å˜é‡ =====
    let selectedFile = null;
    let currentService = 'mineru';
    let currentQueryService = 'mineru';

    // ===== åˆå§‹åŒ– =====
    window.onload = () => {
      // åŠ è½½é…ç½®
      document.getElementById('workerUrl').value = localStorage.getItem('workerUrl') || '';
      document.getElementById('mineruToken').value = localStorage.getItem('mineruToken') || '';
      document.getElementById('doc2xToken').value = localStorage.getItem('doc2xToken') || '';
      document.getElementById('authKey').value = localStorage.getItem('authKey') || '';

      document.getElementById('queryWorkerUrl').value = localStorage.getItem('workerUrl') || '';
      document.getElementById('queryMineruToken').value = localStorage.getItem('mineruToken') || '';
      document.getElementById('queryDoc2xToken').value = localStorage.getItem('doc2xToken') || '';
      document.getElementById('queryAuthKey').value = localStorage.getItem('authKey') || '';

      // ä¿å­˜é…ç½®
      ['workerUrl', 'mineruToken', 'doc2xToken', 'authKey'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', (e) => {
          localStorage.setItem(id, e.target.value);
          // åŒæ­¥åˆ°æŸ¥è¯¢æ ‡ç­¾é¡µ
          if (id === 'workerUrl') {
            document.getElementById('queryWorkerUrl').value = e.target.value;
          } else if (id === 'authKey') {
            document.getElementById('queryAuthKey').value = e.target.value;
          }
        });
      });

      // æŸ¥è¯¢æ ‡ç­¾é¡µçš„é…ç½®ä¹Ÿè¦åŒæ­¥
      ['queryWorkerUrl', 'queryAuthKey'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', (e) => {
          const mainId = id.replace('query', '').toLowerCase();
          const mappedId = mainId === 'workerurl' ? 'workerUrl' : 'authKey';
          localStorage.setItem(mappedId, e.target.value);
          document.getElementById(mappedId).value = e.target.value;
        });
      });

      log('é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…é…ç½®...', 'info');
    };

    // ===== æ ‡ç­¾é¡µåˆ‡æ¢ =====
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      if (tab === 'upload') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('uploadTab').classList.add('active');
      } else {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('queryTab').classList.add('active');
      }
    }

    // ===== æœåŠ¡é€‰æ‹© =====
    function selectService(service) {
      currentService = service;

      document.getElementById('mineruBtn').classList.toggle('active', service === 'mineru');
      document.getElementById('doc2xBtn').classList.toggle('active', service === 'doc2x');

      document.getElementById('mineruTokenGroup').style.display = service === 'mineru' ? 'block' : 'none';
      document.getElementById('doc2xTokenGroup').style.display = service === 'doc2x' ? 'block' : 'none';

      document.getElementById('mineruOptions').style.display = service === 'mineru' ? 'block' : 'none';
      document.getElementById('doc2xOptions').style.display = service === 'doc2x' ? 'block' : 'none';

      log(`åˆ‡æ¢åˆ° ${service === 'mineru' ? 'MinerU' : 'Doc2X'} æœåŠ¡`, 'info');
    }

    function selectQueryService(service) {
      currentQueryService = service;

      document.getElementById('queryMineruBtn').classList.toggle('active', service === 'mineru');
      document.getElementById('queryDoc2xBtn').classList.toggle('active', service === 'doc2x');

      document.getElementById('queryMineruTokenGroup').style.display = service === 'mineru' ? 'block' : 'none';
      document.getElementById('queryDoc2xTokenGroup').style.display = service === 'doc2x' ? 'block' : 'none';

      document.getElementById('batchIdGroup').style.display = service === 'mineru' ? 'block' : 'none';
      document.getElementById('uidGroup').style.display = service === 'doc2x' ? 'block' : 'none';
    }

    // ===== Token æ¨¡å¼åˆ‡æ¢ =====
    function updateTokenMode() {
      const mode = document.querySelector('input[name="tokenMode"]:checked').value;
      document.getElementById('frontendTokenSection').style.display = mode === 'frontend' ? 'block' : 'none';
      document.getElementById('workerTokenSection').style.display = mode === 'worker' ? 'block' : 'none';
    }

    function updateQueryTokenMode() {
      const mode = document.querySelector('input[name="queryTokenMode"]:checked').value;
      document.getElementById('queryFrontendTokenSection').style.display = mode === 'frontend' ? 'block' : 'none';
      document.getElementById('queryWorkerTokenSection').style.display = mode === 'worker' ? 'block' : 'none';
    }

    // ===== æ–‡ä»¶é€‰æ‹© =====
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) handleFileSelect(e.target.files[0]);
    });

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      if (e.dataTransfer.files[0]) handleFileSelect(e.dataTransfer.files[0]);
    });

    function handleFileSelect(file) {
      selectedFile = file;
      document.getElementById('selectedFile').textContent = `å·²é€‰æ‹©: ${file.name} (${formatSize(file.size)})`;
      document.getElementById('selectedFile').classList.add('active');
      document.getElementById('uploadBtn').disabled = false;
      document.getElementById('resultSection').style.display = 'none';
      log(`é€‰æ‹©æ–‡ä»¶: ${file.name}`, 'info');
    }

    // ===== ä¸Šä¼ å¤„ç† =====
    async function handleUpload() {
      const workerUrl = document.getElementById('workerUrl').value.trim();
      const tokenMode = document.querySelector('input[name="tokenMode"]:checked').value;

      if (!workerUrl) {
        alert('è¯·å¡«å†™ Worker URL');
        return;
      }

      if (!selectedFile) {
        alert('è¯·é€‰æ‹©æ–‡ä»¶');
        return;
      }

      // æ„å»ºè¯·æ±‚å¤´
      let headers = {};

      // 1. AUTH_SECRETï¼ˆWorker è®¿é—®æ§åˆ¶ï¼Œæ€»æ˜¯å°è¯•æ·»åŠ ï¼‰
      const authKey = document.getElementById('authKey').value.trim();
      if (authKey) {
        headers['X-Auth-Key'] = authKey;
      }

      // 2. OCR Token
      if (tokenMode === 'frontend') {
        const token = currentService === 'mineru'
          ? document.getElementById('mineruToken').value.trim()
          : document.getElementById('doc2xToken').value.trim();

        if (!token) {
          alert(`è¯·å¡«å†™ ${currentService === 'mineru' ? 'MinerU' : 'Doc2X'} Token`);
          return;
        }

        headers[currentService === 'mineru' ? 'X-MinerU-Key' : 'X-Doc2X-Key'] = token;
      }
      // Worker æ¨¡å¼ä¸‹ï¼ŒToken ä»ç¯å¢ƒå˜é‡è·å–ï¼Œä¸éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æä¾›

      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('progressSection').classList.add('active');
      document.getElementById('resultSection').style.display = 'none';

      try {
        if (currentService === 'mineru') {
          await handleMinerUUpload(workerUrl, headers);
        } else {
          await handleDoc2XUpload(workerUrl, headers);
        }
      } catch (error) {
        log(`é”™è¯¯: ${error.message}`, 'error');
        showResult(false, `<h4>âŒ é”™è¯¯</h4><p>${error.message}</p>`);
      } finally {
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('progressSection').classList.remove('active');
      }
    }

    async function handleMinerUUpload(workerUrl, headers) {
      log('å¼€å§‹ä¸Šä¼ åˆ° MinerU...', 'info');
      updateProgress('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 10);

      const isOcr = document.getElementById('isOcr').checked;
      const enableFormula = document.getElementById('enableFormula').checked;
      const enableTable = document.getElementById('enableTable').checked;

      log(`å‚æ•°: OCR=${isOcr}, å…¬å¼=${enableFormula}, è¡¨æ ¼=${enableTable}`, 'info');

      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('is_ocr', isOcr.toString());
      formData.append('enable_formula', enableFormula.toString());
      formData.append('enable_table', enableTable.toString());

      const uploadRes = await fetch(`${workerUrl}/mineru/upload`, {
        method: 'POST',
        headers,
        body: formData
      });

      if (!uploadRes.ok) {
        const error = await uploadRes.json().catch(() => ({ error: uploadRes.statusText }));
        throw new Error(error.error || 'ä¸Šä¼ å¤±è´¥');
      }

      const { batch_id } = await uploadRes.json();
      log(`ä¸Šä¼ æˆåŠŸï¼Œbatch_id: ${batch_id}`, 'success');

      // è½®è¯¢ç»“æœ
      updateProgress('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨å¤„ç†...', 20);
      const result = await pollMinerUResult(workerUrl, headers, batch_id);

      if (result.state === 'done') {
        updateProgress('å¤„ç†å®Œæˆï¼', 100);
        log('å¤„ç†å®Œæˆï¼', 'success');

        const downloadUrl = result.full_zip_url || result.fullZipUrl;

        if (downloadUrl) {
          log(`ä¸‹è½½åœ°å€: ${downloadUrl}`, 'success');
          showResult(true, `
            <h4>âœ… å¤„ç†æˆåŠŸ!</h4>
            <p><strong>æ–‡ä»¶å:</strong> ${result.file_name || selectedFile.name}</p>
            <p><strong>Batch ID:</strong> ${batch_id}</p>
            <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 12px; border-radius: 6px; margin: 10px 0; color: #155724;">
              âœ… <strong>æ–‡ä»¶å·²å¤„ç†å®Œæˆ</strong>ï¼šMinerU ä¸‹è½½é“¾æ¥æœ‰æ•ˆæœŸ 24 å°æ—¶
            </div>
            <p><strong>ä¸‹è½½æ–‡ä»¶:</strong></p>
            <div style="margin-top: 10px;">
              <a href="${downloadUrl}" target="_blank" style="display: inline-block; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                ğŸ“¥ ä¸‹è½½ ZIP å‹ç¼©åŒ…
              </a>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #666; word-break: break-all;">
              ${downloadUrl}
            </div>
          `);

          // è‡ªåŠ¨æ‰“å¼€ä¸‹è½½é“¾æ¥
          setTimeout(() => {
            window.open(downloadUrl, '_blank');
          }, 500);
        } else {
          log(`è­¦å‘Š: æœªæ‰¾åˆ°ä¸‹è½½é“¾æ¥ï¼Œå®Œæ•´ç»“æœ: ${JSON.stringify(result)}`, 'error');
          showResult(true, `
            <h4>âš ï¸ å¤„ç†å®Œæˆï¼Œä½†æœªæ‰¾åˆ°ä¸‹è½½é“¾æ¥</h4>
            <p><strong>Batch ID:</strong> ${batch_id}</p>
            <p>å®Œæ•´å“åº”æ•°æ®ï¼š</p>
            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(result, null, 2)}</pre>
          `);
        }
      } else {
        throw new Error(result.err_msg || 'å¤„ç†å¤±è´¥');
      }
    }

    async function handleDoc2XUpload(workerUrl, headers) {
      log('å¼€å§‹ä¸Šä¼ åˆ° Doc2X...', 'info');
      updateProgress('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 10);

      const formData = new FormData();
      formData.append('file', selectedFile);

      const uploadRes = await fetch(`${workerUrl}/doc2x/upload`, {
        method: 'POST',
        headers,
        body: formData
      });

      if (!uploadRes.ok) {
        const error = await uploadRes.json().catch(() => ({ error: uploadRes.statusText }));
        throw new Error(error.error || 'ä¸Šä¼ å¤±è´¥');
      }

      const { uid } = await uploadRes.json();
      log(`ä¸Šä¼ æˆåŠŸï¼Œuid: ${uid}`, 'success');

      // è½®è¯¢çŠ¶æ€
      updateProgress('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨å¤„ç†...', 20);
      const result = await pollDoc2XStatus(workerUrl, headers, uid);

      if (result.status === 'success') {
        updateProgress('å¤„ç†å®Œæˆï¼', 100);
        log('å¤„ç†å®Œæˆï¼', 'success');

        let resultHtml = `
          <h4>âœ… å¤„ç†æˆåŠŸ!</h4>
          <p><strong>æ–‡ä»¶å:</strong> ${selectedFile.name}</p>
          <p><strong>UID:</strong> ${uid}</p>
          <p><strong>è¿›åº¦:</strong> ${result.progress}%</p>
        `;

        // å¦‚æœæœ‰ Markdown ç»“æœ
        if (result.result?.pages) {
          const pageCount = result.result.pages.length;
          let markdownText = '';

          // æå–çº¯æ–‡æœ¬ Markdown
          result.result.pages.forEach((page, index) => {
            if (page.md) {
              markdownText += `\n\n--- ç¬¬ ${index + 1} é¡µ ---\n\n${page.md}`;
            }
          });

          resultHtml += `
            <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 12px; border-radius: 6px; margin: 10px 0; color: #155724;">
              âœ… <strong>Markdown å†…å®¹å·²è·å–</strong>ï¼šæ°¸ä¹…æœ‰æ•ˆï¼Œå¯éšæ—¶å¤åˆ¶ä½¿ç”¨
            </div>
            <p><strong>Markdown å†…å®¹:</strong> å…± ${pageCount} é¡µ</p>
            <div style="margin-top: 10px;">
              <button onclick="copyMarkdown()" style="width: auto; padding: 8px 16px; font-size: 14px;">ğŸ“‹ å¤åˆ¶å…¨éƒ¨ Markdown</button>
            </div>
            <pre id="markdownContent" style="max-height: 200px;">${escapeHtml(markdownText.substring(0, 2000))}${markdownText.length > 2000 ? '\n\n... (å†…å®¹è¿‡é•¿ï¼Œè¯·ä½¿ç”¨å¯¼å‡ºåŠŸèƒ½æˆ–å¤åˆ¶æŒ‰é’®)' : ''}</pre>
          `;

          // ä¿å­˜å®Œæ•´ Markdown åˆ°å…¨å±€å˜é‡
          window.fullMarkdownContent = markdownText;
        }

        // å¦‚æœéœ€è¦å¯¼å‡º
        const exportFormat = document.getElementById('exportFormat').value;
        if (exportFormat) {
          const formulaMode = document.getElementById('formulaMode').value;
          log(`è¯·æ±‚å¯¼å‡ºä¸º ${exportFormat}ï¼ˆå…¬å¼æ ¼å¼ï¼š${formulaMode}ï¼‰...`, 'info');
          const exportUrl = await requestDoc2XExport(workerUrl, headers, uid, exportFormat, formulaMode);
          log(`å¯¼å‡ºæˆåŠŸï¼Œé“¾æ¥5åˆ†é’Ÿå†…æœ‰æ•ˆ`, 'success');

          resultHtml += `
            <p><strong>å¯¼å‡ºæ–‡ä»¶:</strong></p>
            <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 6px; margin: 10px 0; color: #856404;">
              âš ï¸ <strong>æ³¨æ„ï¼š</strong>ä¸‹è½½é“¾æ¥æœ‰æ•ˆæœŸä¸º 5 åˆ†é’Ÿï¼Œè¯·ç«‹å³ä¸‹è½½ï¼
            </div>
            <div style="margin-top: 10px;">
              <a href="${exportUrl}" download target="_blank" id="exportDownloadLink" style="display: inline-block; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                ğŸ“¥ ä¸‹è½½ ${exportFormat.toUpperCase()} æ–‡ä»¶
              </a>
              <button onclick="refreshExportLink('${uid}', '${exportFormat}', '${formulaMode}')" style="display: inline-block; padding: 10px 20px; margin-left: 10px; background: #007bff; width: auto; font-size: 14px;">
                ğŸ”„ åˆ·æ–°ä¸‹è½½é“¾æ¥
              </button>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #666; word-break: break-all;">
              ${exportUrl}
            </div>
          `;

          // è‡ªåŠ¨è§¦å‘ä¸‹è½½
          setTimeout(() => {
            window.open(exportUrl, '_blank');
          }, 500);
        }

        showResult(true, resultHtml);
      } else {
        throw new Error('å¤„ç†å¤±è´¥');
      }
    }

    async function pollMinerUResult(workerUrl, headers, batchId, maxAttempts = 100) {
      for (let i = 0; i < maxAttempts; i++) {
        const res = await fetch(`${workerUrl}/mineru/result/${batchId}`, { headers });
        if (!res.ok) throw new Error('æŸ¥è¯¢å¤±è´¥');

        const data = await res.json();
        const result = data.extract_result[0];

        if (result.state === 'running' && result.extract_progress) {
          const { extracted_pages, total_pages } = result.extract_progress;
          const percent = Math.floor((extracted_pages / total_pages) * 70) + 20;
          updateProgress(`æ­£åœ¨å¤„ç†: ${extracted_pages}/${total_pages} é¡µ`, percent);
          log(`å¤„ç†è¿›åº¦: ${extracted_pages}/${total_pages} é¡µ`, 'info');
        }

        if (result.state === 'done' || result.state === 'failed') {
          return result;
        }

        await sleep(3000);
      }
      throw new Error('å¤„ç†è¶…æ—¶');
    }

    async function pollDoc2XStatus(workerUrl, headers, uid, maxAttempts = 100) {
      for (let i = 0; i < maxAttempts; i++) {
        const res = await fetch(`${workerUrl}/doc2x/status/${uid}`, { headers });
        if (!res.ok) throw new Error('æŸ¥è¯¢å¤±è´¥');

        const data = await res.json();

        if (data.progress) {
          updateProgress(`æ­£åœ¨å¤„ç†: ${data.progress}%`, Math.min(20 + data.progress * 0.7, 90));
          log(`å¤„ç†è¿›åº¦: ${data.progress}%`, 'info');
        }

        if (data.status === 'success' || data.status === 'failed') {
          return data;
        }

        await sleep(3000);
      }
      throw new Error('å¤„ç†è¶…æ—¶');
    }

    async function requestDoc2XExport(workerUrl, headers, uid, format, formulaMode = 'dollar') {
      const res = await fetch(`${workerUrl}/doc2x/convert`, {
        method: 'POST',
        headers: { ...headers, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          uid,
          to: format,
          formula_mode: formulaMode
        })
      });

      if (!res.ok) throw new Error('å¯¼å‡ºè¯·æ±‚å¤±è´¥');

      // è½®è¯¢å¯¼å‡ºç»“æœ
      for (let i = 0; i < 50; i++) {
        await sleep(2000);
        const resultRes = await fetch(`${workerUrl}/doc2x/convert/result/${uid}`, { headers });
        if (!resultRes.ok) continue;

        const data = await resultRes.json();
        if (data.status === 'success' && data.url) {
          log(`å¯¼å‡ºæˆåŠŸ: ${data.url}`, 'success');
          return data.url;
        }
      }

      throw new Error('å¯¼å‡ºè¶…æ—¶');
    }

    // ===== æŸ¥è¯¢ç»“æœ =====
    async function handleQuery() {
      const workerUrl = document.getElementById('queryWorkerUrl').value.trim();
      const tokenMode = document.querySelector('input[name="queryTokenMode"]:checked').value;

      if (!workerUrl) {
        alert('è¯·å¡«å†™ Worker URL');
        return;
      }

      // æ„å»ºè¯·æ±‚å¤´
      let headers = {};

      // 1. AUTH_SECRETï¼ˆWorker è®¿é—®æ§åˆ¶ï¼Œæ€»æ˜¯å°è¯•æ·»åŠ ï¼‰
      const authKey = document.getElementById('queryAuthKey').value.trim();
      if (authKey) {
        headers['X-Auth-Key'] = authKey;
      }

      // 2. OCR Token
      if (tokenMode === 'frontend') {
        const token = currentQueryService === 'mineru'
          ? document.getElementById('queryMineruToken').value.trim()
          : document.getElementById('queryDoc2xToken').value.trim();

        if (!token) {
          alert(`è¯·å¡«å†™ ${currentQueryService === 'mineru' ? 'MinerU' : 'Doc2X'} Token`);
          return;
        }

        headers[currentQueryService === 'mineru' ? 'X-MinerU-Key' : 'X-Doc2X-Key'] = token;
      }
      // Worker æ¨¡å¼ä¸‹ï¼ŒToken ä»ç¯å¢ƒå˜é‡è·å–ï¼Œä¸éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æä¾›

      try {
        if (currentQueryService === 'mineru') {
          const batchId = document.getElementById('batchId').value.trim();
          if (!batchId) {
            alert('è¯·å¡«å†™ Batch ID');
            return;
          }

          const res = await fetch(`${workerUrl}/mineru/result/${batchId}`, { headers });
          if (!res.ok) throw new Error('æŸ¥è¯¢å¤±è´¥');

          const data = await res.json();
          const result = data.extract_result[0];

          if (result.state === 'done') {
            showQueryResult(true, `
              <h4>âœ… å¤„ç†å®Œæˆ</h4>
              <p><strong>çŠ¶æ€:</strong> ${result.state}</p>
              <p><strong>ä¸‹è½½:</strong> <a href="${result.full_zip_url}" target="_blank">${result.full_zip_url}</a></p>
              <pre>${JSON.stringify(result, null, 2)}</pre>
            `);
          } else if (result.state === 'running') {
            const { extracted_pages, total_pages } = result.extract_progress || {};
            showQueryResult(true, `
              <h4>â³ å¤„ç†ä¸­...</h4>
              <p><strong>è¿›åº¦:</strong> ${extracted_pages}/${total_pages} é¡µ</p>
            `);
          } else {
            showQueryResult(true, `<pre>${JSON.stringify(result, null, 2)}</pre>`);
          }
        } else {
          const uid = document.getElementById('uid').value.trim();
          if (!uid) {
            alert('è¯·å¡«å†™ UID');
            return;
          }

          const res = await fetch(`${workerUrl}/doc2x/status/${uid}`, { headers });
          if (!res.ok) throw new Error('æŸ¥è¯¢å¤±è´¥');

          const data = await res.json();

          if (data.status === 'success') {
            let resultHtml = `
              <h4>âœ… å¤„ç†å®Œæˆ</h4>
              <p><strong>è¿›åº¦:</strong> ${data.progress}%</p>
            `;

            // å¦‚æœæœ‰ Markdown ç»“æœ
            if (data.result?.pages) {
              const pageCount = data.result.pages.length;
              let markdownText = '';

              // æå–çº¯æ–‡æœ¬ Markdown
              data.result.pages.forEach((page, index) => {
                if (page.md) {
                  markdownText += `\n\n--- ç¬¬ ${index + 1} é¡µ ---\n\n${page.md}`;
                }
              });

              resultHtml += `
                <p><strong>Markdown å†…å®¹:</strong> å…± ${pageCount} é¡µ</p>
                <div style="margin-top: 10px;">
                  <button onclick="copyMarkdown()" style="width: auto; padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer;">ğŸ“‹ å¤åˆ¶å…¨éƒ¨ Markdown</button>
                </div>
                <pre style="max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 6px; margin-top: 10px;">${escapeHtml(markdownText.substring(0, 2000))}${markdownText.length > 2000 ? '\n\n... (å†…å®¹è¿‡é•¿ï¼Œè¯·ä½¿ç”¨å¤åˆ¶æŒ‰é’®)' : ''}</pre>
              `;

              // ä¿å­˜å®Œæ•´ Markdown åˆ°å…¨å±€å˜é‡
              window.fullMarkdownContent = markdownText;
            }

            showQueryResult(true, resultHtml);
          } else {
            showQueryResult(true, `
              <h4>â³ å¤„ç†ä¸­...</h4>
              <p><strong>çŠ¶æ€:</strong> ${data.status}</p>
              <p><strong>è¿›åº¦:</strong> ${data.progress || 0}%</p>
            `);
          }
        }
      } catch (error) {
        showQueryResult(false, `<h4>âŒ é”™è¯¯</h4><p>${error.message}</p>`);
      }
    }

    // ===== å·¥å…·å‡½æ•° =====
    function updateProgress(text, percent) {
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressBar').style.width = `${percent}%`;
    }

    function showResult(success, html) {
      const section = document.getElementById('resultSection');
      section.className = `result-section ${success ? 'success' : 'error'}`;
      section.innerHTML = html;
    }

    function showQueryResult(success, html) {
      const section = document.getElementById('queryResultSection');
      section.className = `result-section ${success ? 'success' : 'error'}`;
      section.innerHTML = html;
    }

    function log(message, type = 'info') {
      const logItem = document.createElement('div');
      logItem.className = `log-item ${type}`;
      logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      document.getElementById('logSection').appendChild(logItem);
      document.getElementById('logSection').scrollTop = document.getElementById('logSection').scrollHeight;
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1024 / 1024).toFixed(1) + ' MB';
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyMarkdown() {
      const content = window.fullMarkdownContent || '';
      if (!content) {
        alert('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
        return;
      }

      navigator.clipboard.writeText(content).then(() => {
        alert('âœ… Markdown å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        log('Markdown å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      }).catch(err => {
        alert('å¤åˆ¶å¤±è´¥: ' + err.message);
        log('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
      });
    }

    async function refreshExportLink(uid, format, formulaMode = 'dollar') {
      try {
        log('æ­£åœ¨åˆ·æ–°ä¸‹è½½é“¾æ¥...', 'info');

        const workerUrl = document.getElementById('workerUrl').value.trim();
        const tokenMode = document.querySelector('input[name="tokenMode"]:checked').value;

        // æ„å»ºè¯·æ±‚å¤´
        let headers = {};
        const authKey = document.getElementById('authKey').value.trim();
        if (authKey) {
          headers['X-Auth-Key'] = authKey;
        }

        if (tokenMode === 'frontend') {
          const token = document.getElementById('doc2xToken').value.trim();
          if (token) {
            headers['X-Doc2X-Key'] = token;
          }
        }

        // é‡æ–°è¯·æ±‚å¯¼å‡ºé“¾æ¥
        const newUrl = await requestDoc2XExport(workerUrl, headers, uid, format, formulaMode);

        // æ›´æ–°é¡µé¢ä¸Šçš„é“¾æ¥
        const linkElement = document.getElementById('exportDownloadLink');
        if (linkElement) {
          linkElement.href = newUrl;
        }

        log('ä¸‹è½½é“¾æ¥å·²åˆ·æ–°ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰', 'success');
        alert('âœ… ä¸‹è½½é“¾æ¥å·²åˆ·æ–°ï¼æœ‰æ•ˆæœŸ5åˆ†é’Ÿ');

        // è‡ªåŠ¨æ‰“å¼€æ–°é“¾æ¥
        window.open(newUrl, '_blank');

      } catch (error) {
        log('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
        alert('åˆ·æ–°å¤±è´¥: ' + error.message);
      }
    }
  </script>
</body>
</html>
