/**
 * TOC (Table of Contents) ç»„ä»¶æ ·å¼
 *
 * èŒè´£ï¼šç›®å½•æµ®åŠ¨æŒ‰é’®ã€å¼¹çª—ã€åˆ—è¡¨é¡¹ã€å±‚çº§ç»“æ„ç­‰å®Œæ•´æ ·å¼
 * ä½œç”¨åŸŸï¼š#toc-float-btn, #toc-popup åŠå…¶å­å…ƒç´ 
 * ä¾èµ–ï¼švariables.css
 *
 * åˆå¹¶è‡ªï¼š
 * - history_detail/toc-base.css (åŸºç¡€æ ·å¼)
 * - history_detail/toc-extensions.css (æ‰©å±•åŠŸèƒ½)
 * - toc-optimized.css (ç°ä»£åŒ–è®¾è®¡ï¼Œéƒ¨åˆ†é‡‡çº³)
 *
 * é‡æ„è¯´æ˜ï¼š
 * 1. ä½¿ç”¨ CSS å˜é‡æ›¿æ¢ç¡¬ç¼–ç å€¼
 * 2. ç§»é™¤å¤§éƒ¨åˆ† !importantï¼ˆä¿ç•™å°‘æ•°å¿…è¦çš„ï¼‰
 * 3. ä¿æŒå‘åå…¼å®¹ï¼ˆID é€‰æ‹©å™¨ï¼‰
 * 4. æ¶ˆé™¤ä¸‰ä¸ªæ–‡ä»¶ä¹‹é—´çš„æ ·å¼å†²çª
 */

/* ==================== 1. TOC æµ®åŠ¨æŒ‰é’® ==================== */

#toc-float-btn {
  position: fixed;
  left: var(--toc-button-left);
  top: var(--toc-button-top);
  z-index: var(--toc-button-z-index);

  /* å°ºå¯¸ - ç”± .tiny-round-btn ç±»æ§åˆ¶ï¼Œæ­¤å¤„ä¿ç•™å…¼å®¹æ€§ */
  width: var(--toc-button-size);
  height: var(--toc-button-size);

  /* å¸ƒå±€ */
  display: flex;
  align-items: center;
  justify-content: center;

  /* äº¤äº’ */
  cursor: pointer;
  transition: background var(--transition-fast),
              transform var(--transition-fast);
}

#toc-float-btn:hover {
  transform: scale(1.1);
}

#toc-float-btn:active {
  transform: scale(0.95);
}

/* TOC æŒ‰é’®å›¾æ ‡ - ç”± .tiny-round-btn æ§åˆ¶ï¼Œæ­¤å¤„ä¿ç•™æ–‡æ¡£ */
#toc-float-btn i {
  /* æ ·å¼ç”± .tiny-round-btn > i æ§åˆ¶ */
}

/* ==================== 2. TOC å¼¹çª—å®¹å™¨ ==================== */

#toc-popup {
  /* æ˜¾ç¤ºæ§åˆ¶ */
  display: none;

  /* å®šä½ */
  position: fixed;
  left: var(--toc-popup-left);
  top: var(--toc-popup-top);
  z-index: var(--toc-popup-z-index);

  /* å°ºå¯¸ */
  width: var(--toc-popup-width);
  max-width: 85vw;
  max-height: var(--toc-popup-max-height);

  /* æ ·å¼ */
  background: var(--color-bg-overlay);
  border: 1px solid var(--color-border-light);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-float);

  /* åŠ¨ç”» */
  transition: opacity var(--transition-base),
              transform var(--transition-base),
              width var(--transition-base);
  transform: translateY(-10px);
  opacity: 0;

  /* æº¢å‡ºæ§åˆ¶ */
  overflow: hidden;
}

/* TOC å¼¹çª—æ˜¾ç¤ºçŠ¶æ€ */
#toc-popup.toc-popup-visible,
#toc-popup.visible {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* TOC å¼¹çª—éšè—åŠ¨ç”» */
#toc-popup.toc-popup-hiding {
  opacity: 0;
  transform: translateY(-10px);
}

/* TOC å±•å¼€æ¨¡å¼ */
#toc-popup.toc-expanded {
  width: 440px; /* å±•å¼€åˆ°2å€å®½åº¦ */
}

/* ==================== 3. TOC å¼¹çª—å¤´éƒ¨ ==================== */

#toc-popup-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--spacing-sm) var(--spacing-md);
  border-bottom: 1px solid var(--color-border-light);
  background: rgba(59, 130, 246, 0.05);
}

#toc-popup-header span {
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-base);
  color: var(--color-text-primary);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

#toc-popup-header i {
  color: var(--color-primary);
  font-size: var(--font-size-md);
}

/* å…³é—­æŒ‰é’® */
#toc-popup-close-btn {
  background: transparent;
  border: none;
  border-radius: var(--radius-md);
  padding: var(--spacing-xs) var(--spacing-sm);
  cursor: pointer;
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  transition: background var(--transition-fast),
              color var(--transition-fast);
}

#toc-popup-close-btn:hover {
  background: rgba(59, 130, 246, 0.1);
  color: var(--color-primary);
}

/* å±•å¼€æŒ‰é’® */
#toc-expand-btn {
  position: absolute;
  right: var(--spacing-sm);
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  color: var(--color-primary);
  cursor: pointer;
  font-size: var(--font-size-lg);
  padding: var(--spacing-xs);
  border-radius: var(--radius-sm);
  line-height: 1;
  opacity: 0.7;
  transition: opacity var(--transition-fast),
              background-color var(--transition-fast);
}

#toc-expand-btn:hover {
  opacity: 1;
  background-color: rgba(59, 130, 246, 0.1);
}

/* ==================== 4. TOC æ¨¡å¼é€‰æ‹©å™¨ ==================== */

.toc-mode-selector {
  display: none; /* é»˜è®¤éšè—ï¼Œç”± JavaScript æ§åˆ¶æ˜¾ç¤º */
  gap: var(--spacing-xs);
  margin: var(--spacing-sm) var(--spacing-md);
  padding: var(--spacing-xs);
  background-color: var(--color-bg-secondary);
  border-radius: var(--radius-md);
  justify-content: center;
}

.toc-mode-btn {
  padding: var(--spacing-xs) var(--spacing-sm);
  border: 1px solid var(--color-border-medium);
  border-radius: var(--radius-sm);
  background-color: var(--color-bg-base);
  color: var(--color-text-secondary);
  cursor: pointer;
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
  transition: all var(--transition-base);
  user-select: none;
}

.toc-mode-btn:hover {
  background: rgba(59, 130, 246, 0.1);
  color: var(--color-primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.toc-mode-btn.active {
  background: var(--color-primary);
  color: var(--color-text-inverse);
  border-color: var(--color-primary);
  box-shadow: var(--shadow-md);
}

/* ==================== 5. TOC åˆ—è¡¨å®¹å™¨ ==================== */

#toc-list {
  list-style: none;
  padding: var(--spacing-sm) 0;
  margin: 0;
  font-size: var(--font-size-sm);
  max-height: 60vh;
  overflow-y: auto;

  /* æ»šåŠ¨æ¡æ ·å¼ */
  scrollbar-width: thin;
  scrollbar-color: var(--color-border-medium) transparent;
}

#toc-list::-webkit-scrollbar {
  width: 6px;
}

#toc-list::-webkit-scrollbar-track {
  background: transparent;
}

#toc-list::-webkit-scrollbar-thumb {
  background: var(--color-border-medium);
  border-radius: var(--radius-sm);
  transition: background var(--transition-fast);
}

#toc-list::-webkit-scrollbar-thumb:hover {
  background: var(--color-border-dark);
}

/* TOC å­é¡¹å®¹å™¨ */
#toc-list ul.toc-children {
  list-style: none;
  padding-left: 0;
  margin: 0;
  overflow: hidden;
  transition: height var(--transition-base),
              opacity var(--transition-base);
}

/* æŠ˜å çŠ¶æ€ä¸‹çš„å­é¡¹å®¹å™¨ */
#toc-list .toc-children.collapsed {
  height: 0 !important; /* !important å¿…è¦ï¼Œç”¨äºè¦†ç›– JS è®¾ç½®çš„é«˜åº¦ */
  margin: 0;
  padding: 0;
  opacity: 0;
}

/* ==================== 6. TOC åˆ—è¡¨é¡¹æ ·å¼ ==================== */

#toc-list li {
  margin-bottom: 0;
  line-height: var(--line-height-base);
  position: relative;
}

/* ä¸åŒå±‚çº§æ ‡é¢˜çš„é—´è· */
#toc-list li.toc-h1 {
  margin-top: var(--spacing-sm);
}

#toc-list li.toc-h2 {
  margin-top: var(--spacing-xs);
}

#toc-list li.toc-h3,
#toc-list li.toc-h4,
#toc-list li.toc-h5,
#toc-list li.toc-h6 {
  margin-top: 2px;
}

/* TOC é“¾æ¥æ ·å¼ */
#toc-list li a {
  display: block;
  padding: var(--toc-item-padding-y) var(--toc-item-padding-x);
  color: var(--color-text-primary);
  text-decoration: none;
  font-weight: var(--font-weight-medium);
  transition: background var(--transition-fast),
              color var(--transition-fast),
              border-left-color var(--transition-fast);
  border-left: 3px solid var(--color-border-light);

  /* å¤šè¡Œæ”¯æŒ */
  white-space: normal;
  word-break: break-word;
  line-height: 1.3;
  padding-right: var(--spacing-sm);
}

#toc-list li a:hover {
  background: var(--color-bg-secondary);
  color: var(--color-text-primary);
  border-left-color: var(--color-primary);
}

#toc-list li a.active {
  background: var(--color-selection-bg);
  color: var(--color-primary);
  border-left-color: var(--color-primary);
  font-weight: var(--font-weight-semibold);
}

/* ä¸åŒå±‚çº§æ ‡é¢˜çš„ç¼©è¿›å’Œå­—ä½“å¤§å° */
#toc-list li.toc-h2 a {
  padding-left: calc(var(--toc-item-padding-x) + var(--toc-indent-width));
  font-size: 0.95em;
}

#toc-list li.toc-h3 a {
  padding-left: calc(var(--toc-item-padding-x) + var(--toc-indent-width) * 2);
  font-size: 0.88em;
  color: var(--color-text-secondary);
}

#toc-list li.toc-h3 a:hover {
  color: var(--color-primary);
}

#toc-list li.toc-h4 a {
  padding-left: calc(var(--toc-item-padding-x) + var(--toc-indent-width) * 3);
  font-size: 0.85em;
}

#toc-list li.toc-h5 a {
  padding-left: calc(var(--toc-item-padding-x) + var(--toc-indent-width) * 4);
  font-size: 0.83em;
}

#toc-list li.toc-h6 a {
  padding-left: calc(var(--toc-item-padding-x) + var(--toc-indent-width) * 5);
  font-size: 0.8em;
}

/* ==================== 7. æŠ˜å /å±•å¼€åŠŸèƒ½ ==================== */

/* æŠ˜å æŒ‰é’® */
#toc-list .toc-toggle {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  text-align: center;
  line-height: 16px;
  margin-right: var(--spacing-xs);
  font-size: 10px;
  color: var(--color-text-secondary);
  transition: transform var(--transition-fast),
              color var(--transition-fast),
              background-color var(--transition-fast);
  cursor: pointer;
  border-radius: var(--radius-sm);
}

#toc-list .toc-toggle:hover {
  color: var(--color-primary);
  background-color: rgba(59, 130, 246, 0.1);
}

#toc-list .toc-toggle.collapsed {
  transform: rotate(-90deg);
}

/* æœ‰å­é¡¹çš„ TOC é¡¹æ ·å¼ */
#toc-list li.has-children > a {
  font-weight: var(--font-weight-semibold);
}

/* ä¿®å¤æ‚¬åœçŠ¶æ€ä¸æŠ˜å çŠ¶æ€çš„å†²çª */
#toc-list li a:hover .toc-toggle {
  color: var(--color-primary);
}

/* ==================== 8. TOC æ–‡æœ¬å†…å®¹ç»“æ„ ==================== */

/* å¤šè¡Œ TOC æ–‡æœ¬å¸ƒå±€ */
#toc-list .toc-text {
  display: flex;
  flex-wrap: wrap;
  align-items: baseline;
  line-height: 1.5;
  width: 100%;
  padding: 0;
  margin: 0;
  font-size: var(--font-size-xs);
}

#toc-list li.has-children > a .toc-text {
  padding-left: 0;
}

/* TOC å†…å®¹ */
.toc-content {
  display: inline-block;
  flex: 1;
  min-width: 0;
  word-break: break-word;
  overflow-wrap: break-word;
  white-space: normal;
  font-weight: var(--font-weight-normal);
}

/* TOC è‹±æ–‡ç¿»è¯‘ */
#toc-list span.toc-en-translation,
.toc-en-translation {
  font-size: 0.85em;
  color: var(--color-text-muted);
  margin-left: var(--spacing-xs);
  font-weight: var(--font-weight-normal);
  font-style: italic;
}

/* éå±•å¼€æ¨¡å¼ä¸‹çš„æ–‡æœ¬æ˜¾ç¤ºé™åˆ¶ */
#toc-popup:not(.toc-expanded) .toc-text {
  max-height: 3.9em; /* ä¸‰è¡Œæ–‡æœ¬é«˜åº¦ */
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

/* å±•å¼€æ¨¡å¼ä¸‹å–æ¶ˆæ–‡æœ¬é™åˆ¶ */
#toc-popup.toc-expanded .toc-text {
  max-height: none;
  display: flex;
  flex-wrap: wrap;
  align-items: baseline;
  -webkit-line-clamp: unset;
}

/* ==================== 9. ç»“æ„åŒ–æ ‡é¢˜æ ·å¼ ==================== */

/* é€šç”¨ç»“æ„åŒ–æ ‡é¢˜æ ·å¼ */
.toc-structured .toc-prefix {
  font-weight: var(--font-weight-bold);
  color: var(--color-primary);
  margin-right: var(--spacing-xs);
  display: inline-block;
  font-family: var(--font-family-monospace);
  background: rgba(59, 130, 246, 0.1);
  padding: 2px 6px;
  border-radius: var(--radius-sm);
  font-size: 0.85em;
}

.toc-structured .toc-content {
  padding-left: 0;
  margin-left: 2px;
}

/* ç»“æ„åŒ–æ ‡é¢˜é¦–å­—æ¯ - é¿å…ä¸å‰ç¼€å†²çª */
.toc-structured .toc-content::first-letter {
  font-weight: var(--font-weight-normal);
  color: inherit;
}

/* ç« èŠ‚æ ‡é¢˜æ ·å¼ï¼ˆå¦‚"ç¬¬ä¸€ç« "ï¼‰ */
.toc-structure-chapter .toc-prefix {
  background: rgba(220, 38, 38, 0.1);
  color: #dc2626;
  font-size: 1.1em;
}

/* æ•°å­—ç¼–å·æ ‡é¢˜æ ·å¼ï¼ˆå¦‚"1.1"ï¼‰ */
.toc-structure-numeric .toc-prefix {
  font-family: var(--font-family-monospace);
  letter-spacing: 0.5px;
}

/* ç½—é©¬æ•°å­—æ ‡é¢˜æ ·å¼ */
.toc-structure-roman .toc-prefix {
  font-style: italic;
  color: #6a1b9a;
}

/* å­—æ¯æ ‡é¢˜æ ·å¼ */
.toc-structure-letter .toc-prefix {
  color: #00695c;
}

/* ç»“æ„åŒ–æ ‡é¢˜ç¼©è¿›ä¼˜åŒ– */
#toc-list > li.toc-structured {
  padding-left: 0;
}

#toc-list .toc-structured.toc-h1 { padding-left: 0; }
#toc-list .toc-structured.toc-h2 { padding-left: var(--spacing-md); }
#toc-list .toc-structured.toc-h3 { padding-left: calc(var(--spacing-md) * 2); }
#toc-list .toc-structured.toc-h4 { padding-left: calc(var(--spacing-md) * 3); }
#toc-list .toc-structured.toc-h5 { padding-left: calc(var(--spacing-md) * 4); }
#toc-list .toc-structured.toc-h6 { padding-left: calc(var(--spacing-md) * 5); }

/* å¼ºåŒ–å±‚çº§è§†è§‰æ•ˆæœ */
.toc-structured {
  border-left: none;
  position: relative;
}

.toc-structured.toc-h2 { border-left: 3px solid rgba(0, 102, 204, 0.1); }
.toc-structured.toc-h3 { border-left: 3px solid rgba(0, 102, 204, 0.15); }
.toc-structured.toc-h4 { border-left: 3px solid rgba(0, 102, 204, 0.2); }
.toc-structured.toc-h5,
.toc-structured.toc-h6 { border-left: 3px solid rgba(0, 102, 204, 0.25); }

/* ç®€å•æ•°å­—åˆ—è¡¨é¡¹æ ·å¼ */
.toc-simple-numbered {
  position: relative;
}

.toc-simple-numbered .toc-prefix {
  color: var(--color-primary);
  font-weight: var(--font-weight-bold);
  font-size: 0.9em;
}

#toc-list li.toc-simple-numbered {
  padding-left: var(--spacing-md) !important;
}

.toc-simple-numbered::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  border-left: 2px dotted rgba(37, 99, 235, 0.3);
}

.toc-simple-numbered:hover::before {
  border-left-color: rgba(37, 99, 235, 0.6);
}

/* å¸¦ç©ºæ ¼å¤šçº§ç¼–å·æ ‡é¢˜æ ·å¼ */
.toc-spaced-numeric .toc-prefix {
  font-family: var(--font-family-monospace);
  letter-spacing: 0.5px;
  color: var(--color-primary);
  font-weight: var(--font-weight-bold);
}

.toc-spaced-numeric:hover {
  background-color: rgba(0, 102, 204, 0.05);
}

#toc-list .toc-spaced-numeric {
  padding-left: inherit;
}

/* ==================== 10. å›¾è¡¨æ ‡é¢˜æ ·å¼ ==================== */

/* å›¾è¡¨æ ‡é¢˜åœ¨ TOC ä¸­çš„ç‰¹æ®Šæ ·å¼ */
#toc-list li.toc-caption a::before {
  content: "ğŸ“Š ";
  margin-right: var(--spacing-xs);
  font-size: var(--font-size-sm);
}

#toc-list li.toc-caption a {
  color: var(--color-primary);
  font-style: italic;
}

#toc-list li.toc-caption a:hover {
  background-color: rgba(37, 99, 235, 0.1);
}

/* å›¾è¡¨æ ‡é¢˜ä½œä¸ºå­é¡¹çš„æ ·å¼è°ƒæ•´ */
.toc-caption {
  font-style: italic;
  color: var(--color-text-secondary);
  padding-left: var(--spacing-md) !important;
  position: relative;
}

.toc-caption::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  border-left: 2px dotted rgba(97, 97, 97, 0.2);
}

.toc-structured + li.toc-caption {
  padding-left: calc(var(--spacing-md) * 2) !important;
}

/* å›¾è¡¨å›¾æ ‡æ ·å¼ */
.toc-chart-icon {
  margin-right: var(--spacing-xs);
  font-size: 0.9em;
  opacity: 0.8;
  transition: opacity var(--transition-fast),
              transform var(--transition-fast);
}

.toc-caption:hover .toc-chart-icon {
  opacity: 1;
  transform: scale(1.1);
}

/* å›¾è¡¨æ ‡é¢˜çš„å†…å®¹æ ·å¼ */
.toc-caption .toc-content {
  font-style: italic;
  color: var(--color-primary);
}

.toc-caption .toc-content::first-letter {
  font-weight: inherit;
  color: inherit;
}

/* ==================== 11. æ–‡ä»¶åå ä½ç¬¦æ ·å¼ ==================== */

#toc-list li a[href^="#placeholder-"] {
  font-weight: var(--font-weight-semibold);
  color: var(--color-primary);
  border-left-color: var(--color-primary);
  background-color: rgba(59, 130, 246, 0.1);
  padding-left: var(--toc-item-padding-x);
}

#toc-list li a[href^="#placeholder-"]::before {
  content: "ğŸ“„ ";
  margin-right: var(--spacing-xs);
}

/* ==================== 12. TOC æ§åˆ¶æŒ‰é’®åŒºåŸŸ ==================== */

.toc-controls {
  padding: var(--spacing-sm) var(--spacing-md);
  text-align: center;
  border-top: 1px solid var(--color-border-light);
  font-size: 0.8em;
  color: var(--color-text-muted);
  display: flex;
  justify-content: center;
  align-items: center;
  gap: var(--spacing-sm);
  background: var(--color-bg-secondary);
}

.toc-control-btn {
  background: transparent;
  border: none;
  margin: 0 var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  color: var(--color-primary);
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: background-color var(--transition-fast);
  font-size: var(--font-size-xs);
  user-select: none;
}

.toc-control-btn:hover {
  background-color: rgba(59, 130, 246, 0.1);
}

/* ==================== 13. ç‰¹æ®Šæ•ˆæœ ==================== */

/* ç›®æ ‡é«˜äº®æ•ˆæœï¼ˆè·³è½¬åçš„é«˜äº®ï¼‰ */
.toc-target-highlight {
  background: var(--color-selection-bg) !important;
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.3) !important;
  border-left: 4px solid var(--color-primary) !important;
  transition: all var(--transition-base) !important;
  border-radius: var(--radius-md) !important;
  padding: var(--spacing-md) !important;
}

/* TOC å¼¹çª—æ˜¾ç¤º/éšè—åŠ¨ç”»æ•ˆæœ */
.toc-popup-visible {
  display: block !important;
  opacity: 1 !important;
  transform: translateY(0) !important;
}

.toc-popup-hidden {
  display: none !important;
}

/* å¼ºåŒ–TOCçš„è§†è§‰å±‚çº§ */
#toc-list ul.toc-children {
  margin-left: 0;
  border-left: 1px solid rgba(0, 0, 0, 0.05);
}

/* ==================== 14. å“åº”å¼è®¾è®¡ ==================== */

@media (max-width: 768px) {
  #toc-float-btn {
    left: 15px;
    width: 44px;
    height: 44px;
    font-size: var(--font-size-lg);
  }

  #toc-popup {
    left: 15px;
    width: calc(100vw - 30px);
    max-width: 350px;
  }

  .toc-mode-btn {
    padding: var(--spacing-xs) var(--spacing-md);
    font-size: 0.8rem;
  }

  #toc-list li a {
    padding: 10px 14px 10px 18px;
    margin: 2px 8px;
  }
}

@media (max-width: 480px) {
  #toc-popup {
    width: calc(100vw - 20px);
    left: 10px;
    max-height: 70vh;
  }

  #toc-popup-header {
    padding: var(--spacing-md) var(--spacing-lg) var(--spacing-sm) var(--spacing-lg);
  }

  #toc-popup-header span {
    font-size: 1rem;
  }
}

/* ==================== 15. æ‰“å°æ ·å¼ ==================== */

@media print {
  #toc-float-btn,
  #toc-popup {
    display: none !important;
  }
}
